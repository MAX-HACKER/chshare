<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChargeFranchise - EV Charging Platform</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .section, .vendor-tab-content { display: none; }
        .section.active, .vendor-tab-content.active { display: block; animation: fadeIn 0.8s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-box {
            position: fixed; top: 20px; right: 20px;
            padding: 1rem 2rem; border-radius: 8px; z-index: 3001;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateX(120%); opacity: 0; display: none;
        }
        .message-box.show { transform: translateX(0); opacity: 1; display: flex; }
        .message-box.info { background-color: #3b82f6; color: white; }
        .message-box.success { background-color: #16a34a; color: white; }
        .message-box.error { background-color: #dc2626; color: white; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 3000;
        }
        .vendor-tab.active {
            border-color: #6366f1; /* indigo-500 */
            color: #4f46e5; /* indigo-600 */
            font-weight: 600;
        }
        .sort-btn.active-sort {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        /* Ensure map container has a defined height */
        #live-navigation {
            height: calc(100vh - 150px); /* Full viewport height minus header/padding */
        }
    </style>
</head>

<body class="bg-gray-100 font-sans min-h-screen flex flex-col">
    <!-- Message Box for feedback -->
    <div id="message-box" class="message-box">
        <span id="message-text"></span>
        <button onclick="hideMessage()" class="text-white text-xl ml-4">&times;</button>
    </div>

    <!-- Edit Charger Modal -->
    <div id="edit-charger-modal" class="modal-overlay hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Edit Charger</h2>
            <div id="edit-charger-form" class="space-y-4">
                <input type="hidden" id="edit-charger-id">
                <input type="text" id="edit-charger-name" placeholder="Charger Name" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                <input type="number" id="edit-charger-rate" placeholder="Charging Rate (kW)" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                <select id="edit-charger-status" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <option value="available">Available</option>
                    <option value="in-use">In Use</option>
                    <option value="maintenance">Maintenance</option>
                </select>
                <div class="flex gap-4 pt-4">
                    <button id="update-charger-btn" onclick="updateCharger()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Update Charger</button>
                    <button onclick="closeEditModal()" class="w-full bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors">Cancel</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Authentication Section -->
    <div id="auth-section" class="flex items-center justify-center min-h-screen p-4">
        <!-- Forms are rendered here by JS -->
    </div>

    <!-- Main Application -->
    <div id="app-content" class="flex flex-col flex-grow" style="display: none;">
        <header class="bg-white bg-opacity-10 backdrop-blur-lg p-4 sticky top-0 z-10 shadow-lg">
            <!-- Navigation Bar -->
            <nav class="container mx-auto flex justify-between items-center">
                <div class="logo text-2xl font-bold text-white">⚡ ChargeFranchise</div>
                <ul class="nav-links hidden md:flex items-center gap-4">
                    <!-- User Links -->
                    <li class="user-only-nav"><a href="#" class="text-white font-medium p-2" onclick="showSection('home')">Home</a></li>
                    <li class="user-only-nav"><a href="#" class="text-white font-medium p-2" onclick="showSection('find-chargers')">AI Route Planner</a></li>
                    <li class="user-only-nav"><a href="#" class="text-white font-medium p-2" onclick="showSection('chargers-near-me')">Chargers Near Me</a></li>
                    <li class="user-only-nav"><a href="#" class="text-white font-medium p-2" onclick="showSection('vehicle-reg')">My Vehicles</a></li>
                    <li class="user-only-nav"><a href="#" class="text-white font-medium p-2" onclick="showSection('rent-charger')">Rent My Charger</a></li>
                    <li class="user-only-nav"><a href="#" class="text-white font-medium p-2" onclick="showSection('become-vendor')">Become a Partner</a></li>
                    
                    <!-- Vendor Links -->
                    <li class="vendor-only-nav" style="display: none;"><a href="#" class="text-white font-medium p-2" onclick="showSection('dashboard'); showVendorTab('performance-overview');">Performance Overview</a></li>
                    <li class="vendor-only-nav" style="display: none;"><a href="#" class="text-white font-medium p-2" onclick="showSection('dashboard'); showVendorTab('manage-chargers');">Manage Chargers</a></li>
                    <li class="vendor-only-nav" style="display: none;"><a href="#" class="text-white font-medium p-2" onclick="showSection('dashboard'); showVendorTab('my-vmap');">My VMAP</a></li>
                    <li class="vendor-only-nav" style="display: none;"><a href="#" class="text-white font-medium p-2" onclick="showSection('dashboard'); showVendorTab('vendor-settings');">Settings</a></li>

                    <li id="user-info-container" class="flex items-center gap-4">
                        <span id="user-info" class="text-white"></span>
                        <button onclick="logout()" class="bg-red-500 text-white py-2 px-4 rounded-full font-semibold hover:bg-red-600">Logout</button>
                    </li>
                </ul>
                <button class="text-white text-2xl md:hidden" onclick="toggleMobileMenu()">☰</button>
            </nav>
            <!-- Mobile Menu -->
            <ul id="mobile-menu" class="hidden md:hidden mt-4 space-y-2">
                 <!-- User Links -->
                 <li class="user-only-nav"><a href="#" class="block text-white font-medium p-2" onclick="showSection('home'); toggleMobileMenu();">Home</a></li>
                 <li class="user-only-nav"><a href="#" class="block text-white font-medium p-2" onclick="showSection('find-chargers'); toggleMobileMenu();">AI Route Planner</a></li>
                 <li class="user-only-nav"><a href="#" class="block text-white font-medium p-2" onclick="showSection('chargers-near-me'); toggleMobileMenu();">Chargers Near Me</a></li>
                 <li class="user-only-nav"><a href="#" class="block text-white font-medium p-2" onclick="showSection('vehicle-reg'); toggleMobileMenu();">My Vehicles</a></li>
                 <li class="user-only-nav"><a href="#" class="block text-white font-medium p-2" onclick="showSection('rent-charger'); toggleMobileMenu();">Rent My Charger</a></li>
                 <li class="user-only-nav"><a href="#" class="block text-white font-medium p-2" onclick="showSection('become-vendor'); toggleMobileMenu();">Become a Partner</a></li>

                 <!-- Vendor Links -->
                 <li class="vendor-only-nav" style="display: none;"><a href="#" class="block text-white font-medium p-2" onclick="showSection('dashboard'); showVendorTab('performance-overview'); toggleMobileMenu();">Performance Overview</a></li>
                 <li class="vendor-only-nav" style="display: none;"><a href="#" class="block text-white font-medium p-2" onclick="showSection('dashboard'); showVendorTab('manage-chargers'); toggleMobileMenu();">Manage Chargers</a></li>
                 <li class="vendor-only-nav" style="display: none;"><a href="#" class="block text-white font-medium p-2" onclick="showSection('dashboard'); showVendorTab('my-vmap'); toggleMobileMenu();">My VMAP</a></li>
                 <li class="vendor-only-nav" style="display: none;"><a href="#" class="block text-white font-medium p-2" onclick="showSection('dashboard'); showVendorTab('vendor-settings'); toggleMobileMenu();">Settings</a></li>

                 <li class="pt-2"><button onclick="logout()" class="w-full bg-red-500 text-white py-2 px-4 rounded-full font-semibold hover:bg-red-600">Logout</button></li>
            </ul>
        </header>

        <main class="main-content container mx-auto p-4 flex-grow bg-white rounded-xl shadow-lg mt-4">
            <!-- Home Section -->
            <section id="home" class="section active">
                <div class="bg-indigo-600 text-white p-10 rounded-xl text-center shadow-lg">
                    <h1 class="text-4xl font-bold mb-4">The Future of EV Charging is Collaborative</h1>
                    <p class="text-xl opacity-90">Plan smart routes, manage your vehicles, and join our network of chargers.</p>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
                    <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-indigo-500 transition-all duration-300 hover:shadow-xl">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-2">My Vehicles</h2>
                        <button onclick="showSection('vehicle-reg')" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">Manage Vehicles</button>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-purple-500 transition-all duration-300 hover:shadow-xl">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-2">AI Route Planner</h2>
                        <button onclick="showSection('find-chargers')" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700">Plan Trip</button>
                    </div>
                    <div id="franchise-card" class="bg-white p-6 rounded-lg shadow-md border-t-4 border-yellow-500 transition-all duration-300 hover:shadow-xl" style="display: none;">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-2">Become a Partner</h2>
                        <p class="text-gray-600 mb-4">Earn by setting up your own charging station franchise.</p>
                        <button onclick="showSection('become-vendor')" class="w-full bg-yellow-500 text-white py-3 rounded-lg font-semibold hover:bg-yellow-600">Apply Now</button>
                    </div>
                </div>
            </section>

            <!-- AI Route Planner Section -->
            <section id="find-chargers" class="section">
                 <div class="p-6">
                    <h2 class="text-3xl font-bold mb-4 text-gray-800">AI Route Planner</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 p-6 bg-gray-50 rounded-lg shadow-inner space-y-4" id="route-form">
                            <h3 class="text-xl font-semibold text-gray-700">Plan your journey</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-600">Start Location</label>
                                <div class="flex items-center gap-2">
                                     <input type="text" id="route-start" placeholder="e.g. Mumbai" class="w-full p-3 border rounded-lg form-field">
                                     <button onclick="locateMe('route-start')" class="bg-gray-200 p-2 rounded-lg hover:bg-gray-300 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                                            <circle cx="12" cy="10" r="3" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600">Destination</label>
                                <input type="text" id="route-end" placeholder="e.g. Pune" class="w-full p-3 border rounded-lg form-field">
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-600">Select Your Vehicle</label>
                                <select id="vehicle-select" class="w-full p-3 border rounded-lg form-field"></select>
                            </div>
                            <div>
                                <label for="start-charge" class="block text-sm font-medium text-gray-600">Starting Charge: <span id="start-charge-value">80</span>%</label>
                                <input type="range" id="start-charge" min="0" max="100" value="80" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="end-charge" class="block text-sm font-medium text-gray-600">Desired Charge at Arrival: <span id="end-charge-value">20</span>%</label>
                                <input type="range" id="end-charge" min="0" max="100" value="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="search-radius" class="block text-sm font-medium text-gray-600">Charger Search Radius: <span id="search-radius-value">10</span> km</label>
                                <input type="range" id="search-radius" min="5" max="50" value="10" step="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="nearby-radius" class="block text-sm font-medium text-gray-600">Nearby Places Radius: <span id="nearby-radius-value">1</span> km</label>
                                <input type="range" id="nearby-radius" min="1" max="5" value="1" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <button id="find-route-btn" onclick="calculateOptimalRoute()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Find Optimal Route</button>
                        </div>
                        <div class="lg:col-span-2 space-y-4">
                            <div id="route-details" class="p-4 bg-blue-50 rounded-lg hidden"></div>
                            <div id="map" class="w-full h-[500px] rounded-lg shadow-md"></div>
                             <!-- Nearby Places will be shown here after selecting a charger -->
                            <div id="nearby-places" class="p-4 bg-gray-50 rounded-lg hidden"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Chargers Near Me Section -->
            <section id="chargers-near-me" class="section">
                <div class="p-6">
                    <h2 class="text-3xl font-bold mb-4 text-gray-800">EV Chargers Near Me</h2>
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-gray-600">Find the closest available chargers around your location.</p>
                        <button onclick="locateMe('near-me-map')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                                <circle cx="12" cy="10" r="3" />
                            </svg>
                            Locate Me
                        </button>
                    </div>
                    <div id="chargers-near-me-map" class="w-full h-[600px] rounded-lg shadow-md"></div>
                </div>
            </section>

            <!-- Live Navigation Section -->
            <section id="live-navigation" class="section">
                <div class="p-6 h-full flex flex-col relative">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-bold text-gray-800">Live Navigation</h2>
                        <button onclick="stopInAppNavigation()" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition-colors">Stop Navigation</button>
                    </div>
                    <!-- Info box for selected nearby place -->
                    <div id="selected-place-info" class="absolute top-20 left-1/2 -translate-x-1/2 z-10 bg-white p-3 rounded-lg shadow-lg hidden">
                        <p class="font-bold text-indigo-600">Visiting:</p>
                        <p id="selected-place-text" class="text-sm"></p>
                    </div>
                    <!-- Turn-by-turn directions panel -->
                    <div id="turn-by-turn-directions" class="absolute top-20 left-4 z-10 bg-white p-4 rounded-lg shadow-lg w-full max-w-sm">
                        <!-- Directions will be injected here by JS -->
                    </div>
                    <div id="live-navigation-map" class="w-full rounded-lg shadow-md flex-grow"></div>
                </div>
            </section>


            <!-- My Vehicles Section -->
            <section id="vehicle-reg" class="section">
                 <div class="p-6">
                    <h2 class="text-3xl font-bold mb-4 text-gray-800">My Vehicles</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-6 bg-gray-50 rounded-lg shadow-inner" id="vehicle-form">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">Add a New Vehicle</h3>
                            <div class="space-y-4">
                                <input type="text" id="reg-no" placeholder="Registration No. (e.g. MH01AB1234)" class="w-full p-3 border rounded-lg form-field">
                                <input type="text" id="vehicle-make" placeholder="Make (e.g. Tesla)" class="w-full p-3 border rounded-lg form-field">
                                <input type="text" id="vehicle-model" placeholder="Model (e.g. Model 3)" class="w-full p-3 border rounded-lg form-field">
                                <input type="number" id="battery-capacity" placeholder="Battery Capacity (kWh)" class="w-full p-3 border rounded-lg form-field">
                                <input type="text" id="connector-type" placeholder="Connector Type (e.g. CCS2)" class="w-full p-3 border rounded-lg form-field">
                                <button id="submit-vehicle-btn" onclick="submitVehicle()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">Register Vehicle</button>
                            </div>
                        </div>
                        <div class="p-6 bg-gray-50 rounded-lg shadow-inner custom-scrollbar overflow-y-auto max-h-96">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">My Registered Vehicles</h3>
                            <div id="my-vehicles-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Rent My Charger Section -->
            <section id="rent-charger" class="section">
                <div class="p-6">
                    <h2 class="text-3xl font-bold mb-4 text-gray-800">Rent Your Home Charger</h2>
                    <p class="mb-6 text-gray-600">Earn extra income by listing your personal EV charger for others to use when you're not.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-6 bg-gray-50 rounded-lg shadow-inner" id="home-charger-form">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">List Your Charger</h3>
                            <div class="space-y-4">
                                <input type="text" id="home-charger-name" placeholder="Charger Nickname (e.g. My Home Charger)" class="w-full p-3 border rounded-lg form-field">
                                <input type="number" id="home-charger-rate" placeholder="Charging Rate (kW)" class="w-full p-3 border rounded-lg form-field">
                                <input type="text" id="home-charger-address" placeholder="Your Full Address" class="w-full p-3 border rounded-lg form-field">
                                <input type="text" id="home-charger-type" placeholder="Connector Type" class="w-full p-3 border rounded-lg form-field">
                                <button id="list-charger-btn" onclick="listHomeCharger()" class="w-full bg-teal-600 text-white py-3 rounded-lg font-semibold hover:bg-teal-700">List My Charger</button>
                            </div>
                        </div>
                        <div class="p-6 bg-gray-50 rounded-lg shadow-inner custom-scrollbar overflow-y-auto max-h-96">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">My Listed Chargers</h3>
                            <div id="user-chargers-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>
            </section>

             <!-- Become a Vendor Section -->
            <section id="become-vendor" class="section">
                 <div class="p-6 max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold mb-4 text-gray-800">Become a Vendor Partner</h2>
                    <div id="vendor-application-status"></div>
                </div>
            </section>

            <!-- Vendor Dashboard Section -->
            <section id="dashboard" class="section">
                <div class="p-6">
                    <div class="border-b border-gray-200 mb-4">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <a href="#" onclick="showVendorTab('performance-overview')" class="vendor-tab active border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Performance Overview</a>
                            <a href="#" onclick="showVendorTab('manage-chargers')" class="vendor-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Manage Chargers</a>
                            <a href="#" onclick="showVendorTab('my-vmap')" class="vendor-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">My VMAP</a>
                            <a href="#" onclick="showVendorTab('vendor-settings')" class="vendor-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Settings</a>
                        </nav>
                    </div>

                    <div id="performance-overview" class="vendor-tab-content active">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">Performance Overview</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-6 bg-gray-50 rounded-lg shadow-inner">
                                <h3 class="text-xl font-semibold mb-3 text-gray-700">Monthly Earnings</h3>
                                <canvas id="chargingChart"></canvas>
                            </div>
                            <div class="p-6 bg-gray-50 rounded-lg shadow-inner" id="roi-calculator">
                                <h3 class="text-xl font-semibold mb-3 text-gray-700">Return on Investment (ROI) Calculator</h3>
                                <div class="space-y-4">
                                    <input type="number" id="investment" placeholder="Total Investment (₹)" class="w-full p-3 border rounded-lg">
                                    <input type="number" id="monthly-revenue" placeholder="Avg. Monthly Revenue (₹)" class="w-full p-3 border rounded-lg">
                                    <button onclick="calculateROI()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">Calculate Annual ROI</button>
                                    <div id="roi-result" class="mt-4 p-4 bg-blue-100 rounded-lg hidden"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="manage-chargers" class="vendor-tab-content">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="p-6 bg-gray-50 rounded-lg shadow-inner">
                                <h3 class="text-xl font-semibold mb-3 text-gray-700">My Franchise Chargers</h3>
                                <div id="vendor-chargers-list" class="space-y-3 max-h-[400px] overflow-y-auto custom-scrollbar"></div>
                            </div>
                             <div class="p-6 bg-gray-50 rounded-lg shadow-inner" id="vendor-charger-form">
                                <h3 class="text-xl font-semibold mb-3 text-gray-700">Add a New Franchise Charger</h3>
                                <div class="space-y-4">
                                    <input type="text" id="charger-name" placeholder="Charger Name" class="w-full p-3 border rounded-lg form-field">
                                    <input type="number" id="charger-rate" placeholder="Charging Rate (kW)" class="w-full p-3 border rounded-lg form-field">
                                    <input type="number" id="charger-lat" placeholder="Latitude" class="w-full p-3 border rounded-lg form-field">
                                    <input type="number" id="charger-lng" placeholder="Longitude" class="w-full p-3 border rounded-lg form-field">
                                    <select id="connector-type-select" class="w-full p-3 border rounded-lg form-field">
                                        <option value="">Select Connector Type</option>
                                        <option value="CCS2">CCS2</option>
                                        <option value="CHAdeMO">CHAdeMO</option>
                                        <option value="Type 2 AC">Type 2 AC</option>
                                        <option value="3-pin plug">3-pin plug</option>
                                    </select>
                                    <select id="charger-type-select" class="w-full p-3 border rounded-lg form-field">
                                        <option value="">Select Charger Type</option>
                                        <option value="AC Slow">AC Slow</option>
                                        <option value="AC Fast">AC Fast</option>
                                        <option value="DC Fast">DC Fast Charger</option>
                                    </select>
                                    <button id="add-charger-btn" onclick="addCharger()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">Add Charger</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="my-vmap" class="vendor-tab-content">
                         <h3 class="text-2xl font-bold mb-4 text-gray-800">My Charger Locations</h3>
                        <div id="vendor-map" class="w-full h-[500px] rounded-lg shadow-md"></div>
                    </div>

                    <div id="vendor-settings" class="vendor-tab-content">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">Vendor Settings</h3>
                        <div class="p-6 bg-gray-50 rounded-lg shadow-inner max-w-md mx-auto" id="set-pin-form">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">Set Your Custom PIN</h3>
                            <p class="text-gray-600 mb-4">This PIN will be used for all future logins.</p>
                            <div class="space-y-4">
                                <input type="password" id="new-pin" placeholder="New PIN" class="w-full p-3 border rounded-lg form-field">
                                <input type="password" id="confirm-pin" placeholder="Confirm New PIN" class="w-full p-3 border rounded-lg form-field">
                                <button onclick="setCustomPin()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">Set PIN</button>
                            </div>
                        </div>

                        <div class="p-6 bg-gray-50 rounded-lg shadow-inner max-w-md mx-auto mt-6" id="change-pin-form" style="display:none;">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">Change Your PIN</h3>
                            <div class="space-y-4">
                                <input type="password" id="current-pin" placeholder="Current PIN" class="w-full p-3 border rounded-lg form-field">
                                <input type="password" id="change-new-pin" placeholder="New PIN" class="w-full p-3 border rounded-lg form-field">
                                <input type="password" id="change-confirm-pin" placeholder="Confirm New PIN" class="w-full p-3 border rounded-lg form-field">
                                <button onclick="changeCustomPin()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">Change PIN</button>
                            </div>
                        </div>

                        <div class="p-6 bg-gray-50 rounded-lg shadow-inner max-w-md mx-auto mt-6">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">Open Charge Map API Key</h3>
                            <p class="text-gray-600 mb-4">Enter your Open Charge Map API key for global charger data.</p>
                            <input type="text" id="ocm-api-key" placeholder="Enter API Key" class="w-full p-3 border rounded-lg form-field">
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Main Application Script -->
    <script type="module">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCB2GoSkw4qdFkUmFxNAmIUgGgzFXCZZp8",
            authDomain: "chargeshare-a327a.firebaseapp.com",
            databaseURL: "https://chargeshare-a327a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "chargeshare-a327a",
            storageBucket: "chargeshare-a327a.appspot.com",
            messagingSenderId: "77947942873",
            appId: "1:77947942873:web:b8366adbb41f39b8a8cbc8"
        };
        // Use a placeholder for the Open Charge Map API key, which can be updated in the settings
        let openChargeMapApiKey = "6aa27df2-0e7d-4ce3-9787-5e869d304fd7"; 

        // Firebase Service Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
            signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup,
            signOut, updateProfile, updatePassword, reauthenticateWithCredential, EmailAuthProvider
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, getDoc, addDoc, collection,
            query, onSnapshot, serverTimestamp, deleteDoc, GeoPoint, where, updateDoc, getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, ref, uploadBytes, getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Global App State
        let mainMap, nearMeMap, liveNavigationMap, directionsService, directionsRenderer, chargingChart, geocoder, placesService, vendorMap;
        let allChargers = [];
        let userVehicles = [];
        let chargerMarkers = [];
        let nearMeChargerMarkers = [];
        let vendorChargerMarkers = [];
        let userLocationMarker = null; // This will be the moving blue dot for live navigation
        let nearMeUserMarker = null; // This is the static pin for the "Chargers Near Me" map
        let watchId = null;
        const MASTER_KEY = "25annu30athu";
        let googleMapsLoaded = false;
        let currentRoute = {
            origin: null,
            destination: null,
            currentLocation: null,
            vehicle: null,
            fullDirectionsResult: null,
            navigationDirections: null, // For storing the complete route for navigation
            selectedChargerId: null,
            chargersOnRoute: [],
            selectedPlace: null, // To store info about a nearby place
            currentLegIndex: 0,
            currentStepIndex: 0
        };
        
        // --- All functions are defined here for proper scoping ---
        
        const showMessage = (message, duration = 3000, type = 'info') => {
            const msgBox = document.getElementById('message-box');
            const msgText = document.getElementById('message-text');
            if(!msgBox || !msgText) return;
            msgText.textContent = message;
            msgBox.className = `message-box show ${type}`;
            setTimeout(() => hideMessage(), duration);
        };

        const hideMessage = () => {
            const msgBox = document.getElementById('message-box');
            if(msgBox) msgBox.className = 'message-box';
        };

        const showSection = (sectionId) => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            const sectionElement = document.getElementById(sectionId);
            if (sectionElement) {
                sectionElement.classList.add('active');
            }

            // Trigger map resize for all maps to ensure they render correctly when their section becomes visible
            setTimeout(() => {
                if (mainMap && sectionId === 'find-chargers') {
                    google.maps.event.trigger(mainMap, 'resize');
                }
                if (nearMeMap && sectionId === 'chargers-near-me') {
                    google.maps.event.trigger(nearMeMap, 'resize');
                }
                if (liveNavigationMap && sectionId === 'live-navigation') {
                    google.maps.event.trigger(liveNavigationMap, 'resize');
                }
                if (vendorMap && sectionId === 'dashboard' && document.getElementById('my-vmap').classList.contains('active')) {
                    google.maps.event.trigger(vendorMap, 'resize');
                }
            }, 150);
        };

        const toggleMobileMenu = () => {
            document.getElementById('mobile-menu')?.classList.toggle('hidden');
        };
        
        const renderAuthForms = () => {
            const authSection = document.getElementById('auth-section');
            if(!authSection) return;
            authSection.innerHTML = `
                <div id="portal-choice" class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg text-center">
                    <h1 class="text-3xl font-bold text-indigo-600 mb-4">⚡ ChargeFranchise</h1>
                    <p class="text-gray-600 mb-6">Welcome! Please select your portal.</p>
                    <div class="space-y-4">
                        <button onclick="showLogin('user')" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">User Portal</button>
                        <button onclick="showLogin('vendor')" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">Vendor / Executive Portal</button>
                    </div>
                </div>
                <div id="login-container" class="max-w-md w-full" style="display:none;"></div>
                <div id="signup-container" class="max-w-md w-full" style="display:none;"></div>
            `;
        };

        const showLogin = (role) => {
            document.getElementById('portal-choice').style.display = 'none';
            const container = document.getElementById('login-container');
            container.style.display = 'block';
            let passwordLabel = role === 'user' ? 'Password' : 'Password / Key / Master Key';
            let loginButtonText = role === 'user' ? 'Login' : 'Login / Verify';
            container.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-indigo-600 mb-6 text-center">Login to ${role === 'user' ? 'User' : 'Vendor'} Portal</h2>
                    <div class="space-y-4" id="login-form">
                        <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 border rounded-lg form-field">
                        <input type="password" id="loginPassword" placeholder="${passwordLabel}" class="w-full p-3 border rounded-lg form-field">
                        <button id="login-btn" onclick="login('${role}')" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">${loginButtonText}</button>
                        ${role === 'user' ? `<button onclick="googleLogin()" class="w-full flex items-center justify-center gap-3 bg-white text-gray-700 py-3 rounded-lg border hover:bg-gray-100">
                           <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="h-5"> Sign in with Google
                        </button>` : ''}
                        <div id="loginError" class="text-red-500 text-sm"></div>
                        <p class="text-sm text-gray-500 pt-2">New here? <a href="#" onclick="showSignUp('user')" class="text-indigo-600 hover:underline">Create a user account</a></p>
                        <button onclick="backToPortalChoice()" class="w-full bg-gray-400 text-white py-3 rounded-lg font-semibold hover:bg-gray-500">Back</button>
                    </div>
                </div>
            `;
            setupEnterKeyNavigation();
        };

        const showSignUp = (role) => {
            document.getElementById('portal-choice').style.display = 'none';
            document.getElementById('login-container').style.display = 'none';
            const container = document.getElementById('signup-container');
            container.style.display = 'block';
            container.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-indigo-600 mb-6 text-center">Create a User Account</h2>
                    <p class="text-center text-gray-500 mb-4">Vendor accounts are created after executive verification.</p>
                    <div class="space-y-4" id="signup-form">
                        <input type="email" id="signupEmail" placeholder="Email" class="w-full p-3 border rounded-lg form-field">
                        <input type="password" id="signupPassword" placeholder="Password" class="w-full p-3 border rounded-lg form-field">
                        <input type="text" id="signupName" placeholder="Name" class="w-full p-3 border rounded-lg form-field">
                        <button id="signup-btn" onclick="signUp('user')" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">Create Account</button>
                        <div id="signupError" class="text-red-500 text-sm"></div>
                        <p class="text-sm text-gray-500 pt-2">Already have an account? <a href="#" onclick="showLogin('user')" class="text-indigo-600 hover:underline">Login</a></p>
                        <button onclick="backToPortalChoice()" class="w-full bg-gray-400 text-white py-3 rounded-lg font-semibold hover:bg-gray-500">Back</button>
                    </div>
                </div>
            `;
            setupEnterKeyNavigation();
        };

        const backToPortalChoice = () => {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('signup-container').style.display = 'none';
            document.getElementById('portal-choice').style.display = 'block';
        };
        
        const setupEnterKeyNavigation = () => {
            const formContainers = ['login-form', 'signup-form', 'vehicle-form', 'home-charger-form', 'vendor-charger-form', 'route-form', 'edit-charger-form'];
            formContainers.forEach(formId => {
                const container = document.getElementById(formId);
                if (!container) return;
                const fields = [...container.querySelectorAll('.form-field')];
                const submitButton = container.querySelector('button[id$="-btn"]');
                fields.forEach((field, index) => {
                    field.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const nextField = fields[index + 1];
                            if (nextField) nextField.focus();
                            else if (submitButton) submitButton.click();
                        }
                    });
                });
            });
        };

        const loadUserVehicles = (uid) => {
            const q = query(collection(db, "users", uid, "vehicles"));
            onSnapshot(q, (snapshot) => {
                userVehicles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const vehicleSelect = document.getElementById('vehicle-select');
                const listEl = document.getElementById('my-vehicles-list');
                if (vehicleSelect) {
                    vehicleSelect.innerHTML = '<option value="">Select a vehicle</option>';
                    userVehicles.forEach(v => {
                        const option = document.createElement('option');
                        option.value = v.id;
                        option.textContent = `${v.make} ${v.model} (${v.regNo})`;
                        vehicleSelect.appendChild(option);
                    });
                }
                if (listEl) {
                    listEl.innerHTML = userVehicles.length === 0 ? `<p class="text-gray-500">No vehicles added yet.</p>` : '';
                    userVehicles.forEach(vehicle => {
                        const item = document.createElement('div');
                        item.className = 'bg-white p-4 rounded-lg shadow-sm flex justify-between items-center';
                        item.innerHTML = `<div><p class="font-semibold">${vehicle.make} ${vehicle.model}</p><p class="text-sm text-gray-600">${vehicle.regNo}</p></div>
                                          <button onclick="deleteVehicle('${vehicle.id}')" class="text-red-500 hover:text-red-700 font-semibold">Delete</button>`;
                        listEl.appendChild(item);
                    });
                }
            });
        };

        const updateMapMarkers = (mapInstance, markerArray, markersToShow) => {
            markerArray.forEach(marker => marker.setMap(null));
            markerArray.length = 0;

            const markerData = markersToShow || allChargers;

            markerData.forEach(charger => {
                if (!charger.location) return;
                let iconUrl = 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'; // Blue for available public
                if (charger.type === 'home' || charger.IsPrivate) {
                    iconUrl = 'http://maps.google.com/mapfiles/ms/icons/purple-dot.png'; // Purple for private/home
                } else if (charger.status !== 'available') {
                    iconUrl = 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'; // Red for in-use/maintenance
                }
                const marker = new google.maps.Marker({
                    position: { lat: charger.location.latitude, lng: charger.location.longitude },
                    map: mapInstance, title: charger.name || charger.AddressInfo?.Title,
                    icon: { url: iconUrl, scaledSize: new google.maps.Size(32, 32) }
                });
                const infoWindow = new google.maps.InfoWindow({
                    content: `<div><strong>${charger.name || charger.AddressInfo?.Title || 'N/A'}</strong><br>
                    ${charger.rate || charger.Connections?.[0]?.PowerKW || 'N/A'} kW | ${charger.type || (charger.IsPrivate ? 'Private' : 'Public')}<br>
                    Status: <span class="font-bold ${charger.status === 'available' ? 'text-green-600' : 'text-red-600'}">${charger.status || 'available'}</span></div>`
                });
                marker.addListener('click', () => infoWindow.open(mapInstance, marker));
                markerArray.push(marker);
            });
        };
        
        const displayRouteInfo = (legs, chargers, vehicle, directionsResult) => {
            const routeDetailsEl = document.getElementById('route-details');
            let totalDistance = legs.reduce((sum, leg) => sum + leg.distance.value, 0);
            let totalDuration = legs.reduce((sum, leg) => sum + leg.duration.value, 0);
            let chargingTime = 0;
            chargers.forEach(charger => {
                const energyNeeded = vehicle.batteryCapacity * 0.7; // Assume charging from 10% to 80%
                chargingTime += (energyNeeded / (charger.rate || 11)) * 3600; // Default to 11kW if rate is unknown
            });
            const totalTripTime = totalDuration + chargingTime;
            let html = `<h4 class="font-bold text-lg mb-2">Trip Summary</h4>
                        <p><strong>Total Distance:</strong> ${(totalDistance / 1000).toFixed(1)} km</p>
                        <p><strong>Driving Time:</strong> ${formatDuration(totalDuration)}</p>`;
            if(chargers.length > 0) {
                html += `<p><strong>Est. Charging Time:</strong> ${formatDuration(chargingTime)}</p>
                         <p class="font-bold"><strong>Total Trip Time:</strong> ${formatDuration(totalTripTime)}</p>
                         <h5 class="font-semibold mt-2">Charging Stops:</h5><ul class="list-disc pl-5">`;
                chargers.forEach(c => { html += `<li>${c.name || c.AddressInfo?.Title} (${c.rate || c.Connections?.[0]?.PowerKW || 'N/A'} kW)</li>`; });
                html += `</ul>`;
            }
            html += `<button onclick="startInAppNavigation()" class="mt-4 w-full bg-green-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-600">Start Live Navigation</button>`;
            routeDetailsEl.innerHTML = html;
            routeDetailsEl.classList.remove('hidden');
            addRouteMarkers(directionsResult, chargers);
        };

        const displayChargerOptions = async (chargers, directionsResult, vehicle) => {
            const chargersWithTime = await Promise.all(chargers.map(async (charger) => {
                const chargerLoc = new google.maps.LatLng(charger.location.latitude, charger.location.longitude);
                
                const legToChargerPromise = new Promise((resolve) => {
                    directionsService.route({
                        origin: currentRoute.origin,
                        destination: chargerLoc,
                        travelMode: 'DRIVING'
                    }, (result, status) => {
                        if (status === 'OK') resolve(result.routes[0].legs[0]);
                        else resolve(null);
                    });
                });

                const legFromChargerPromise = new Promise((resolve) => {
                    directionsService.route({
                        origin: chargerLoc,
                        destination: currentRoute.destination,
                        travelMode: 'DRIVING'
                    }, (result, status) => {
                        if (status === 'OK') resolve(result.routes[0].legs[0]);
                        else resolve(null);
                    });
                });

                const [legToCharger, legFromCharger] = await Promise.all([legToChargerPromise, legFromChargerPromise]);

                if (!legToCharger || !legFromCharger) return charger;

                const drivingTimeToCharger = legToCharger.duration.value;
                const drivingTimeFromCharger = legFromCharger.duration.value;
                
                const energyNeeded = vehicle.batteryCapacity * 0.7; // Assuming charge 70% of battery
                const chargingTime = (energyNeeded / (charger.rate || 11)) * 3600;

                const totalTripTime = drivingTimeToCharger + chargingTime + drivingTimeFromCharger;

                return { ...charger, totalTripTime };
            }));

            currentRoute.chargersOnRoute = chargersWithTime;
            
            const routeDetailsEl = document.getElementById('route-details');
            routeDetailsEl.classList.remove('hidden');
            let html = `<div class="p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-r-lg mb-4">
                           <p class="font-bold">Action Required</p>
                           <p>Your vehicle needs to charge to complete this trip. Please select a charging stop from the list below to proceed.</p>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-lg">Reachable Charging Stops</h4>
                            <div id="sort-buttons" class="flex gap-2">
                                <button onclick="sortAndRedisplayChargers('time')" class="sort-btn active-sort text-xs bg-gray-200 text-gray-800 px-3 py-1 rounded-full">Time</button>
                                <button onclick="sortAndRedisplayChargers('speed')" class="sort-btn text-xs bg-gray-200 text-gray-800 px-3 py-1 rounded-full">Speed</button>
                            </div>
                        </div>
                        <div id="charger-options-list" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2">
                        </div>`;
            
            routeDetailsEl.innerHTML = html;
            sortAndRedisplayChargers('time'); // Default sort by total time
            addRouteMarkers(directionsResult, chargers);
        };

        const generateChargerListHTML = (chargers) => {
            let listHtml = '';
            if (chargers.length === 0) {
                return '<p class="text-gray-500">No chargers to display.</p>';
            }
            chargers.forEach(charger => {
                const rate = charger.rate || charger.Connections?.[0]?.PowerKW || 'N/A';
                const status = charger.status || 'available';
                const statusColor = status === 'available' ? 'text-green-600' : 'text-yellow-600';
                const totalTimeText = charger.totalTripTime ? `Total: ${formatDuration(charger.totalTripTime)}` : 'Time N/A';

                listHtml += `
                <div class="bg-white p-3 rounded-lg shadow-sm cursor-pointer hover:bg-gray-100 transition-colors" onclick="recalculateRouteWithStop('${charger.id}')">
                    <p class="font-semibold text-gray-800">${charger.name || charger.AddressInfo?.Title}</p>
                    <div class="flex justify-between items-center text-sm mt-1">
                        <span class="font-bold text-indigo-600">${rate} kW</span>
                        <span class="text-gray-500 text-xs">${totalTimeText}</span>
                        <span class="font-semibold ${statusColor}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                    </div>
                </div>
                `;
            });
            return listHtml;
        }

        const sortAndRedisplayChargers = (sortBy) => {
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active-sort'));
            const activeButton = document.querySelector(`button[onclick="sortAndRedisplayChargers('${sortBy}')"]`);
            if(activeButton) activeButton.classList.add('active-sort');

            let sortedChargers = [...currentRoute.chargersOnRoute];
            if (sortBy === 'speed') {
                sortedChargers.sort((a, b) => (b.rate || 0) - (a.rate || 0));
            } else if (sortBy === 'time') {
                sortedChargers.sort((a, b) => (a.totalTripTime || Infinity) - (b.totalTripTime || Infinity));
            }
            const listContainer = document.getElementById('charger-options-list');
            if (listContainer) {
                listContainer.innerHTML = generateChargerListHTML(sortedChargers);
            }
        };
        
        const addRouteMarkers = (directionsResult, chargers) => {
            chargerMarkers.forEach(marker => marker.setMap(null));
            chargerMarkers = [];

            // Start Marker (Green)
            const startMarker = new google.maps.Marker({
                position: directionsResult.routes[0].legs[0].start_location,
                map: mainMap,
                title: 'Start',
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
                    scaledSize: new google.maps.Size(40, 40)
                }
            });
            chargerMarkers.push(startMarker);

            // End Marker (Red)
            const endMarker = new google.maps.Marker({
                position: currentRoute.destination,
                map: mainMap,
                title: 'Destination',
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                    scaledSize: new google.maps.Size(40, 40)
                }
            });
            chargerMarkers.push(endMarker);

            // Charger Markers
            chargers.forEach(charger => {
                let iconUrl;
                if (charger.id === currentRoute.selectedChargerId) {
                    iconUrl = 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'; // Blue for the selected stop
                } else {
                    iconUrl = 'http://maps.google.com/mapfiles/ms/icons/orange-dot.png'; // Orange for other options
                }
                const stopMarker = new google.maps.Marker({
                    position: { lat: charger.location.latitude, lng: charger.location.longitude },
                    map: mainMap,
                    title: charger.name || charger.AddressInfo?.Title,
                    icon: {
                        url: iconUrl,
                        scaledSize: new google.maps.Size(40, 40)
                    }
                });
                chargerMarkers.push(stopMarker);
            });
        };

        const startInAppNavigation = () => {
            const directionsResult = currentRoute.navigationDirections;
            if (!directionsResult) {
                showMessage("No complete route available to navigate.", 3000, 'error');
                return;
            }

            showSection('live-navigation');
            
            const liveMapElement = document.getElementById('live-navigation-map');
            if (!liveNavigationMap) {
                liveNavigationMap = new google.maps.Map(liveMapElement, {
                    zoom: 15,
                    center: directionsResult.routes[0].legs[0].start_location,
                    mapTypeControl: false,
                    mapTypeId: google.maps.MapTypeId.TERRAIN
                });
            } else {
                liveNavigationMap.setCenter(directionsResult.routes[0].legs[0].start_location);
            }

            // This timeout ensures the map renders correctly after the section is displayed
            setTimeout(() => {
                google.maps.event.trigger(liveNavigationMap, 'resize');
                liveNavigationMap.setCenter(directionsResult.routes[0].legs[0].start_location);
            }, 200);


            const liveDirectionsRenderer = new google.maps.DirectionsRenderer({ map: liveNavigationMap, suppressMarkers: true });
            liveDirectionsRenderer.setDirections(directionsResult);

            // Show selected place info if available
            const placeInfoBox = document.getElementById('selected-place-info');
            if (currentRoute.selectedPlace) {
                document.getElementById('selected-place-text').textContent = `${currentRoute.selectedPlace.name} (${currentRoute.selectedPlace.vicinity})`;
                placeInfoBox.classList.remove('hidden');
            } else {
                placeInfoBox.classList.add('hidden');
            }

            if (navigator.geolocation) {
                if (userLocationMarker) userLocationMarker.setMap(null);
                userLocationMarker = new google.maps.Marker({
                    position: liveNavigationMap.getCenter(),
                    map: liveNavigationMap,
                    title: 'Your Location',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: '#4285F4',
                        fillOpacity: 1,
                        strokeWeight: 2,
                        strokeColor: 'white'
                    }
                });

                if (watchId) navigator.geolocation.clearWatch(watchId);
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        userLocationMarker.setPosition(pos);
                        liveNavigationMap.panTo(pos);
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        showMessage("Failed to get live location. Check your device settings.", 4000, 'error');
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                showMessage("Geolocation is not supported by your browser.", 4000, 'error');
            }
            
            // --- NEW: Initialize turn-by-turn display ---
            currentRoute.currentLegIndex = 0;
            currentRoute.currentStepIndex = 0;
            displayCurrentStep();
        };
        
        // --- NEW: Function to display the current navigation step ---
        const displayCurrentStep = () => {
            const directionsPanel = document.getElementById('turn-by-turn-directions');
            if (!directionsPanel || !currentRoute.navigationDirections) {
                return;
            }

            const route = currentRoute.navigationDirections.routes[0];
            if (!route) {
                directionsPanel.innerHTML = '<p>Route not available.</p>';
                return;
            }

            const leg = route.legs[currentRoute.currentLegIndex];
            const step = leg.steps[currentRoute.currentStepIndex];

            if (!step) {
                directionsPanel.innerHTML = `<div class="text-center p-4"><p class="text-lg font-bold text-green-600">You have arrived at your destination!</p></div>`;
                return;
            }

            let html = `
                <div class="p-2">
                    <p class="text-sm text-gray-500">Next turn in: ${step.distance.text}</p>
                    <div class="text-xl font-bold text-gray-800 my-2">${step.instructions}</div>
                    <p class="text-sm text-gray-600">Remaining distance for this leg: ${leg.distance.text}</p>
                </div>
                <div class="flex justify-between mt-4 border-t pt-2">
                    <button id="prev-step-btn" onclick="previousStep()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">&larr; Previous</button>
                    <button id="next-step-btn" onclick="nextStep()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Next &rarr;</button>
                </div>
            `;
            directionsPanel.innerHTML = html;
            
            // Disable buttons at the start/end of the route
            if (currentRoute.currentLegIndex === 0 && currentRoute.currentStepIndex === 0) {
                document.getElementById('prev-step-btn').disabled = true;
                document.getElementById('prev-step-btn').classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            const lastLegIndex = route.legs.length - 1;
            const lastStepIndex = route.legs[lastLegIndex].steps.length - 1;
            if (currentRoute.currentLegIndex === lastLegIndex && currentRoute.currentStepIndex === lastStepIndex) {
                 document.getElementById('next-step-btn').textContent = 'Finish';
            }
        };

        // --- NEW: Function to go to the next step ---
        const nextStep = () => {
            const route = currentRoute.navigationDirections.routes[0];
            if (!route) return;

            const leg = route.legs[currentRoute.currentLegIndex];
            if (currentRoute.currentStepIndex < leg.steps.length - 1) {
                currentRoute.currentStepIndex++;
            } else if (currentRoute.currentLegIndex < route.legs.length - 1) {
                currentRoute.currentLegIndex++;
                currentRoute.currentStepIndex = 0;
            } else {
                 // Reached the end
                stopInAppNavigation();
                showMessage("You have arrived!", 4000, 'success');
                return;
            }
            displayCurrentStep();
        };

        // --- NEW: Function to go to the previous step ---
        const previousStep = () => {
            const route = currentRoute.navigationDirections.routes[0];
            if (!route) return;

            if (currentRoute.currentStepIndex > 0) {
                currentRoute.currentStepIndex--;
            } else if (currentRoute.currentLegIndex > 0) {
                currentRoute.currentLegIndex--;
                const prevLeg = route.legs[currentRoute.currentLegIndex];
                currentRoute.currentStepIndex = prevLeg.steps.length - 1;
            }
            displayCurrentStep();
        };

        const stopInAppNavigation = () => {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            if (userLocationMarker) {
                userLocationMarker.setMap(null);
                userLocationMarker = null;
            }
            // Reset selected place when navigation stops
            currentRoute.selectedPlace = null;
            document.getElementById('selected-place-info').classList.add('hidden');
            document.getElementById('turn-by-turn-directions').innerHTML = ''; // Clear directions

            showSection('find-chargers'); 
            showMessage("Live navigation stopped.", 3000, 'info');
        };

        const formatDuration = (seconds) => {
            if (isNaN(seconds) || seconds === null) return 'N/A';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return `${h > 0 ? h + 'h ' : ''}${m}m`;
        };

        const signUp = async (role = 'user') => {
             if (role === 'vendor') {
                showMessage("Vendor registration is by executive approval only.", 4000, 'error');
                return;
            }
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const name = document.getElementById('signupName').value;
            const errorElement = document.getElementById('signupError');
            errorElement.textContent = '';
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: name });
                await setDoc(doc(db, 'users', userCredential.user.uid), { name, email, role: 'user', createdAt: serverTimestamp() });
                showMessage('Sign up successful!', 3000, 'success');
            } catch (error) { errorElement.textContent = error.message; }
        };

        const login = async (role) => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorElement = document.getElementById('loginError');
            errorElement.textContent = '';

            if (role === 'vendor' && password === MASTER_KEY) {
                await executiveVerify(email);
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                if (role === 'user') {
                    const userDoc = await getDoc(doc(db, "users", userCredential.user.uid));
                    if (userDoc.exists() && userDoc.data().role === 'user') {
                         showMessage('Login successful!', 3000, 'success');
                    } else {
                        await signOut(auth);
                        errorElement.textContent = `This account is not a registered user.`;
                    }
                } else if (role === 'vendor') {
                    const q = query(collection(db, "vendors"), where("uid", "==", userCredential.user.uid));
                    const vendorSnapshot = await getDocs(q);
                     if (!vendorSnapshot.empty) {
                         showMessage('Vendor login successful!', 3000, 'success');
                     } else {
                        await signOut(auth);
                        errorElement.textContent = `This account is not a registered vendor.`;
                     }
                }
            } catch (error) { errorElement.textContent = error.message; }
        };

        const executiveVerify = async (vendorEmail) => {
            try {
                const q = query(collection(db, "vendor_requests"), where("email", "==", vendorEmail), where("status", "==", "pending"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showMessage("No pending vendor request found for this email.", 4000, 'error');
                    return;
                }

                const requestDoc = querySnapshot.docs[0];
                const vendorName = requestDoc.data().name;
                const tempKey = 'TEMP' + Math.random().toString(36).substr(2, 8).toUpperCase();

                const userCredential = await createUserWithEmailAndPassword(auth, email, tempKey);
                const vendorUid = userCredential.user.uid;
                await updateProfile(userCredential.user, { displayName: vendorName });

                const vendorDocName = `${vendorName.replace(/[^\w\s]/gi, '').replace(/\s+/g, '_')}_key`;
                await setDoc(doc(db, "vendors", vendorDocName), {
                    uid: vendorUid,
                    email: vendorEmail,
                    name: vendorName,
                    hasSetPin: false,
                    createdAt: serverTimestamp()
                });

                await updateDoc(requestDoc.ref, { status: "approved" });

                showMessage(`Vendor ${vendorEmail} approved. Temporary key: ${tempKey}`, 10000, 'success');
                await signOut(auth);
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                     showMessage("This email is already registered as a user. To proceed, you must first delete this user from the Firebase Authentication tab, then the executive can approve them.", 8000, 'error');
                } else {
                    showMessage(`Verification failed: ${error.message}`, 5000, 'error');
                }
            }
        };

        const googleLogin = async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (!userDocSnap.exists()) {
                     await setDoc(userDocRef, { name: user.displayName, email: user.email, role: 'user', createdAt: serverTimestamp() });
                }
                showMessage('Logged in with Google!', 3000, 'success');
            } catch (error) { showMessage(`Google login failed: ${error.message}`, 5000, 'error'); }
        };

        const submitVehicle = async () => {
            const regNo = document.getElementById('reg-no').value.toUpperCase();
            const make = document.getElementById('vehicle-make').value;
            const model = document.getElementById('vehicle-model').value;
            const batteryCapacity = parseFloat(document.getElementById('battery-capacity').value);
            const connectorType = document.getElementById('connector-type').value;
            const rtoRegex = /^[A-Z]{2}[0-9]{1,2}[A-Z]{1,2}[0-9]{1,4}$/;
            if (!rtoRegex.test(regNo)) {
                showMessage('Invalid Registration Number format.', 3000, 'error'); return;
            }
            if (!make || !model || isNaN(batteryCapacity) || !connectorType) {
                showMessage('Please fill all vehicle fields.', 3000, 'error'); return;
            }
            try {
                const user = auth.currentUser;
                if (!user) throw new Error("User not logged in.");
                await addDoc(collection(db, "users", user.uid, "vehicles"), { regNo, make, model, batteryCapacity, connectorType });
                showMessage('Vehicle added successfully!', 3000, 'success');
                document.getElementById('vehicle-form').reset();
            } catch (error) { showMessage(`Error: ${error.message}`, 4000, 'error'); }
        };

        const deleteVehicle = async (vehicleId) => {
            if (!confirm("Delete this vehicle?")) return;
            try {
                const user = auth.currentUser;
                if (!user) throw new Error("User not logged in.");
                await deleteDoc(doc(db, "users", user.uid, "vehicles", vehicleId));
                showMessage('Vehicle deleted.', 3000, 'success');
            } catch (error) { showMessage(`Error: ${error.message}`, 4000, 'error'); }
        };
        
        const addCharger = async (isHomeCharger = false) => {
            const user = auth.currentUser;
            if (!user) { showMessage("You must be logged in.", 3000, 'error'); return; }
            let name, rate, connectorType, chargerType, location, address;

            if (isHomeCharger) {
                name = document.getElementById('home-charger-name').value;
                rate = parseFloat(document.getElementById('home-charger-rate').value);
                connectorType = document.getElementById('home-charger-type').value;
                address = document.getElementById('home-charger-address').value;
                if (!name || isNaN(rate) || !connectorType || !address) {
                    showMessage('Please fill all home charger fields.', 3000, 'error'); return;
                }
                try {
                    const results = await new Promise((resolve, reject) => {
                        geocoder.geocode({ address }, (results, status) => {
                            if (status === 'OK') resolve(results);
                            else reject(new Error('Geocode failed: ' + status));
                        });
                    });
                    location = new GeoPoint(results[0].geometry.location.lat(), results[0].geometry.location.lng());
                    
                    await addDoc(collection(db, "chargers"), {
                        vendorId: user.uid, name, rate, location, connectorType,
                        status: 'available', type: 'home', createdAt: serverTimestamp()
                    });
                    showMessage('Charger added successfully!', 3000, 'success');
                    document.getElementById('home-charger-form').reset();
                    showSection('find-chargers');
                    setTimeout(() => {
                        if (mainMap) {
                           mainMap.setCenter({ lat: location.latitude, lng: location.longitude });
                           mainMap.setZoom(15);
                        }
                        showMessage("Your charger is now pinned on the map!", 4000, 'info');
                    }, 200);

                } catch (error) { showMessage(`Could not add charger. ${error.message}`, 5000, 'error'); return; }

            } else {
                name = document.getElementById('charger-name').value;
                rate = parseFloat(document.getElementById('charger-rate').value);
                connectorType = document.getElementById('connector-type-select').value;
                chargerType = document.getElementById('charger-type-select').value;
                const lat = parseFloat(document.getElementById('charger-lat').value);
                const lng = parseFloat(document.getElementById('charger-lng').value);
                if (!name || isNaN(rate) || !connectorType || !chargerType || isNaN(lat) || isNaN(lng)) {
                    showMessage('Please fill all franchise charger fields.', 3000, 'error'); return;
                }
                location = new GeoPoint(lat, lng);
                try {
                    await addDoc(collection(db, "chargers"), {
                        vendorId: user.uid, name, rate, location, connectorType, chargerType,
                        status: 'available', type: 'franchise', createdAt: serverTimestamp()
                    });
                    showMessage('Charger added successfully!', 3000, 'success');
                    document.getElementById('vendor-charger-form').reset();
                } catch (error) {
                     showMessage(`Error adding charger: ${error.message}`, 4000, 'error');
                }
            }
        };

        const listHomeCharger = () => addCharger(true);

        const deleteCharger = async (chargerId) => {
            if (!confirm("Are you sure you want to delete this charger? This action cannot be undone.")) return;
            try {
                await deleteDoc(doc(db, "chargers", chargerId));
                showMessage('Charger deleted successfully.', 3000, 'success');
            } catch (error) { showMessage(`Error deleting charger: ${error.message}`, 4000, 'error'); }
        };
        
        const setupVendorDashboard = async (uid) => {
            const chargersList = document.getElementById('vendor-chargers-list');
            const q = query(collection(db, "chargers"), where("vendorId", "==", uid), where("type", "==", "franchise"));
            
            onSnapshot(q, (snapshot) => {
                const vendorChargers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (chargersList) {
                    chargersList.innerHTML = vendorChargers.length === 0 ? `<p class="text-gray-500">No franchise chargers added yet.</p>` : '';
                    vendorChargers.forEach(charger => {
                        const item = document.createElement('div');
                        item.className = 'bg-white p-4 rounded-lg shadow-sm flex justify-between items-center';
                        item.innerHTML = `<div>
                                            <p class="font-semibold">${charger.name}</p>
                                            <p class="text-sm text-gray-600">${charger.rate} kW | ${charger.connectorType || 'N/A'} | ${charger.chargerType || 'N/A'} | <span class="font-bold ${charger.status === 'available' ? 'text-green-600' : 'text-red-600'}">${charger.status}</span></p>
                                          </div>
                                          <div class="flex gap-2 flex-wrap">
                                            <button onclick="openEditModal('${charger.id}', '${charger.name}', ${charger.rate}, '${charger.status}')" class="text-blue-500 hover:text-blue-700 font-semibold text-sm">Edit</button>
                                            <button onclick="locateChargerOnMap(${charger.location.latitude}, ${charger.location.longitude})" class="text-purple-500 hover:text-purple-700 font-semibold text-sm">Locate</button>
                                            <button onclick="deleteCharger('${charger.id}')" class="text-red-500 hover:text-red-700 font-semibold text-sm">Delete</button>
                                          </div>`;
                        chargersList.appendChild(item);
                    });
                }

                if (vendorMap) {
                    vendorChargerMarkers.forEach(marker => marker.setMap(null));
                    vendorChargerMarkers = [];
                    const bounds = new google.maps.LatLngBounds();
                    vendorChargers.forEach(charger => {
                        if (!charger.location) return;
                        const pos = { lat: charger.location.latitude, lng: charger.location.longitude };
                        const marker = new google.maps.Marker({
                            position: pos,
                            map: vendorMap,
                            title: charger.name
                        });
                        vendorChargerMarkers.push(marker);
                        bounds.extend(pos);
                    });
                    if (!snapshot.empty) {
                        vendorMap.fitBounds(bounds);
                    }
                }
            });

            const ctx = document.getElementById('chargingChart')?.getContext('2d');
            if (ctx) {
                if(chargingChart) chargingChart.destroy();
                chargingChart = new Chart(ctx, { 
                    type: 'line', 
                    data: { 
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], 
                        datasets: [{ 
                            label: 'Earnings (₹)', 
                            data: [6500, 7200, 8100, 7800, 9000, 9500], 
                            borderColor: '#4f46e5', 
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.4 
                        }] 
                    } 
                });
            }

            const vendorQuery = query(collection(db, "vendors"), where("uid", "==", uid));
            const vendorSnapshot = await getDocs(vendorQuery);
            if (!vendorSnapshot.empty) {
                const vendorData = vendorSnapshot.docs[0].data();
                if (vendorData.hasSetPin) {
                    document.getElementById('set-pin-form').style.display = 'none';
                    document.getElementById('change-pin-form').style.display = 'block';
                } else {
                    document.getElementById('set-pin-form').style.display = 'block';
                    document.getElementById('change-pin-form').style.display = 'none';
                    showMessage("Welcome! Please set your custom PIN for future logins.", 5000, 'info');
                    showSection('dashboard');
                    showVendorTab('vendor-settings');
                }
            }
        };

        const fetchOpenChargeMapData = async (bounds) => {
            if (!openChargeMapApiKey) {
                console.warn("Open Charge Map API key is not set. Skipping API call.");
                return [];
            }
            if (!bounds) return [];

            const sw = bounds.getSouthWest();
            const ne = bounds.getNorthEast();
            const centerLat = (sw.lat() + ne.lat()) / 2;
            const centerLng = (sw.lng() + ne.lng()) / 2;
            
            const url = `https://api.openchargemap.io/v3/poi/?output=json&latitude=${centerLat}&longitude=${centerLng}&distance=50&distanceunit=KM&maxresults=200&key=${openChargeMapApiKey}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Open Charge Map API error: ${response.statusText}`);
                }
                const data = await response.json();
                return data.map(item => ({
                    id: `ocm-${item.ID}`,
                    name: item.AddressInfo.Title,
                    AddressInfo: item.AddressInfo,
                    Connections: item.Connections,
                    IsPrivate: item.IsPrivate,
                    location: {
                        latitude: item.AddressInfo.Latitude,
                        longitude: item.AddressInfo.Longitude
                    },
                    rate: item.Connections?.[0]?.PowerKW,
                    status: 'available',
                    type: 'ocm'
                })).filter(c => c.location.latitude && c.location.longitude);
            } catch (error) {
                console.error("Error fetching Open Charge Map data:", error);
                showMessage("Failed to load global charger data.", 5000, 'error');
                return [];
            }
        };

        const updateAllChargers = async (mapBounds) => {
            const q = query(collection(db, "chargers"));
            const localChargersSnapshot = await getDocs(q);
            const localChargers = localChargersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), type: doc.data().type }));
            
            const ocmChargers = await fetchOpenChargeMapData(mapBounds);

            const mergedChargers = [...ocmChargers, ...localChargers];
            const uniqueChargerIds = new Set();
            allChargers = mergedChargers.filter(charger => {
                const isDuplicate = uniqueChargerIds.has(charger.id);
                uniqueChargerIds.add(charger.id);
                return !isDuplicate;
            });

            if (mainMap) updateMapMarkers(mainMap, chargerMarkers);
            if (nearMeMap) updateMapMarkers(nearMeMap, nearMeChargerMarkers);
            if (vendorMap) updateVendorMapMarkers();
        }
        
        const listenForUserChargers = (uid) => {
            const q = query(collection(db, "chargers"), where("vendorId", "==", uid), where("type", "==", "home"));
            onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('user-chargers-list');
                if (!listEl) return;
                listEl.innerHTML = snapshot.empty ? `<p class="text-gray-500">No home chargers listed yet.</p>` : '';
                snapshot.forEach(doc => {
                    const charger = doc.data();
                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-lg shadow-sm flex justify-between items-center';
                    item.innerHTML = `<div><p class="font-semibold">${charger.name}</p><p class="text-sm text-gray-600">${charger.rate} kW | ${charger.status}</p></div>
                                        <button onclick="deleteCharger('${doc.id}')" class="text-red-500 hover:text-red-700 font-semibold">Delete</button>`;
                    listEl.appendChild(item);
                });
            });
        };
        
        const calculateOptimalRoute = async () => {
            if (!mainMap) {
                showMessage("Map is still loading. Please try again in a moment.", 3000, 'info');
                return;
            }
            const start = document.getElementById('route-start').value;
            const end = document.getElementById('route-end').value;
            const vehicleId = document.getElementById('vehicle-select').value;
            const startCharge = parseInt(document.getElementById('start-charge').value, 10);
            const endCharge = parseInt(document.getElementById('end-charge').value, 10);
            const routeDetailsEl = document.getElementById('route-details');
            if (!start || !end || !vehicleId) {
                showMessage("Please fill all fields.", 3000, 'error'); return;
            }
            const selectedVehicle = userVehicles.find(v => v.id === vehicleId);
            if (!selectedVehicle) {
                showMessage("Vehicle not found.", 3000, 'error'); return;
            }
            showMessage("Calculating optimal route...", 5000, 'info');
            routeDetailsEl.innerHTML = `<div class="text-center"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div><p>Analyzing route...</p></div>`;
            routeDetailsEl.classList.remove('hidden');

            try {
                const geocodeStartPromise = new Promise((resolve, reject) => {
                    geocoder.geocode({ address: start }, (results, status) => {
                        if (status === 'OK' && results.length > 0) resolve(results[0].geometry.location);
                        else reject(`Could not find start location: ${status}`);
                    });
                });

                const geocodeEndPromise = new Promise((resolve, reject) => {
                    geocoder.geocode({ address: end }, (results, status) => {
                        if (status === 'OK' && results.length > 0) resolve(results[0].geometry.location);
                        else reject(`Could not find end location: ${status}`);
                    });
                });

                const [startLocation, endLocation] = await Promise.all([geocodeStartPromise, geocodeEndPromise]);

                currentRoute.origin = startLocation;
                currentRoute.destination = endLocation;
                currentRoute.currentLocation = startLocation;
                currentRoute.vehicle = selectedVehicle;
                
                planNextLeg();

            } catch (error) {
                showMessage(`Error: ${error}`, 4000, 'error');
                routeDetailsEl.classList.add('hidden');
            }
        };

        const planNextLeg = async () => {
            const { currentLocation, destination, vehicle } = currentRoute;

            const request = {
                origin: currentLocation,
                destination: destination,
                travelMode: 'DRIVING'
            };

            directionsService.route(request, async (result, status) => {
                if (status === 'OK') {
                    currentRoute.fullDirectionsResult = result;
                    currentRoute.navigationDirections = result; // Store initial full route
                    directionsRenderer.setDirections(result);
                    const route = result.routes[0];
                    const leg = route.legs[0];
                    const distanceToCover = leg.distance.value / 1000;
                    
                    const AVERAGE_EFFICIENCY_KWH_PER_KM = 0.18;
                    const totalRangeKm = vehicle.batteryCapacity / AVERAGE_EFFICIENCY_KWH_PER_KM;
                    const currentCharge = parseInt(document.getElementById('start-charge').value, 10);
                    const currentRangeKm = totalRangeKm * (currentCharge / 100);
                    const requiredEndRangeKm = totalRangeKm * (parseInt(document.getElementById('end-charge').value, 10) / 100);
                    
                    if (currentRangeKm >= distanceToCover + requiredEndRangeKm) {
                        displayRouteInfo([leg], [], vehicle, result);
                        showMessage("Destination reachable without charging!", 4000, 'success');
                        return;
                    }
                    
                    const safetyBufferKm = totalRangeKm * 0.10; // 10% safety buffer
                    const maxSafeTravelDistance = currentRangeKm - safetyBufferKm;
                    const searchRadiusKm = parseInt(document.getElementById('search-radius').value, 10) * 1000; // in meters

                    const chargersOnRoute = allChargers.filter(c => {
                        if (!c.location || c.status !== 'available' || (c.type === 'home' && !c.IsPrivate)) {
                            return false;
                        }
                        const chargerLoc = new google.maps.LatLng(c.location.latitude, c.location.longitude);

                        const distanceToCharger = google.maps.geometry.spherical.computeDistanceBetween(currentLocation, chargerLoc) / 1000;
                        if (distanceToCharger > maxSafeTravelDistance) {
                            return false; 
                        }

                        for (let i = 0; i < route.overview_path.length; i++) {
                            const pathPoint = route.overview_path[i];
                            const distance = google.maps.geometry.spherical.computeDistanceBetween(chargerLoc, pathPoint);
                            if (distance <= searchRadiusKm) { 
                                return true;
                            }
                        }
                        return false;
                    });
                    
                    if (chargersOnRoute.length > 0) {
                        await displayChargerOptions(chargersOnRoute, result, vehicle);
                        showMessage(`${chargersOnRoute.length} safely reachable chargers found near your route.`, 6000, 'info');
                    } else {
                        showMessage("No safely reachable chargers found in our network within your selected radius.", 5000, 'error');
                        addRouteMarkers(result, []);
                    }
                } else {
                    showMessage(`Route calculation failed: ${status}`, 4000, 'error');
                }
            });
        };

        const recalculateRouteWithStop = (chargerId) => {
            const selectedCharger = allChargers.find(c => c.id === chargerId);
            if (!selectedCharger) {
                showMessage("Selected charger not found.", 3000, 'error');
                return;
            }
            
            const start = currentRoute.origin;
            const chargerLocation = new google.maps.LatLng(selectedCharger.location.latitude, selectedCharger.location.longitude);
            
            const request = { 
                origin: start, 
                destination: currentRoute.destination,
                waypoints: [{ location: chargerLocation, stopover: true }],
                travelMode: 'DRIVING',
            };
            
            directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    currentRoute.navigationDirections = result; // This is the full, final route for navigation
                    currentRoute.fullDirectionsResult = result; // This will be displayed on the map
                    currentRoute.currentLocation = chargerLocation;
                    currentRoute.selectedChargerId = chargerId;
                    
                    directionsRenderer.setDirections(result);
                    displayRouteInfo(result.routes[0].legs, [selectedCharger], currentRoute.vehicle, result);
                    
                    // Call findNearbyPlaces for the selected charger's location
                    findNearbyPlaces({latitude: selectedCharger.location.latitude, longitude: selectedCharger.location.longitude});
                    showMessage(`Route updated to stop at ${selectedCharger.name || selectedCharger.AddressInfo?.Title}!`, 4000, 'success');

                } else {
                    showMessage(`Failed to recalculate route with stop: ${status}`, 4000, 'error');
                }
            });
        };
        
        const checkVendorApplicationStatus = async (uid) => {
            const statusContainer = document.getElementById('vendor-application-status');
            const q = query(collection(db, "vendor_requests"), where("userId", "==", uid));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const appData = querySnapshot.docs[0].data();
                 if (appData.status === 'pending') {
                    statusContainer.innerHTML = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                        <p class="font-bold">Verification Pending</p>
                        <p>Your application to become a vendor is currently under review by an executive.</p>
                    </div>`;
                } else if (appData.status === 'approved') {
                     statusContainer.innerHTML = `<div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4" role="alert">
                        <p class="font-bold">Application Approved!</p>
                        <p>Congratulations! Please check your email for your temporary key and log in through the Vendor Portal.</p>
                    </div>`;
                }
            } else {
                statusContainer.innerHTML = `
                    <p class="mb-6 text-gray-600">To become a vendor, please submit a request for verification.</p>
                    <div class="space-y-4" id="vendor-application-form">
                        <input type="text" id="vendor-name" placeholder="Your Full Name or Business Name" class="w-full p-3 border rounded-lg form-field">
                        <button onclick="submitVendorApplication()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">Submit Request</button>
                    </div>
                `;
            }
        };

        const submitVendorApplication = async () => {
            const user = auth.currentUser;
            if (!user) { showMessage("You must be logged in.", 3000, 'error'); return; }

            const vendorName = document.getElementById('vendor-name').value;
            if (!vendorName) {
                showMessage("Please enter your name or business name.", 3000, 'error');
                return;
            }

            try {
                await addDoc(collection(db, "vendor_requests"), {
                    userId: user.uid,
                    email: user.email,
                    name: vendorName,
                    status: 'pending',
                    submittedAt: serverTimestamp()
                });

                showMessage("Request submitted successfully! Your request is under review.", 5000, 'success');
                checkVendorApplicationStatus(user.uid);
            } catch (error) {
                showMessage(`Request failed: ${error.message}`, 5000, 'error');
            }
        };
        
        const findNearbyPlaces = (location) => {
            const nearbyPlacesContainer = document.getElementById('nearby-places');
            nearbyPlacesContainer.innerHTML = ''; // Clear previous results
            
            const nearbyRadiusValue = document.getElementById('nearby-radius').value;
            const radiusInMeters = nearbyRadiusValue * 1000;

            const placeTypes = {
                'Restaurants': 'restaurant',
                'Cafes': 'cafe',
                'Hotels': 'lodging',
                'Attractions': 'tourist_attraction'
            };

            let contentFound = false;

            Object.entries(placeTypes).forEach(([title, type]) => {
                const request = {
                    location: new google.maps.LatLng(location.latitude, location.longitude),
                    radius: radiusInMeters.toString(), // Use the dynamic radius
                    type: [type]
                };
                placesService.nearbySearch(request, (results, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
                        contentFound = true;
                        let html = `<h4 class="font-bold text-lg mt-4 mb-2">${title} Nearby</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-2">`;
                        results.slice(0, 4).forEach(place => {
                            // Use JSON.stringify to safely pass the place details as a string
                            const placeName = place.name.replace(/'/g, "\\'");
                            const placeVicinity = place.vicinity.replace(/'/g, "\\'");
                            html += `<div class="bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-indigo-50" onclick="selectNearbyPlace('${placeName}', '${placeVicinity}')">
                                <p class="font-semibold text-sm">${place.name}</p>
                                <p class="text-xs text-gray-500">${place.vicinity}</p>
                            </div>`;
                        });
                        html += `</div>`;
                        nearbyPlacesContainer.innerHTML += html;
                    }
                });
            });

            // Only show the container if we expect content to be added
            setTimeout(() => {
                if(contentFound) {
                    nearbyPlacesContainer.classList.remove('hidden');
                } else {
                    nearbyPlacesContainer.innerHTML = `<p class="text-gray-600">No popular places found within ${nearbyRadiusValue}km of the charger.</p>`;
                    nearbyPlacesContainer.classList.remove('hidden');
                }
            }, 1500); // Wait for API calls to return
        };

        const selectNearbyPlace = (name, vicinity) => {
            currentRoute.selectedPlace = { name, vicinity };
            showMessage(`'${name}' selected for your stop. This will be shown during live navigation.`, 4000, 'success');
        };

        const locateMe = (mapId) => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    let targetMap;
                    let targetInput;
                    if (mapId === 'route-start') {
                        targetMap = mainMap;
                        targetInput = document.getElementById('route-start');
                    } else if (mapId === 'near-me-map') {
                        targetMap = nearMeMap;
                        
                        // Add/update marker for user's location
                        if (nearMeUserMarker) {
                            nearMeUserMarker.setMap(null); // Remove old marker if it exists
                        }
                        nearMeUserMarker = new google.maps.Marker({
                            position: pos,
                            map: targetMap,
                            title: 'Your Location',
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 8,
                                fillColor: '#4285F4', // A distinct blue color
                                fillOpacity: 1,
                                strokeWeight: 2,
                                strokeColor: 'white'
                            }
                        });
                    }

                    if (targetMap) {
                        targetMap.setCenter(pos);
                        targetMap.setZoom(12);
                    }

                    if (targetInput) {
                        geocoder.geocode({ location: pos }, (results, status) => {
                            if (status === 'OK' && results[0]) {
                                targetInput.value = results[0].formatted_address;
                            } else {
                                showMessage("Could not determine address from your location.", 3000, 'error');
                            }
                        });
                    }
                }, () => {
                    showMessage("Geolocation failed. Please enable location services.", 4000, 'error');
                });
            } else {
                showMessage("Your browser does not support geolocation.", 4000, 'error');
            }
        };

        const initUserMap = () => {
             if (mainMap) return;
             const defaultLocation = { lat: 19.0760, lng: 72.8777 }; // Mumbai
             mainMap = new google.maps.Map(document.getElementById("map"), {
                 zoom: 10,
                 center: defaultLocation,
                 mapTypeControl: false,
                 mapTypeId: google.maps.MapTypeId.TERRAIN
             });
             directionsService = new google.maps.DirectionsService();
             directionsRenderer = new google.maps.DirectionsRenderer({ map: mainMap, suppressMarkers: true });
             geocoder = new google.maps.Geocoder();
             placesService = new google.maps.places.PlacesService(mainMap);
             const startInput = document.getElementById('route-start');
             const endInput = document.getElementById('route-end');
             if (startInput) new google.maps.places.Autocomplete(startInput);
             if (endInput) new google.maps.places.Autocomplete(endInput);
             document.getElementById('start-charge').addEventListener('input', (e) => { document.getElementById('start-charge-value').textContent = e.target.value; });
             document.getElementById('end-charge').addEventListener('input', (e) => { document.getElementById('end-charge-value').textContent = e.target.value; });
             document.getElementById('search-radius').addEventListener('input', (e) => { document.getElementById('search-radius-value').textContent = e.target.value; });
             document.getElementById('nearby-radius').addEventListener('input', (e) => { document.getElementById('nearby-radius-value').textContent = e.target.value; });
             setupEnterKeyNavigation();

             mainMap.addListener('idle', () => updateAllChargers(mainMap.getBounds()));
             updateAllChargers(mainMap.getBounds());
             console.log("User Map Initialized");
        };

        const initChargersNearMeMap = () => {
            if (nearMeMap) return;
            const defaultLocation = { lat: 19.0760, lng: 72.8777 }; // Mumbai
            nearMeMap = new google.maps.Map(document.getElementById("chargers-near-me-map"), {
                 zoom: 10,
                 center: defaultLocation,
                 mapTypeControl: false,
                 mapTypeId: google.maps.MapTypeId.TERRAIN
            });
            nearMeMap.addListener('idle', () => updateAllChargers(nearMeMap.getBounds()));
            updateAllChargers(nearMeMap.getBounds());
            console.log("Chargers Near Me Map Initialized");
        };

        const initVendorMap = () => {
            if (vendorMap || !document.getElementById('vendor-map')) return;
            const defaultLocation = { lat: 19.0760, lng: 72.8777 }; // Mumbai
            vendorMap = new google.maps.Map(document.getElementById("vendor-map"), {
                zoom: 5,
                center: defaultLocation,
                mapTypeControl: false,
            });
            updateVendorMapMarkers();
            console.log("Vendor Map Initialized");
        };

        const updateVendorMapMarkers = () => {
            vendorChargerMarkers.forEach(marker => marker.setMap(null));
            vendorChargerMarkers = [];
            const bounds = new google.maps.LatLngBounds();
            allChargers.filter(c => c.type === 'franchise').forEach(charger => {
                if (!charger.location) return;
                const pos = { lat: charger.location.latitude, lng: charger.location.longitude };
                const marker = new google.maps.Marker({
                    position: pos,
                    map: vendorMap,
                    title: charger.name
                });
                vendorChargerMarkers.push(marker);
                bounds.extend(pos);
            });
             if (vendorChargerMarkers.length > 0) {
                 vendorMap.fitBounds(bounds);
             }
        };

        const showVendorTab = (tabId) => {
            document.querySelectorAll('.vendor-tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.vendor-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId)?.classList.add('active');
            document.querySelector(`.vendor-tab[onclick*="'${tabId}'"]`)?.classList.add('active');
            if (tabId === 'my-vmap') {
                if (!vendorMap) {
                    initVendorMap(allChargers);
                }
                setTimeout(() => {
                    const center = vendorMap.getCenter();
                    google.maps.event.trigger(vendorMap, 'resize');
                    if (center) vendorMap.setCenter(center);
                }, 100);
            }
        };

        const calculateROI = () => {
            const investment = parseFloat(document.getElementById('investment').value);
            const monthlyRevenue = parseFloat(document.getElementById('monthly-revenue').value);
            const resultDiv = document.getElementById('roi-result');
            if (isNaN(investment) || isNaN(monthlyRevenue) || investment <= 0) {
                showMessage("Please enter valid investment and revenue values.", 3000, 'error');
                return;
            }
            const annualRevenue = monthlyRevenue * 12;
            const profit = annualRevenue - investment;
            const roi = (profit / investment) * 100;
            resultDiv.innerHTML = `
                <p><strong>Annual Revenue:</strong> ₹${annualRevenue.toLocaleString('en-IN')}</p>
                <p><strong>Annual Profit:</strong> ₹${profit.toLocaleString('en-IN')}</p>
                <p class="text-2xl font-bold mt-2">Annual ROI: <span class="${roi >= 0 ? 'text-green-600' : 'text-red-600'}">${roi.toFixed(2)}%</span></p>
            `;
            resultDiv.classList.remove('hidden');
        };

        const locateChargerOnMap = (lat, lng) => {
            showVendorTab('my-vmap');
            if (vendorMap) {
                vendorMap.setCenter({ lat, lng });
                vendorMap.setZoom(15);
            }
        };

        const openEditModal = (id, name, rate, status) => {
            document.getElementById('edit-charger-id').value = id;
            document.getElementById('edit-charger-name').value = name;
            document.getElementById('edit-charger-rate').value = rate;
            document.getElementById('edit-charger-status').value = status;
            document.getElementById('edit-charger-modal').classList.remove('hidden');
        };

        const closeEditModal = () => {
            document.getElementById('edit-charger-modal').classList.add('hidden');
        };

        const updateCharger = async () => {
            const id = document.getElementById('edit-charger-id').value;
            const name = document.getElementById('edit-charger-name').value;
            const rate = parseFloat(document.getElementById('edit-charger-rate').value);
            const status = document.getElementById('edit-charger-status').value;
            if (!id || !name || isNaN(rate)) {
                showMessage("Invalid data.", 3000, 'error');
                return;
            }
            try {
                await updateDoc(doc(db, "chargers", id), { name, rate, status });
                showMessage("Charger updated successfully!", 3000, 'success');
                closeEditModal();
            } catch (error) {
                showMessage(`Error updating charger: ${error.message}`, 4000, 'error');
            }
        };

        const setCustomPin = async () => {
            const newPin = document.getElementById('new-pin').value;
            const confirmPin = document.getElementById('confirm-pin').value;
            const ocmApiKey = document.getElementById('ocm-api-key').value;

            if (newPin !== confirmPin) {
                showMessage("PINs do not match.", 3000, 'error');
                return;
            }
            if (newPin.length < 6) {
                showMessage("PIN must be at least 6 characters long.", 3000, 'error');
                return;
            }

            const user = auth.currentUser;
            if (!user) {
                showMessage("User not authenticated.", 3000, 'error');
                return;
            }

            try {
                await updatePassword(user, newPin);
                
                const vendorQuery = query(collection(db, "vendors"), where("uid", "==", user.uid));
                const vendorSnapshot = await getDocs(vendorQuery);
                if (!vendorSnapshot.empty) {
                    const vendorDocRef = vendorSnapshot.docs[0].ref;
                    await updateDoc(vendorDocRef, { hasSetPin: true, ocmApiKey: ocmApiKey });
                }
                
                showMessage("PIN set successfully! You can now use this for all future logins.", 4000, 'success');
                document.getElementById('set-pin-form').style.display = 'none';
                document.getElementById('change-pin-form').style.display = 'block';
            } catch (error) {
                showMessage(`Failed to set PIN: ${error.message}. You may need to log out and log back in with your temporary key.`, 6000, 'error');
            }
        };

        const changeCustomPin = async () => {
            const currentPin = document.getElementById('current-pin').value;
            const newPin = document.getElementById('change-new-pin').value;
            const confirmPin = document.getElementById('change-confirm-pin').value;

            if (newPin !== confirmPin) {
                showMessage("New PINs do not match.", 3000, 'error');
                return;
            }
            if (newPin.length < 6) {
                showMessage("New PIN must be at least 6 characters long.", 3000, 'error');
                return;
            }

            const user = auth.currentUser;
            if (!user) {
                showMessage("User not authenticated.", 3000, 'error');
                return;
            }

            try {
                const credential = EmailAuthProvider.credential(user.email, currentPin);
                await reauthenticateWithCredential(user, credential);
                
                await updatePassword(user, newPin);
                
                showMessage("PIN changed successfully!", 3000, 'success');
                document.getElementById('change-pin-form').reset();
            } catch (error) {
                showMessage(`Failed to change PIN: ${error.message}. Please ensure your current PIN is correct.`, 6000, 'error');
            }
        };

        const initializeMapsAfterLogin = () => {
            if (googleMapsLoaded) return;
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyCLrNaIQ1Eu-XpKws7J4MFbdxw01p0bEnc&libraries=places,geometry,drawing&callback=googleMapsApiLoaded`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        };
        
        window.googleMapsApiLoaded = () => {
            googleMapsLoaded = true;
            console.log("Google Maps API loaded.");
            // Initialize maps that might be needed right away
            initUserMap();
            initChargersNearMeMap();
        };

        Object.assign(window, {
            showMessage, hideMessage, showSection, toggleMobileMenu,
            showLogin, showSignUp, backToPortalChoice,
            signUp, login, googleLogin,
            logout: async () => { await signOut(auth); showMessage("Logged out successfully.", 3000, 'info'); },
            calculateOptimalRoute, submitVehicle, deleteVehicle, addCharger, listHomeCharger, deleteCharger,
            submitVendorApplication, locateMe, showVendorTab, calculateROI, locateChargerOnMap,
            openEditModal, closeEditModal, updateCharger, setCustomPin, changeCustomPin,
            initUserMap, initChargersNearMeMap, initVendorMap, updateMapMarkers, updateVendorMapMarkers,
            startInAppNavigation, stopInAppNavigation, recalculateRouteWithStop,
            sortAndRedisplayChargers, selectNearbyPlace,
            nextStep, previousStep // Expose new functions to the window
        });

        onAuthStateChanged(auth, async (user) => {
            const authSection = document.getElementById('auth-section');
            const appContent = document.getElementById('app-content');
            if (user) {
                authSection.style.display = 'none';
                appContent.style.display = 'flex';
                document.getElementById('user-info').textContent = user.displayName || user.email;
                initializeMapsAfterLogin();
                
                let isVendor = false;
                const vendorQuery = query(collection(db, "vendors"), where("uid", "==", user.uid));
                const vendorSnapshot = await getDocs(vendorQuery);
                if (!vendorSnapshot.empty) {
                    isVendor = true;
                    const vendorData = vendorSnapshot.docs[0].data();
                    if (vendorData.ocmApiKey) {
                        openChargeMapApiKey = vendorData.ocmApiKey;
                    }
                }
                
                console.log(`User ${user.uid} logged in. Is vendor: ${isVendor}`);

                document.querySelectorAll('.user-only-nav').forEach(el => el.style.display = isVendor ? 'none' : 'block');
                document.querySelectorAll('.vendor-only-nav').forEach(el => el.style.display = isVendor ? 'block' : 'none');
                
                if (isVendor) {
                    showSection('dashboard');
                    setupVendorDashboard(user.uid);
                } else {
                    showSection('home');
                    loadUserVehicles(user.uid);
                    listenForUserChargers(user.uid);
                    checkVendorApplicationStatus(user.uid);
                }
            } else {
                authSection.style.display = 'flex';
                appContent.style.display = 'none';
                renderAuthForms();
            }
        });
    </script>
</body>
</html>
