<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChargeFranchise - EV Charging Platform</title>
    <!-- Tailwind CSS for styling. NOTE: For production, it's recommended to install Tailwind via NPM/CLI. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .section, .vendor-tab-content { display: none; }
        .section.active, .vendor-tab-content.active { display: block; animation: fadeIn 0.8s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-box {
            position: fixed; top: 20px; right: 20px;
            padding: 1rem 2rem; border-radius: 8px; z-index: 3001;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateX(120%); opacity: 0; display: none;
        }
        .message-box.show { transform: translateX(0); opacity: 1; display: flex; }
        .message-box.info { background-color: #3b82f6; color: white; }
        .message-box.success { background-color: #16a34a; color: white; }
        .message-box.error { background-color: #dc2626; color: white; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 3000;
        }
        .vendor-tab.active {
            border-color: #6366f1; /* indigo-500 */
            color: #4f46e5; /* indigo-600 */
            font-weight: 600;
        }
        .sort-btn.active-sort {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        /* Ensure map container has a defined height */
        #live-navigation {
            height: calc(100vh - 150px); /* Full viewport height minus header/padding */
        }
        /* Style for alternative route options */
        .route-option {
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .route-option.selected-route {
            border-color: #4f46e5; /* indigo-600 */
            background-color: #e0e7ff; /* indigo-100 */
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
</head>

<body class="bg-gray-100 font-sans min-h-screen flex flex-col">
    <!-- Message Box for feedback -->
    <div id="message-box" class="message-box">
        <span id="message-text"></span>
        <button onclick="hideMessage()" class="text-white text-xl ml-4">&times;</button>
    </div>

    <!-- Edit Charger Modal -->
    <div id="edit-charger-modal" class="modal-overlay hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Edit Charger</h2>
            <div id="edit-charger-form" class="space-y-4">
                <input type="hidden" id="edit-charger-id">
                <input type="text" id="edit-charger-name" placeholder="Charger Name" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                <input type="number" id="edit-charger-rate" placeholder="Charging Rate (kW)" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                <select id="edit-charger-status" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <option value="available">Available</option>
                    <option value="in-use">In Use</option>
                    <option value="maintenance">Maintenance</option>
                </select>
                <div class="flex gap-4 pt-4">
                    <button id="update-charger-btn" onclick="updateCharger()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Update Charger</button>
                    <button onclick="closeEditModal()" class="w-full bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors">Cancel</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Authentication Section -->
    <div id="auth-section" class="flex items-center justify-center min-h-screen p-4">
        <!-- Forms are rendered here by JS -->
    </div>

    <!-- Main Application -->
    <div id="app-content" class="flex flex-col flex-grow" style="display: none;">
        <header class="bg-white bg-opacity-10 backdrop-blur-lg p-4 sticky top-0 z-10 shadow-lg">
            <!-- Navigation Bar -->
            <nav class="container mx-auto flex justify-between items-center">
                <div class="logo text-2xl font-bold text-white">⚡ ChargeFranchise</div>
                <ul class="nav-links hidden md:flex items-center gap-4">
                    <!-- User Links -->
                    <li class="user-only-nav"><a href="#" class="text-white font-medium p-2" onclick="showSection('home')">Home</a></li>
                    <li class="user-only-nav"><a href="#" class="text-white font-medium p-2" onclick="showSection('find-chargers')">AI Route Planner</a></li>
                    <li class="user-only-nav"><a href="#" class="text-white font-medium p-2" onclick="showSection('chargers-near-me')">Chargers Near Me</a></li>
                    <li class="user-only-nav"><a href="#" class="text-white font-medium p-2" onclick="showSection('vehicle-reg')">My Vehicles</a></li>
                    <li class="user-only-nav"><a href="#" class="text-white font-medium p-2" onclick="showSection('rent-charger')">Rent My Charger</a></li>
                    <li class="user-only-nav"><a href="#" class="text-white font-medium p-2" onclick="showSection('become-vendor')">Become a Partner</a></li>
                    
                    <!-- Vendor Links -->
                    <li class="vendor-only-nav" style="display: none;"><a href="#" class="text-white font-medium p-2" onclick="showSection('dashboard'); showVendorTab('performance-overview');">Performance Overview</a></li>
                    <li class="vendor-only-nav" style="display: none;"><a href="#" class="text-white font-medium p-2" onclick="showSection('dashboard'); showVendorTab('manage-chargers');">Manage Chargers</a></li>
                    <li class="vendor-only-nav" style="display: none;"><a href="#" class="text-white font-medium p-2" onclick="showSection('dashboard'); showVendorTab('my-vmap');">My VMAP</a></li>
                    <li class="vendor-only-nav" style="display: none;"><a href="#" class="text-white font-medium p-2" onclick="showSection('dashboard'); showVendorTab('vendor-settings');">Settings</a></li>

                    <li id="user-info-container" class="flex items-center gap-4">
                        <span id="user-info" class="text-white"></span>
                        <button onclick="logout()" class="bg-red-500 text-white py-2 px-4 rounded-full font-semibold hover:bg-red-600">Logout</button>
                    </li>
                </ul>
                <button class="text-white text-2xl md:hidden" onclick="toggleMobileMenu()">☰</button>
            </nav>
            <!-- Mobile Menu -->
            <ul id="mobile-menu" class="hidden md:hidden mt-4 space-y-2">
                 <!-- User Links -->
                 <li class="user-only-nav"><a href="#" class="block text-white font-medium p-2" onclick="showSection('home'); toggleMobileMenu();">Home</a></li>
                 <li class="user-only-nav"><a href="#" class="block text-white font-medium p-2" onclick="showSection('find-chargers'); toggleMobileMenu();">AI Route Planner</a></li>
                 <li class="user-only-nav"><a href="#" class="block text-white font-medium p-2" onclick="showSection('chargers-near-me'); toggleMobileMenu();">Chargers Near Me</a></li>
                 <li class="user-only-nav"><a href="#" class="block text-white font-medium p-2" onclick="showSection('vehicle-reg'); toggleMobileMenu();">My Vehicles</a></li>
                 <li class="user-only-nav"><a href="#" class="block text-white font-medium p-2" onclick="showSection('rent-charger'); toggleMobileMenu();">Rent My Charger</a></li>
                 <li class="user-only-nav"><a href="#" class="block text-white font-medium p-2" onclick="showSection('become-vendor'); toggleMobileMenu();">Become a Partner</a></li>

                 <!-- Vendor Links -->
                 <li class="vendor-only-nav" style="display: none;"><a href="#" class="block text-white font-medium p-2" onclick="showSection('dashboard'); showVendorTab('performance-overview'); toggleMobileMenu();">Performance Overview</a></li>
                 <li class="vendor-only-nav" style="display: none;"><a href="#" class="block text-white font-medium p-2" onclick="showSection('dashboard'); showVendorTab('manage-chargers'); toggleMobileMenu();">Manage Chargers</a></li>
                 <li class="vendor-only-nav" style="display: none;"><a href="#" class="block text-white font-medium p-2" onclick="showSection('dashboard'); showVendorTab('my-vmap'); toggleMobileMenu();">My VMAP</a></li>
                 <li class="vendor-only-nav" style="display: none;"><a href="#" class="block text-white font-medium p-2" onclick="showSection('dashboard'); showVendorTab('vendor-settings'); toggleMobileMenu();">Settings</a></li>

                 <li class="pt-2"><button onclick="logout()" class="w-full bg-red-500 text-white py-2 px-4 rounded-full font-semibold hover:bg-red-600">Logout</button></li>
            </ul>
        </header>

        <main class="main-content container mx-auto p-4 flex-grow bg-white rounded-xl shadow-lg mt-4">
            <!-- Home Section -->
            <section id="home" class="section active">
                <div class="bg-indigo-600 text-white p-10 rounded-xl text-center shadow-lg">
                    <h1 class="text-4xl font-bold mb-4">The Future of EV Charging is Collaborative</h1>
                    <p class="text-xl opacity-90">Plan smart routes, manage your vehicles, and join our network of chargers.</p>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
                    <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-indigo-500 transition-all duration-300 hover:shadow-xl">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-2">My Vehicles</h2>
                        <button onclick="showSection('vehicle-reg')" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">Manage Vehicles</button>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-purple-500 transition-all duration-300 hover:shadow-xl">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-2">AI Route Planner</h2>
                        <button onclick="showSection('find-chargers')" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700">Plan Trip</button>
                    </div>
                    <div id="franchise-card" class="bg-white p-6 rounded-lg shadow-md border-t-4 border-yellow-500 transition-all duration-300 hover:shadow-xl" style="display: none;">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-2">Become a Partner</h2>
                        <p class="text-gray-600 mb-4">Earn by setting up your own charging station franchise.</p>
                        <button onclick="showSection('become-vendor')" class="w-full bg-yellow-500 text-white py-3 rounded-lg font-semibold hover:bg-yellow-600">Apply Now</button>
                    </div>
                </div>
            </section>

            <!-- AI Route Planner Section -->
            <section id="find-chargers" class="section">
                 <div class="p-6">
                    <h2 class="text-3xl font-bold mb-4 text-gray-800">AI Route Planner</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 p-6 bg-gray-50 rounded-lg shadow-inner space-y-4" id="route-form">
                            <h3 class="text-xl font-semibold text-gray-700">Plan your journey</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-600">Start Location</label>
                                <div class="flex items-center gap-2">
                                     <input type="text" id="route-start" placeholder="e.g. Mumbai" class="w-full p-3 border rounded-lg form-field">
                                     <button onclick="locateMe('route-start')" class="bg-gray-200 p-2 rounded-lg hover:bg-gray-300 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                                            <circle cx="12" cy="10" r="3" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- NEW: Waypoints UI -->
                            <div id="waypoints-container" class="space-y-2"></div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600">Add Waypoint (for long trips)</label>
                                <div class="flex items-center gap-2">
                                    <input type="text" id="waypoint-input" placeholder="e.g. Delhi" class="w-full p-3 border rounded-lg">
                                    <button onclick="addWaypoint()" class="bg-gray-200 p-2 rounded-lg hover:bg-gray-300 transition-colors font-bold text-lg">+</button>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-600">Destination</label>
                                <input type="text" id="route-end" placeholder="e.g. Pune" class="w-full p-3 border rounded-lg form-field">
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-600">Select Your Vehicle</label>
                                <select id="vehicle-select" class="w-full p-3 border rounded-lg form-field"></select>
                            </div>
                            <div>
                                <label for="start-charge" class="block text-sm font-medium text-gray-600">Starting Charge: <span id="start-charge-value">80</span>%</label>
                                <input type="range" id="start-charge" min="0" max="100" value="80" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="end-charge" class="block text-sm font-medium text-gray-600">Desired Charge at Arrival: <span id="end-charge-value">20</span>%</label>
                                <input type="range" id="end-charge" min="0" max="100" value="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="search-radius" class="block text-sm font-medium text-gray-600">Charger Search Radius: <span id="search-radius-value">10</span> km</label>
                                <input type="range" id="search-radius" min="5" max="50" value="10" step="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="nearby-radius" class="block text-sm font-medium text-gray-600">Nearby Places Radius: <span id="nearby-radius-value">1</span> km</label>
                                <input type="range" id="nearby-radius" min="1" max="5" value="1" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <button id="find-route-btn" onclick="findAlternativeRoutes()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Find Available Routes</button>
                        </div>
                        <div class="lg:col-span-2 space-y-4">
                            <div id="route-details" class="p-4 bg-blue-50 rounded-lg hidden"></div>
                            <div id="map" class="w-full h-[500px] rounded-lg shadow-md"></div>
                             <!-- Nearby Places will be shown here after selecting a charger -->
                            <div id="nearby-places" class="p-4 bg-gray-50 rounded-lg hidden"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Chargers Near Me Section -->
            <section id="chargers-near-me" class="section">
                <div class="p-6">
                    <h2 class="text-3xl font-bold mb-4 text-gray-800">EV Chargers Near Me</h2>
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-gray-600">Find the closest available chargers around your location.</p>
                        <button onclick="locateMe('near-me-map')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                                <circle cx="12" cy="10" r="3" />
                            </svg>
                            Locate Me
                        </button>
                    </div>
                    <div id="chargers-near-me-map" class="w-full h-[600px] rounded-lg shadow-md"></div>
                </div>
            </section>

            <!-- Live Navigation Section -->
            <section id="live-navigation" class="section">
                <div class="p-6 h-full flex flex-col relative">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-bold text-gray-800">Live Navigation</h2>
                        <div class="flex items-center gap-4">
                             <button id="mute-btn" onclick="toggleMute()" class="bg-gray-200 text-gray-700 p-2 rounded-full font-semibold hover:bg-gray-300 transition-colors">
                                <!-- Speaker Icon will be injected by JS -->
                            </button>
                            <button onclick="stopInAppNavigation()" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition-colors">Stop Navigation</button>
                        </div>
                    </div>
                    <!-- Info box for selected nearby place -->
                    <div id="selected-place-info" class="absolute top-20 left-1/2 -translate-x-1/2 z-10 bg-white p-3 rounded-lg shadow-lg hidden">
                        <p class="font-bold text-indigo-600">Visiting:</p>
                        <p id="selected-place-text" class="text-sm"></p>
                    </div>
                    <!-- Turn-by-turn directions panel -->
                    <div id="turn-by-turn-directions" class="absolute top-20 left-4 z-10 bg-white p-4 rounded-lg shadow-lg w-full max-w-sm">
                        <!-- Directions will be injected here by JS -->
                    </div>
                    <div id="live-navigation-map" class="w-full rounded-lg shadow-md flex-grow"></div>
                </div>
            </section>


            <!-- My Vehicles Section -->
            <section id="vehicle-reg" class="section">
                 <div class="p-6">
                    <h2 class="text-3xl font-bold mb-4 text-gray-800">My Vehicles</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-6 bg-gray-50 rounded-lg shadow-inner" id="vehicle-form">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">Add a New Vehicle</h3>
                            <div class="space-y-4">
                                <input type="text" id="reg-no" placeholder="Registration No. (e.g. MH01AB1234)" class="w-full p-3 border rounded-lg form-field">
                                <input type="text" id="vehicle-make" placeholder="Make (e.g. Tesla)" class="w-full p-3 border rounded-lg form-field">
                                <input type="text" id="vehicle-model" placeholder="Model (e.g. Model 3)" class="w-full p-3 border rounded-lg form-field">
                                <input type="number" id="battery-capacity" placeholder="Battery Capacity (kWh)" class="w-full p-3 border rounded-lg form-field">
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-2">Supported Connector Types</label>
                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                        <label class="flex items-center space-x-2"><input type="checkbox" class="form-checkbox h-4 w-4 text-indigo-600 supported-plug" value="CCS2"> <span>CCS2</span></label>
                                        <label class="flex items-center space-x-2"><input type="checkbox" class="form-checkbox h-4 w-4 text-indigo-600 supported-plug" value="CHADEMO"> <span>CHAdeMO</span></label>
                                        <label class="flex items-center space-x-2"><input type="checkbox" class="form-checkbox h-4 w-4 text-indigo-600 supported-plug" value="TYPE 2"> <span>Type 2 (AC)</span></label>
                                        <label class="flex items-center space-x-2"><input type="checkbox" class="form-checkbox h-4 w-4 text-indigo-600 supported-plug" value="GB/T"> <span>GB/T</span></label>
                                    </div>
                                </div>
                                <button id="submit-vehicle-btn" onclick="submitVehicle()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">Register Vehicle</button>
                            </div>
                        </div>
                        <div class="p-6 bg-gray-50 rounded-lg shadow-inner custom-scrollbar overflow-y-auto max-h-96">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">My Registered Vehicles</h3>
                            <div id="my-vehicles-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Rent My Charger Section -->
            <section id="rent-charger" class="section">
                <div class="p-6">
                    <h2 class="text-3xl font-bold mb-4 text-gray-800">Rent Your Home Charger</h2>
                    <p class="mb-6 text-gray-600">Earn extra income by listing your personal EV charger for others to use when you're not.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-6 bg-gray-50 rounded-lg shadow-inner" id="home-charger-form">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">List Your Charger</h3>
                            <div class="space-y-4">
                                <input type="text" id="home-charger-name" placeholder="Charger Nickname (e.g. My Home Charger)" class="w-full p-3 border rounded-lg form-field">
                                <input type="number" id="home-charger-rate" placeholder="Charging Rate (kW)" class="w-full p-3 border rounded-lg form-field">
                                <input type="text" id="home-charger-address" placeholder="Your Full Address" class="w-full p-3 border rounded-lg form-field">
                                <input type="text" id="home-charger-type" placeholder="Connector Type" class="w-full p-3 border rounded-lg form-field">
                                <button id="list-charger-btn" onclick="listHomeCharger()" class="w-full bg-teal-600 text-white py-3 rounded-lg font-semibold hover:bg-teal-700">List My Charger</button>
                            </div>
                        </div>
                        <div class="p-6 bg-gray-50 rounded-lg shadow-inner custom-scrollbar overflow-y-auto max-h-96">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">My Listed Chargers</h3>
                            <div id="user-chargers-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>
            </section>

             <!-- Become a Vendor Section -->
            <section id="become-vendor" class="section">
                 <div class="p-6 max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold mb-4 text-gray-800">Become a Vendor Partner</h2>
                    <div id="vendor-application-status"></div>
                </div>
            </section>

            <!-- Vendor Dashboard Section -->
            <section id="dashboard" class="section">
                <div class="p-6">
                    <div class="border-b border-gray-200 mb-4">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <a href="#" onclick="showVendorTab('performance-overview')" class="vendor-tab active border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Performance Overview</a>
                            <a href="#" onclick="showVendorTab('manage-chargers')" class="vendor-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Manage Chargers</a>
                            <a href="#" onclick="showVendorTab('my-vmap')" class="vendor-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">My VMAP</a>
                            <a href="#" onclick="showVendorTab('vendor-settings')" class="vendor-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Settings</a>
                        </nav>
                    </div>

                    <div id="performance-overview" class="vendor-tab-content active">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">Performance Overview</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-6 bg-gray-50 rounded-lg shadow-inner">
                                <h3 class="text-xl font-semibold mb-3 text-gray-700">Monthly Earnings</h3>
                                <canvas id="chargingChart"></canvas>
                            </div>
                            <div class="p-6 bg-gray-50 rounded-lg shadow-inner" id="roi-calculator">
                                <h3 class="text-xl font-semibold mb-3 text-gray-700">Return on Investment (ROI) Calculator</h3>
                                <div class="space-y-4">
                                    <input type="number" id="investment" placeholder="Total Investment (₹)" class="w-full p-3 border rounded-lg">
                                    <input type="number" id="monthly-revenue" placeholder="Avg. Monthly Revenue (₹)" class="w-full p-3 border rounded-lg">
                                    <button onclick="calculateROI()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">Calculate Annual ROI</button>
                                    <div id="roi-result" class="mt-4 p-4 bg-blue-100 rounded-lg hidden"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="manage-chargers" class="vendor-tab-content">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="p-6 bg-gray-50 rounded-lg shadow-inner">
                                <h3 class="text-xl font-semibold mb-3 text-gray-700">My Franchise Chargers</h3>
                                <div id="vendor-chargers-list" class="space-y-3 max-h-[400px] overflow-y-auto custom-scrollbar"></div>
                            </div>
                             <div class="p-6 bg-gray-50 rounded-lg shadow-inner" id="vendor-charger-form">
                                <h3 class="text-xl font-semibold mb-3 text-gray-700">Add a New Franchise Charger</h3>
                                <div class="space-y-4">
                                    <input type="text" id="charger-name" placeholder="Charger Name" class="w-full p-3 border rounded-lg form-field">
                                    <input type="number" id="charger-rate" placeholder="Charging Rate (kW)" class="w-full p-3 border rounded-lg form-field">
                                    <input type="number" id="charger-lat" placeholder="Latitude" class="w-full p-3 border rounded-lg form-field">
                                    <input type="number" id="charger-lng" placeholder="Longitude" class="w-full p-3 border rounded-lg form-field">
                                    <select id="connector-type-select" class="w-full p-3 border rounded-lg form-field">
                                        <option value="">Select Connector Type</option>
                                        <option value="CCS2">CCS2</option>
                                        <option value="CHAdeMO">CHAdeMO</option>
                                        <option value="Type 2 AC">Type 2 AC</option>
                                        <option value="3-pin plug">3-pin plug</option>
                                    </select>
                                    <select id="charger-type-select" class="w-full p-3 border rounded-lg form-field">
                                        <option value="">Select Charger Type</option>
                                        <option value="AC Slow">AC Slow</option>
                                        <option value="AC Fast">AC Fast</option>
                                        <option value="DC Fast">DC Fast Charger</option>
                                    </select>
                                    <button id="add-charger-btn" onclick="addCharger()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">Add Charger</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="my-vmap" class="vendor-tab-content">
                         <h3 class="text-2xl font-bold mb-4 text-gray-800">My Charger Locations</h3>
                        <div id="vendor-map" class="w-full h-[500px] rounded-lg shadow-md"></div>
                    </div>

                    <div id="vendor-settings" class="vendor-tab-content">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">Vendor Settings</h3>
                        <div class="p-6 bg-gray-50 rounded-lg shadow-inner max-w-md mx-auto" id="set-pin-form">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">Set Your Custom PIN</h3>
                            <p class="text-gray-600 mb-4">This PIN will be used for all future logins.</p>
                            <div class="space-y-4">
                                <input type="password" id="new-pin" placeholder="New PIN" class="w-full p-3 border rounded-lg form-field">
                                <input type="password" id="confirm-pin" placeholder="Confirm New PIN" class="w-full p-3 border rounded-lg form-field">
                                <button onclick="setCustomPin()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">Set PIN</button>
                            </div>
                        </div>

                        <div class="p-6 bg-gray-50 rounded-lg shadow-inner max-w-md mx-auto mt-6" id="change-pin-form" style="display:none;">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">Change Your PIN</h3>
                            <div class="space-y-4">
                                <input type="password" id="current-pin" placeholder="Current PIN" class="w-full p-3 border rounded-lg form-field">
                                <input type="password" id="change-new-pin" placeholder="New PIN" class="w-full p-3 border rounded-lg form-field">
                                <input type="password" id="change-confirm-pin" placeholder="Confirm New PIN" class="w-full p-3 border rounded-lg form-field">
                                <button onclick="changeCustomPin()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">Change PIN</button>
                            </div>
                        </div>

                        <div class="p-6 bg-gray-50 rounded-lg shadow-inner max-w-md mx-auto mt-6">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">Open Charge Map API Key</h3>
                            <p class="text-gray-600 mb-4">Enter your Open Charge Map API key for global charger data.</p>
                            <input type="text" id="ocm-api-key" placeholder="Enter API Key" class="w-full p-3 border rounded-lg form-field">
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Main Application Script -->
    <script type="module">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCB2GoSkw4qdFkUmFxNAmIUgGgzFXCZZp8",
            authDomain: "chargeshare-a327a.firebaseapp.com",
            databaseURL: "https://chargeshare-a327a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "chargeshare-a327a",
            storageBucket: "chargeshare-a327a.appspot.com",
            messagingSenderId: "77947942873",
            appId: "1:77947942873:web:b8366adbb41f39b8a8cbc8"
        };
        // Use a placeholder for the Open Charge Map API key, which can be updated in the settings
        let openChargeMapApiKey = "6aa27df2-0e7d-4ce3-9787-5e869d304fd7"; 

        // Firebase Service Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
            signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup,
            signOut, updateProfile, updatePassword, reauthenticateWithCredential, EmailAuthProvider
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, getDoc, addDoc, collection,
            query, onSnapshot, serverTimestamp, deleteDoc, GeoPoint, where, updateDoc, getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, ref, uploadBytes, getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Global App State
        let mainMap, nearMeMap, liveNavigationMap, directionsService, chargingChart, geocoder, placesService, vendorMap;
        let allChargers = [];
        let userVehicles = [];
        let chargerMarkers = [];
        let nearMeChargerMarkers = [];
        let vendorChargerMarkers = [];
        let userLocationMarker = null; // This will be the moving blue dot for live navigation
        let nearMeUserMarker = null; // This is the static pin for the "Chargers Near Me" map
        let watchId = null;
        const MASTER_KEY = "25annu30athu";
        let googleMapsLoaded = false;
        let alternativeRouteRenderers = []; // To hold renderers for alternative routes
        let segmentRenderers = []; // To hold renderers for intermediate planning segments
        let waypoints = []; // To store user-added waypoints
        let isMuted = false; // To control voice navigation
        
        let currentRoute = {
            vehicle: null,
            navigationDirections: null, 
            selectedChargerId: null,
            chargersOnRoute: [], 
            selectedPlace: null,
            currentLegIndex: 0,
            currentStepIndex: 0,
            isAtLegEnd: false,
            finalOrigin: null,
            finalDestination: null,
            currentOrigin: null,
            plannedWaypoints: [],
            isPlanning: false,
            completeChargerList: [],
            currentCharge: 100, // NEW: Tracks battery percentage throughout planning
            alternativeRoutesResponse: null,
            selectedRouteIndex: null
        };
        
        // --- All functions are defined here for proper scoping ---
        
        const showMessage = (message, duration = 3000, type = 'info') => {
            const msgBox = document.getElementById('message-box');
            const msgText = document.getElementById('message-text');
            if(!msgBox || !msgText) return;
            msgText.textContent = message;
            msgBox.className = `message-box show ${type}`;
            setTimeout(() => hideMessage(), duration);
        };

        const hideMessage = () => {
            const msgBox = document.getElementById('message-box');
            if(msgBox) msgBox.className = 'message-box';
        };

        const showSection = (sectionId) => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            const sectionElement = document.getElementById(sectionId);
            if (sectionElement) {
                sectionElement.classList.add('active');
            }

            // Trigger map resize for all maps to ensure they render correctly when their section becomes visible
            setTimeout(() => {
                if (mainMap && sectionId === 'find-chargers') {
                    google.maps.event.trigger(mainMap, 'resize');
                }
                if (nearMeMap && sectionId === 'chargers-near-me') {
                    google.maps.event.trigger(nearMeMap, 'resize');
                }
                if (liveNavigationMap && sectionId === 'live-navigation') {
                    google.maps.event.trigger(liveNavigationMap, 'resize');
                }
                if (vendorMap && sectionId === 'dashboard' && document.getElementById('my-vmap').classList.contains('active')) {
                    google.maps.event.trigger(vendorMap, 'resize');
                }
            }, 150);
        };

        const toggleMobileMenu = () => {
            document.getElementById('mobile-menu')?.classList.toggle('hidden');
        };
        
        const renderAuthForms = () => {
            const authSection = document.getElementById('auth-section');
            if(!authSection) return;
            authSection.innerHTML = `
                <div id="portal-choice" class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg text-center">
                    <h1 class="text-3xl font-bold text-indigo-600 mb-4">⚡ ChargeFranchise</h1>
                    <p class="text-gray-600 mb-6">Welcome! Please select your portal.</p>
                    <div class="space-y-4">
                        <button onclick="showLogin('user')" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">User Portal</button>
                        <button onclick="showLogin('vendor')" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">Vendor / Executive Portal</button>
                    </div>
                </div>
                <div id="login-container" class="max-w-md w-full" style="display:none;"></div>
                <div id="signup-container" class="max-w-md w-full" style="display:none;"></div>
            `;
        };

        const showLogin = (role) => {
            document.getElementById('portal-choice').style.display = 'none';
            const container = document.getElementById('login-container');
            container.style.display = 'block';
            let passwordLabel = role === 'user' ? 'Password' : 'Password / Key / Master Key';
            let loginButtonText = role === 'user' ? 'Login' : 'Login / Verify';
            container.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-indigo-600 mb-6 text-center">Login to ${role === 'user' ? 'User' : 'Vendor'} Portal</h2>
                    <div class="space-y-4" id="login-form">
                        <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 border rounded-lg form-field">
                        <input type="password" id="loginPassword" placeholder="${passwordLabel}" class="w-full p-3 border rounded-lg form-field">
                        <button id="login-btn" onclick="login('${role}')" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">${loginButtonText}</button>
                        ${role === 'user' ? `<button onclick="googleLogin()" class="w-full flex items-center justify-center gap-3 bg-white text-gray-700 py-3 rounded-lg border hover:bg-gray-100">
                           <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="h-5"> Sign in with Google
                        </button>` : ''}
                        <div id="loginError" class="text-red-500 text-sm"></div>
                        <p class="text-sm text-gray-500 pt-2">New here? <a href="#" onclick="showSignUp('user')" class="text-indigo-600 hover:underline">Create a user account</a></p>
                        <button onclick="backToPortalChoice()" class="w-full bg-gray-400 text-white py-3 rounded-lg font-semibold hover:bg-gray-500">Back</button>
                    </div>
                </div>
            `;
            setupEnterKeyNavigation();
        };

        const showSignUp = (role) => {
            document.getElementById('portal-choice').style.display = 'none';
            document.getElementById('login-container').style.display = 'none';
            const container = document.getElementById('signup-container');
            container.style.display = 'block';
            container.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-indigo-600 mb-6 text-center">Create a User Account</h2>
                    <p class="text-center text-gray-500 mb-4">Vendor accounts are created after executive verification.</p>
                    <div class="space-y-4" id="signup-form">
                        <input type="email" id="signupEmail" placeholder="Email" class="w-full p-3 border rounded-lg form-field">
                        <input type="password" id="signupPassword" placeholder="Password" class="w-full p-3 border rounded-lg form-field">
                        <input type="text" id="signupName" placeholder="Name" class="w-full p-3 border rounded-lg form-field">
                        <button id="signup-btn" onclick="signUp('user')" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">Create Account</button>
                        
                        <div class="relative flex py-2 items-center">
                            <div class="flex-grow border-t border-gray-300"></div>
                            <span class="flex-shrink mx-4 text-gray-500 text-sm">OR</span>
                            <div class="flex-grow border-t border-gray-300"></div>
                        </div>

                        <button onclick="googleLogin()" class="w-full flex items-center justify-center gap-3 bg-white text-gray-700 py-3 rounded-lg border hover:bg-gray-100">
                           <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="h-5"> Sign up with Google
                        </button>

                        <div id="signupError" class="text-red-500 text-sm"></div>
                        <p class="text-sm text-gray-500 pt-2">Already have an account? <a href="#" onclick="showLogin('user')" class="text-indigo-600 hover:underline">Login</a></p>
                        <button onclick="backToPortalChoice()" class="w-full bg-gray-400 text-white py-3 rounded-lg font-semibold hover:bg-gray-500">Back</button>
                    </div>
                </div>
            `;
            setupEnterKeyNavigation();
        };

        const backToPortalChoice = () => {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('signup-container').style.display = 'none';
            document.getElementById('portal-choice').style.display = 'block';
        };
        
        const setupEnterKeyNavigation = () => {
            const formContainers = ['login-form', 'signup-form', 'vehicle-form', 'home-charger-form', 'vendor-charger-form', 'route-form', 'edit-charger-form'];
            formContainers.forEach(formId => {
                const container = document.getElementById(formId);
                if (!container) return;
                const fields = [...container.querySelectorAll('.form-field')];
                const submitButton = container.querySelector('button[id$="-btn"]');
                fields.forEach((field, index) => {
                    field.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const nextField = fields[index + 1];
                            if (nextField) nextField.focus();
                            else if (submitButton) submitButton.click();
                        }
                    });
                });
            });
        };

        const loadUserVehicles = (uid) => {
            const q = query(collection(db, "users", uid, "vehicles"));
            onSnapshot(q, (snapshot) => {
                userVehicles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const vehicleSelect = document.getElementById('vehicle-select');
                const listEl = document.getElementById('my-vehicles-list');
                if (vehicleSelect) {
                    vehicleSelect.innerHTML = '<option value="">Select a vehicle</option>';
                    userVehicles.forEach(v => {
                        const option = document.createElement('option');
                        option.value = v.id;
                        option.textContent = `${v.make} ${v.model} (${v.regNo})`;
                        vehicleSelect.appendChild(option);
                    });
                }
                if (listEl) {
                    listEl.innerHTML = userVehicles.length === 0 ? `<p class="text-gray-500">No vehicles added yet.</p>` : '';
                    userVehicles.forEach(vehicle => {
                        const item = document.createElement('div');
                        item.className = 'bg-white p-4 rounded-lg shadow-sm flex justify-between items-center';
                        item.innerHTML = `<div><p class="font-semibold">${vehicle.make} ${vehicle.model}</p><p class="text-sm text-gray-600">${vehicle.regNo}</p></div>
                                          <button onclick="deleteVehicle('${vehicle.id}')" class="text-red-500 hover:text-red-700 font-semibold">Delete</button>`;
                        listEl.appendChild(item);
                    });
                }
            });
        };

        const updateMapMarkers = (mapInstance, markerArray, markersToShow) => {
            markerArray.forEach(marker => marker.setMap(null));
            markerArray.length = 0;

            const markerData = markersToShow || allChargers;

            markerData.forEach(charger => {
                if (!charger.location) return;
                let iconUrl = 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'; // Blue for available public
                if (charger.type === 'home' || charger.IsPrivate) {
                    iconUrl = 'http://maps.google.com/mapfiles/ms/icons/purple-dot.png'; // Purple for private/home
                } else if (charger.status !== 'available') {
                    iconUrl = 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'; // Red for in-use/maintenance
                }
                const marker = new google.maps.Marker({
                    position: { lat: charger.location.latitude, lng: charger.location.longitude },
                    map: mapInstance, title: charger.name || charger.AddressInfo?.Title,
                    icon: { url: iconUrl, scaledSize: new google.maps.Size(32, 32) }
                });
                
                let infoWindowContent = `<div><strong>${charger.name || charger.AddressInfo?.Title || 'N/A'}</strong><br>
                    ${charger.rate || charger.Connections?.[0]?.PowerKW || 'N/A'} kW | ${charger.type || (charger.IsPrivate ? 'Private' : 'Public')}<br>
                    Status: <span class="font-bold ${charger.status === 'available' ? 'text-green-600' : 'text-red-600'}">${charger.status || 'available'}</span>`;

                if (mapInstance === nearMeMap) {
                    infoWindowContent += `<br><button onclick="navigateToCharger(${charger.location.latitude}, ${charger.location.longitude})" class="mt-2 bg-indigo-500 text-white text-xs py-1 px-2 rounded-md hover:bg-indigo-600">Navigate</button>`;
                }
                infoWindowContent += `</div>`;

                const infoWindow = new google.maps.InfoWindow({ content: infoWindowContent });

                marker.addListener('click', () => infoWindow.open(mapInstance, marker));
                markerArray.push(marker);
            });
        };
        
        const displayRouteInfo = (legs, chargers, vehicle, directionsResult) => {
            const routeDetailsEl = document.getElementById('route-details');
            let totalDistance = legs.reduce((sum, leg) => sum + leg.distance.value, 0);
            let totalDuration = legs.reduce((sum, leg) => sum + (leg.duration_in_traffic ? leg.duration_in_traffic.value : leg.duration.value), 0);
            
            // More accurate charging time calculation
            let chargingTime = 0;
            chargers.forEach(charger => {
                // Use the dynamically calculated chargeNeededKwh if available
                const energyNeeded = charger.chargeNeededKwh || (vehicle.batteryCapacity * 0.7); // Fallback to 70% charge
                chargingTime += (energyNeeded / (charger.rate || 11)) * 3600; // Default to 11kW if rate is unknown
            });

            const totalTripTime = totalDuration + chargingTime;
            let html = `<h4 class="font-bold text-lg mb-2">Trip Summary</h4>
                        <p><strong>Total Distance:</strong> ${(totalDistance / 1000).toFixed(1)} km</p>
                        <p><strong>Driving Time (with traffic):</strong> ${formatDuration(totalDuration)}</p>`;
            if(chargers.length > 0) {
                html += `<p><strong>Est. Charging Time:</strong> ${formatDuration(chargingTime)}</p>
                         <p class="font-bold"><strong>Total Trip Time:</strong> ${formatDuration(totalTripTime)}</p>
                         <h5 class="font-semibold mt-2">Charging Stops:</h5><ul class="list-disc pl-5">`;
                chargers.forEach(c => { 
                    html += `<li>${c.name || c.AddressInfo?.Title} (${c.rate || c.Connections?.[0]?.PowerKW || 'N/A'} kW) - Arrive at ~${c.arrivalCharge.toFixed(0)}%</li>`; 
                });
                html += `</ul>`;
            } else {
                 html += `<p class="text-green-600 font-semibold mt-2">No charging stops needed for this trip!</p>`;
            }
            html += `<p class="text-sm mt-2">Estimated arrival charge: ${currentRoute.currentCharge.toFixed(0)}%</p>`;
            html += `<button onclick="startInAppNavigation()" class="mt-4 w-full bg-green-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-600">Start Live Navigation</button>`;
            routeDetailsEl.innerHTML = html;
            routeDetailsEl.classList.remove('hidden');

            clearAlternativeRoutes();
            const finalRenderer = new google.maps.DirectionsRenderer({
                map: mainMap,
                directions: directionsResult,
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: '#4f46e5',
                    strokeWeight: 6,
                    strokeOpacity: 0.9
                }
            });
            alternativeRouteRenderers.push(finalRenderer);
            addRouteMarkers(directionsResult, chargers);
        };

        const addRouteMarkers = (directionsResult, chargers) => {
            chargerMarkers.forEach(marker => marker.setMap(null));
            chargerMarkers = [];

            const startMarker = new google.maps.Marker({
                position: directionsResult.routes[0].legs[0].start_location,
                map: mainMap,
                title: 'Start',
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
                    scaledSize: new google.maps.Size(40, 40)
                }
            });
            chargerMarkers.push(startMarker);

            const endMarker = new google.maps.Marker({
                position: directionsResult.routes[0].legs[directionsResult.routes[0].legs.length - 1].end_location,
                map: mainMap,
                title: 'Destination',
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                    scaledSize: new google.maps.Size(40, 40)
                }
            });
            chargerMarkers.push(endMarker);

            chargers.forEach(charger => {
                const position = { lat: charger.location.latitude, lng: charger.location.longitude };
                const stopMarker = new google.maps.Marker({
                    position: position,
                    map: mainMap,
                    title: `Charger: ${charger.name || charger.AddressInfo?.Title}`,
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                        scaledSize: new google.maps.Size(40, 40)
                    }
                });

                stopMarker.addListener('click', () => {
                    const infoWindow = new google.maps.InfoWindow({
                        content: `<div><strong>${charger.name || charger.AddressInfo?.Title}</strong><p>Showing nearby places.</p></div>`
                    });
                    infoWindow.open(mainMap, stopMarker);
                    findNearbyPlaces(charger);
                    currentRoute.selectedPlace = null; 
                });

                chargerMarkers.push(stopMarker);
            });
        };

        const startInAppNavigation = () => {
            const directionsResult = currentRoute.navigationDirections;
            if (!directionsResult) {
                showMessage("No complete route available to navigate.", 3000, 'error');
                return;
            }

            showSection('live-navigation');
            updateMuteButtonUI();
            
            const liveMapElement = document.getElementById('live-navigation-map');
            if (!liveNavigationMap) {
                liveNavigationMap = new google.maps.Map(liveMapElement, {
                    zoom: 15,
                    center: directionsResult.routes[0].legs[0].start_location,
                    mapTypeControl: false,
                    mapTypeId: google.maps.MapTypeId.TERRAIN
                });
            } else {
                liveNavigationMap.setCenter(directionsResult.routes[0].legs[0].start_location);
            }

            setTimeout(() => {
                google.maps.event.trigger(liveNavigationMap, 'resize');
                liveNavigationMap.setCenter(directionsResult.routes[0].legs[0].start_location);
            }, 200);


            const liveDirectionsRenderer = new google.maps.DirectionsRenderer({ map: liveNavigationMap, suppressMarkers: true });
            liveDirectionsRenderer.setDirections(directionsResult);

            const placeInfoBox = document.getElementById('selected-place-info');
            if (currentRoute.selectedPlace) {
                document.getElementById('selected-place-text').textContent = `${currentRoute.selectedPlace.name} (${currentRoute.selectedPlace.vicinity})`;
                placeInfoBox.classList.remove('hidden');
            } else {
                placeInfoBox.classList.add('hidden');
            }

            if (navigator.geolocation) {
                if (userLocationMarker) userLocationMarker.setMap(null);
                userLocationMarker = new google.maps.Marker({
                    position: liveNavigationMap.getCenter(),
                    map: liveNavigationMap,
                    title: 'Your Location',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: '#4285F4',
                        fillOpacity: 1,
                        strokeWeight: 2,
                        strokeColor: 'white'
                    }
                });

                if (watchId) navigator.geolocation.clearWatch(watchId);
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        userLocationMarker.setPosition(pos);
                        liveNavigationMap.panTo(pos);
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        showMessage("Failed to get live location. Check your device settings.", 4000, 'error');
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                showMessage("Your browser does not support geolocation.", 4000, 'error');
            }
            
            currentRoute.currentLegIndex = 0;
            currentRoute.currentStepIndex = 0;
            currentRoute.isAtLegEnd = false;
            speak("Starting navigation.");
            displayCurrentStep();
        };
        
        const displayCurrentStep = () => {
            const directionsPanel = document.getElementById('turn-by-turn-directions');
            if (!directionsPanel || !currentRoute.navigationDirections) return;

            const route = currentRoute.navigationDirections.routes[0];
            if (!route) {
                directionsPanel.innerHTML = '<p>Route not available.</p>';
                return;
            }

            if (currentRoute.isAtLegEnd) {
                 const isFinalLeg = currentRoute.currentLegIndex >= route.legs.length - 1;
                 let arrivalMessage;
                 if (isFinalLeg) {
                     arrivalMessage = "You have arrived at your final destination!";
                     directionsPanel.innerHTML = `<div class="text-center p-4"><p class="text-lg font-bold text-green-600">${arrivalMessage}</p></div>`;
                 } else {
                     const leg = route.legs[currentRoute.currentLegIndex];
                     arrivalMessage = `You have arrived at your stop, ${leg.end_address}.`;
                     directionsPanel.innerHTML = `
                        <div class="text-center p-4">
                            <p class="text-lg font-bold text-indigo-600">Arrived at Stop:</p>
                            <p class="my-2">${leg.end_address}</p>
                            <button onclick="startNextLeg()" class="mt-4 w-full bg-green-500 text-white py-2 rounded-lg font-semibold hover:bg-green-600">Continue to Next Stop</button>
                        </div>`;
                 }
                 speak(arrivalMessage);
                 return;
            }

            const leg = route.legs[currentRoute.currentLegIndex];
            const step = leg.steps[currentRoute.currentStepIndex];

            if (!step) {
                directionsPanel.innerHTML = `<div class="text-center p-4"><p class="text-lg font-bold text-green-600">You have arrived!</p></div>`;
                speak("You have arrived!");
                return;
            }

            let html = `
                <div class="p-2">
                    <p class="text-sm text-gray-500">Next turn in: ${step.distance.text}</p>
                    <div class="text-xl font-bold text-gray-800 my-2">${step.instructions}</div>
                    <p class="text-sm text-gray-600">Leg ${currentRoute.currentLegIndex + 1} of ${route.legs.length} - Remaining: ${leg.distance.text}</p>
                </div>
                <div class="flex justify-between mt-4 border-t pt-2">
                    <button id="prev-step-btn" onclick="previousStep()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">&larr; Previous</button>
                    <button id="next-step-btn" onclick="nextStep()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Next &rarr;</button>
                </div>
            `;
            directionsPanel.innerHTML = html;
            
            const instructionText = step.instructions.replace(/<[^>]*>/g, '');
            speak(instructionText);

            if (currentRoute.currentLegIndex === 0 && currentRoute.currentStepIndex === 0) {
                document.getElementById('prev-step-btn').disabled = true;
                document.getElementById('prev-step-btn').classList.add('opacity-50', 'cursor-not-allowed');
            }
        };

        const startNextLeg = () => {
            currentRoute.isAtLegEnd = false;
            currentRoute.currentLegIndex++;
            currentRoute.currentStepIndex = 0;
            displayCurrentStep();
        };

        const nextStep = () => {
            const route = currentRoute.navigationDirections.routes[0];
            if (!route) return;

            const leg = route.legs[currentRoute.currentLegIndex];
            if (currentRoute.currentStepIndex < leg.steps.length - 1) {
                currentRoute.currentStepIndex++;
            } else { 
                currentRoute.isAtLegEnd = true;
            }
            displayCurrentStep();
        };

        const previousStep = () => {
            if (currentRoute.isAtLegEnd) {
                currentRoute.isAtLegEnd = false;
                displayCurrentStep();
                return;
            }

            const route = currentRoute.navigationDirections.routes[0];
            if (!route) return;

            if (currentRoute.currentStepIndex > 0) {
                currentRoute.currentStepIndex--;
            } else if (currentRoute.currentLegIndex > 0) {
                currentRoute.currentLegIndex--;
                const prevLeg = route.legs[currentRoute.currentLegIndex];
                currentRoute.currentStepIndex = prevLeg.steps.length - 1;
            }
            displayCurrentStep();
        };

        const stopInAppNavigation = () => {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            if (userLocationMarker) {
                userLocationMarker.setMap(null);
                userLocationMarker = null;
            }
            currentRoute.selectedPlace = null;
            document.getElementById('selected-place-info').classList.add('hidden');
            document.getElementById('turn-by-turn-directions').innerHTML = '';
            speak("Navigation stopped.");
            showSection('find-chargers'); 
            showMessage("Live navigation stopped.", 3000, 'info');
        };

        const formatDuration = (seconds) => {
            if (isNaN(seconds) || seconds === null) return 'N/A';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return `${h > 0 ? h + 'h ' : ''}${m}m`;
        };

        const signUp = async (role = 'user') => {
             if (role === 'vendor') {
                showMessage("Vendor registration is by executive approval only.", 4000, 'error');
                return;
            }
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const name = document.getElementById('signupName').value;
            const errorElement = document.getElementById('signupError');
            errorElement.textContent = '';
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: name });
                await setDoc(doc(db, 'users', userCredential.user.uid), { name, email, role: 'user', createdAt: serverTimestamp() });
                showMessage('Sign up successful!', 3000, 'success');
            } catch (error) { errorElement.textContent = error.message; }
        };

        const login = async (role) => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorElement = document.getElementById('loginError');
            errorElement.textContent = '';

            if (role === 'vendor' && password === MASTER_KEY) {
                await executiveVerify(email);
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                if (role === 'user') {
                    const userDoc = await getDoc(doc(db, "users", userCredential.user.uid));
                    if (userDoc.exists() && userDoc.data().role === 'user') {
                         showMessage('Login successful!', 3000, 'success');
                    } else {
                        await signOut(auth);
                        errorElement.textContent = `This account is not a registered user.`;
                    }
                } else if (role === 'vendor') {
                    const q = query(collection(db, "vendors"), where("uid", "==", userCredential.user.uid));
                    const vendorSnapshot = await getDocs(q);
                     if (!vendorSnapshot.empty) {
                         showMessage('Vendor login successful!', 3000, 'success');
                     } else {
                        await signOut(auth);
                        errorElement.textContent = `This account is not a registered vendor.`;
                     }
                }
            } catch (error) { errorElement.textContent = error.message; }
        };

        const executiveVerify = async (vendorEmail) => {
            try {
                const q = query(collection(db, "vendor_requests"), where("email", "==", vendorEmail), where("status", "==", "pending"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showMessage("No pending vendor request found for this email.", 4000, 'error');
                    return;
                }

                const requestDoc = querySnapshot.docs[0];
                const vendorName = requestDoc.data().name;
                const tempKey = 'TEMP' + Math.random().toString(36).substr(2, 8).toUpperCase();

                const userCredential = await createUserWithEmailAndPassword(auth, vendorEmail, tempKey);
                const vendorUid = userCredential.user.uid;
                await updateProfile(userCredential.user, { displayName: vendorName });

                const vendorDocName = `${vendorName.replace(/[^\w\s]/gi, '').replace(/\s+/g, '_')}_key`;
                await setDoc(doc(db, "vendors", vendorDocName), {
                    uid: vendorUid,
                    email: vendorEmail,
                    name: vendorName,
                    hasSetPin: false,
                    createdAt: serverTimestamp()
                });

                await updateDoc(requestDoc.ref, { status: "approved" });

                showMessage(`Vendor ${vendorEmail} approved. Temporary key: ${tempKey}`, 10000, 'success');
                await signOut(auth);
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                     showMessage("This email is already registered as a user. To proceed, you must first delete this user from the Firebase Authentication tab, then the executive can approve them.", 8000, 'error');
                } else {
                    showMessage(`Verification failed: ${error.message}`, 5000, 'error');
                }
            }
        };

        const googleLogin = async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (!userDocSnap.exists()) {
                     await setDoc(userDocRef, { name: user.displayName, email: user.email, role: 'user', createdAt: serverTimestamp() });
                }
                showMessage('Logged in with Google!', 3000, 'success');
            } catch (error) { showMessage(`Google login failed: ${error.message}`, 5000, 'error'); }
        };

        const submitVehicle = async () => {
            const regNo = document.getElementById('reg-no').value.toUpperCase();
            const make = document.getElementById('vehicle-make').value;
            const model = document.getElementById('vehicle-model').value;
            const batteryCapacity = parseFloat(document.getElementById('battery-capacity').value);
            const supportedPlugs = [...document.querySelectorAll('.supported-plug:checked')].map(cb => cb.value.toUpperCase());
            
            const rtoRegex = /^[A-Z]{2}[0-9]{1,2}[A-Z]{1,2}[0-9]{1,4}$/;
            if (!rtoRegex.test(regNo)) {
                showMessage('Invalid Registration Number format.', 3000, 'error'); return;
            }
            if (!make || !model || isNaN(batteryCapacity) || supportedPlugs.length === 0) {
                showMessage('Please fill all vehicle fields and select at least one connector type.', 3000, 'error'); return;
            }
            try {
                const user = auth.currentUser;
                if (!user) throw new Error("User not logged in.");
                await addDoc(collection(db, "users", user.uid, "vehicles"), { regNo, make, model, batteryCapacity, supportedPlugs });
                showMessage('Vehicle added successfully!', 3000, 'success');
                document.getElementById('vehicle-form').reset();
            } catch (error) { showMessage(`Error: ${error.message}`, 4000, 'error'); }
        };

        const deleteVehicle = async (vehicleId) => {
            if (!confirm("Delete this vehicle?")) return;
            try {
                const user = auth.currentUser;
                if (!user) throw new Error("User not logged in.");
                await deleteDoc(doc(db, "users", user.uid, "vehicles", vehicleId));
                showMessage('Vehicle deleted.', 3000, 'success');
            } catch (error) { showMessage(`Error: ${error.message}`, 4000, 'error'); }
        };
        
        const addCharger = async (isHomeCharger = false) => {
            const user = auth.currentUser;
            if (!user) { showMessage("You must be logged in.", 3000, 'error'); return; }
            let name, rate, connectorType, chargerType, location, address;

            if (isHomeCharger) {
                name = document.getElementById('home-charger-name').value;
                rate = parseFloat(document.getElementById('home-charger-rate').value);
                connectorType = document.getElementById('home-charger-type').value;
                address = document.getElementById('home-charger-address').value;
                if (!name || isNaN(rate) || !connectorType || !address) {
                    showMessage('Please fill all home charger fields.', 3000, 'error'); return;
                }
                try {
                    const results = await new Promise((resolve, reject) => {
                        geocoder.geocode({ address }, (results, status) => {
                            if (status === 'OK') resolve(results);
                            else reject(new Error('Geocode failed: ' + status));
                        });
                    });
                    location = new GeoPoint(results[0].geometry.location.lat(), results[0].geometry.location.lng());
                    
                    await addDoc(collection(db, "chargers"), {
                        vendorId: user.uid, name, rate, location, connectorType,
                        status: 'available', type: 'home', createdAt: serverTimestamp()
                    });
                    showMessage('Charger added successfully!', 3000, 'success');
                    document.getElementById('home-charger-form').reset();
                    showSection('find-chargers');
                    setTimeout(() => {
                        if (mainMap) {
                           mainMap.setCenter({ lat: location.latitude, lng: location.longitude });
                           mainMap.setZoom(15);
                        }
                        showMessage("Your charger is now pinned on the map!", 4000, 'info');
                    }, 200);

                } catch (error) { showMessage(`Could not add charger. ${error.message}`, 5000, 'error'); return; }

            } else {
                name = document.getElementById('charger-name').value;
                rate = parseFloat(document.getElementById('charger-rate').value);
                connectorType = document.getElementById('connector-type-select').value;
                chargerType = document.getElementById('charger-type-select').value;
                const lat = parseFloat(document.getElementById('charger-lat').value);
                const lng = parseFloat(document.getElementById('charger-lng').value);
                if (!name || isNaN(rate) || !connectorType || !chargerType || isNaN(lat) || isNaN(lng)) {
                    showMessage('Please fill all franchise charger fields.', 3000, 'error'); return;
                }
                location = new GeoPoint(lat, lng);
                try {
                    await addDoc(collection(db, "chargers"), {
                        vendorId: user.uid, name, rate, location, connectorType, chargerType,
                        status: 'available', type: 'franchise', createdAt: serverTimestamp()
                    });
                    showMessage('Charger added successfully!', 3000, 'success');
                    document.getElementById('vendor-charger-form').reset();
                } catch (error) {
                     showMessage(`Error adding charger: ${error.message}`, 4000, 'error');
                }
            }
        };

        const listHomeCharger = () => addCharger(true);

        const deleteCharger = async (chargerId) => {
            if (!confirm("Are you sure you want to delete this charger? This action cannot be undone.")) return;
            try {
                await deleteDoc(doc(db, "chargers", chargerId));
                showMessage('Charger deleted successfully.', 3000, 'success');
            } catch (error) { showMessage(`Error deleting charger: ${error.message}`, 4000, 'error'); }
        };
        
        const setupVendorDashboard = async (uid) => {
            const chargersList = document.getElementById('vendor-chargers-list');
            const q = query(collection(db, "chargers"), where("vendorId", "==", uid), where("type", "==", "franchise"));
            
            onSnapshot(q, (snapshot) => {
                const vendorChargers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (chargersList) {
                    chargersList.innerHTML = vendorChargers.length === 0 ? `<p class="text-gray-500">No franchise chargers added yet.</p>` : '';
                    vendorChargers.forEach(charger => {
                        const item = document.createElement('div');
                        item.className = 'bg-white p-4 rounded-lg shadow-sm flex justify-between items-center';
                        item.innerHTML = `<div>
                                            <p class="font-semibold">${charger.name}</p>
                                            <p class="text-sm text-gray-600">${charger.rate} kW | ${charger.connectorType || 'N/A'} | ${charger.chargerType || 'N/A'} | <span class="font-bold ${charger.status === 'available' ? 'text-green-600' : 'text-red-600'}">${charger.status}</span></p>
                                          </div>
                                          <div class="flex gap-2 flex-wrap">
                                            <button onclick="openEditModal('${charger.id}', '${charger.name}', ${charger.rate}, '${charger.status}')" class="text-blue-500 hover:text-blue-700 font-semibold text-sm">Edit</button>
                                            <button onclick="locateChargerOnMap(${charger.location.latitude}, ${charger.location.longitude})" class="text-purple-500 hover:text-purple-700 font-semibold text-sm">Locate</button>
                                            <button onclick="deleteCharger('${charger.id}')" class="text-red-500 hover:text-red-700 font-semibold text-sm">Delete</button>
                                          </div>`;
                        chargersList.appendChild(item);
                    });
                }

                if (vendorMap) {
                    vendorChargerMarkers.forEach(marker => marker.setMap(null));
                    vendorChargerMarkers = [];
                    const bounds = new google.maps.LatLngBounds();
                    vendorChargers.forEach(charger => {
                        if (!charger.location) return;
                        const pos = { lat: charger.location.latitude, lng: charger.location.longitude };
                        const marker = new google.maps.Marker({
                            position: pos,
                            map: vendorMap,
                            title: charger.name
                        });
                        vendorChargerMarkers.push(marker);
                        bounds.extend(pos);
                    });
                    if (!snapshot.empty) {
                        vendorMap.fitBounds(bounds);
                    }
                }
            });

            const ctx = document.getElementById('chargingChart')?.getContext('2d');
            if (ctx) {
                if(chargingChart) chargingChart.destroy();
                chargingChart = new Chart(ctx, { 
                    type: 'line', 
                    data: { 
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], 
                        datasets: [{ 
                            label: 'Earnings (₹)', 
                            data: [6500, 7200, 8100, 7800, 9000, 9500], 
                            borderColor: '#4f46e5', 
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.4 
                        }] 
                    } 
                });
            }

            const vendorQuery = query(collection(db, "vendors"), where("uid", "==", uid));
            const vendorSnapshot = await getDocs(vendorQuery);
            if (!vendorSnapshot.empty) {
                const vendorData = vendorSnapshot.docs[0].data();
                if (vendorData.hasSetPin) {
                    document.getElementById('set-pin-form').style.display = 'none';
                    document.getElementById('change-pin-form').style.display = 'block';
                } else {
                    document.getElementById('set-pin-form').style.display = 'block';
                    document.getElementById('change-pin-form').style.display = 'none';
                    showMessage("Welcome! Please set your custom PIN for future logins.", 5000, 'info');
                    showSection('dashboard');
                    showVendorTab('vendor-settings');
                }
            }
        };

        const fetchChargersForRoute = async (route) => {
            const states = await getStatesFromRoute(route.overview_path);
            if (states.size === 0) {
                showMessage("Could not determine states for the selected route. Fetching nearby chargers instead.", 4000, 'error');
                const allChargersSnapshot = await getDocs(query(collection(db, "chargers")));
                return allChargersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }
            showMessage(`Fetching chargers in ${[...states].join(', ')}...`, 4000, 'info');

            const localChargersSnapshot = await getDocs(query(collection(db, "chargers")));
            const localChargers = localChargersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const ocmUrl = `https://api.openchargemap.io/v3/poi/?output=json&countrycode=IN&maxresults=5000&key=${openChargeMapApiKey}`;
            
            let ocmChargers = [];
            try {
                const response = await fetch(ocmUrl); // Direct API call, no proxy
                if (!response.ok) throw new Error(`Open Charge Map API error: ${response.statusText}`);
                const data = await response.json();
                
                const ocmChargersInRelevantStates = data.filter(charger => {
                    const chargerState = charger.AddressInfo?.StateOrProvince;
                    return chargerState && states.has(chargerState.toLowerCase());
                });

                ocmChargers = ocmChargersInRelevantStates.map(item => ({
                    id: `ocm-${item.ID}`,
                    name: item.AddressInfo.Title,
                    AddressInfo: item.AddressInfo,
                    Connections: item.Connections,
                    IsPrivate: item.IsPrivate,
                    location: {
                        latitude: item.AddressInfo.Latitude,
                        longitude: item.AddressInfo.Longitude
                    },
                    rate: item.Connections?.[0]?.PowerKW,
                    status: 'available',
                    type: 'ocm'
                })).filter(c => c.location.latitude && c.location.longitude);

            } catch (error) {
                console.error("Error fetching Open Charge Map data:", error);
                showMessage("Failed to load global chargers from Open Charge Map. Showing local chargers only.", 5000, 'error');
            }

            const mergedChargers = [...ocmChargers, ...localChargers];
            const uniqueChargerIds = new Set();
            return mergedChargers.filter(charger => {
                const isDuplicate = uniqueChargerIds.has(charger.id);
                uniqueChargerIds.add(charger.id);
                return !isDuplicate;
            });
        };

        const getStatesFromRoute = async (path) => {
            const states = new Set();
            const sampleIndices = [
                0,
                Math.floor(path.length * 0.25),
                Math.floor(path.length * 0.5),
                Math.floor(path.length * 0.75),
                path.length - 1
            ];
            
            const geocodePromises = sampleIndices.map(index => {
                return new Promise(resolve => {
                    geocoder.geocode({ 'location': path[index] }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            for (const component of results[0].address_components) {
                                if (component.types.includes('administrative_area_level_1')) {
                                    states.add(component.long_name.toLowerCase());
                                    break;
                                }
                            }
                        }
                        resolve();
                    });
                });
            });

            await Promise.all(geocodePromises);
            return states;
        };

        
        const findAlternativeRoutes = async () => {
            if (currentRoute.isPlanning) {
                showMessage("A route is already being planned.", 2000, 'info');
                return;
            }
            const start = document.getElementById('route-start').value;
            const end = document.getElementById('route-end').value;
            const vehicleId = document.getElementById('vehicle-select').value;
            if (!start || !end || !vehicleId) {
                showMessage("Please fill all fields.", 3000, 'error'); return;
            }

            clearAlternativeRoutes();
            chargerMarkers.forEach(m => m.setMap(null));
            chargerMarkers = [];
            
            const request = {
                origin: start,
                destination: end,
                travelMode: 'DRIVING',
                provideRouteAlternatives: waypoints.length === 0,
                waypoints: waypoints.map(wp => ({ location: wp, stopover: true })),
                drivingOptions: {
                    departureTime: new Date(),
                    trafficModel: 'bestguess'
                }
            };

            directionsService.route(request, (response, status) => {
                if (status === 'OK') {
                    currentRoute.alternativeRoutesResponse = response;
                    displayAlternativeRoutes(response);
                } else {
                    showMessage(`Could not find routes: ${status}`, 4000, 'error');
                }
            });
        };

        const displayAlternativeRoutes = (response) => {
            const routeDetailsEl = document.getElementById('route-details');
            let html = `<h3 class="text-xl font-bold mb-3 text-gray-800">Please select your preferred route:</h3><div class="space-y-3">`;

            const colors = ['#4f46e5', '#16a34a', '#ca8a04'];

            response.routes.forEach((route, index) => {
                let totalDurationInTraffic = 0;
                let totalDistance = 0;

                route.legs.forEach(leg => {
                    totalDistance += leg.distance.value;
                    totalDurationInTraffic += leg.duration_in_traffic ? leg.duration_in_traffic.value : leg.duration.value;
                });

                const durationText = formatDuration(totalDurationInTraffic) + " (with traffic)";
                const distanceText = (totalDistance / 1000).toFixed(1) + " km";

                html += `
                    <div id="route-option-${index}" class="route-option p-4 border-2 rounded-lg cursor-pointer bg-white shadow-sm" onclick="selectRouteForPlanning(${index})">
                        <p class="font-bold text-lg text-indigo-700">Route ${index + 1} <span class="text-gray-600 font-medium text-base">(${route.summary || 'Main Route'})</span></p>
                        <div class="flex justify-between text-sm mt-1">
                            <span>${distanceText}</span>
                            <span>${durationText}</span>
                        </div>
                    </div>
                `;

                const routeRenderer = new google.maps.DirectionsRenderer({
                    map: mainMap,
                    directions: response,
                    routeIndex: index,
                    suppressMarkers: true,
                    polylineOptions: {
                        strokeColor: colors[index % colors.length],
                        strokeWeight: 6,
                        strokeOpacity: index === 0 ? 0.9 : 0.6
                    }
                });
                alternativeRouteRenderers.push(routeRenderer);
            });

            html += `</div><button id="plan-stops-btn" onclick="startStopPlanning()" class="mt-4 w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors hidden">Plan Charging Stops for Selected Route</button>`;
            routeDetailsEl.innerHTML = html;
            routeDetailsEl.classList.remove('hidden');

            if (response.routes.length === 1) {
                selectRouteForPlanning(0);
            }
        };
        
        const selectRouteForPlanning = (routeIndex) => {
            currentRoute.selectedRouteIndex = routeIndex;
            
            document.querySelectorAll('.route-option').forEach(el => el.classList.remove('selected-route'));
            document.getElementById(`route-option-${routeIndex}`).classList.add('selected-route');

            document.getElementById('plan-stops-btn').classList.remove('hidden');

            alternativeRouteRenderers.forEach((renderer, index) => {
                renderer.setOptions({
                    polylineOptions: {
                        strokeOpacity: index === routeIndex ? 0.9 : 0.3,
                        strokeWeight: index === routeIndex ? 8 : 6
                    }
                });
            });
        };

        const startStopPlanning = async () => {
            if (currentRoute.selectedRouteIndex === null) {
                showMessage("Please select a route first.", 3000, 'error'); return;
            }
            if (currentRoute.isPlanning) return;

            const selectedVehicle = userVehicles.find(v => v.id === document.getElementById('vehicle-select').value);
            if (!selectedVehicle) {
                showMessage("Vehicle not found.", 3000, 'error'); return;
            }

            currentRoute.isPlanning = true;
            document.getElementById('route-details').innerHTML = `<div class="text-center p-4"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div><p>Analyzing route with live traffic...</p></div>`;

            try {
                const selectedRoute = currentRoute.alternativeRoutesResponse.routes[currentRoute.selectedRouteIndex];
                
                const startLocation = selectedRoute.legs[0].start_location;
                const endLocation = selectedRoute.legs[selectedRoute.legs.length - 1].end_location;

                const geocodePromises = waypoints.map(wp => {
                    return new Promise((resolve, reject) => {
                        geocoder.geocode({ address: wp }, (results, status) => {
                            if (status === 'OK') {
                                resolve(results[0].geometry.location);
                            } else {
                                reject(`Geocode failed for waypoint "${wp}": ${status}`);
                            }
                        });
                    });
                });
                const geocodedWaypoints = await Promise.all(geocodePromises);

                currentRoute.vehicle = selectedVehicle;
                currentRoute.plannedWaypoints = [];
                currentRoute.navigationDirections = null;
                currentRoute.currentCharge = parseInt(document.getElementById('start-charge').value, 10);

                const majorPoints = [startLocation, ...geocodedWaypoints, endLocation];
                let allPlannedStops = [];
                const blacklistedChargerIds = new Set(); 

                for (let i = 0; i < majorPoints.length - 1; i++) {
                    const segmentStart = majorPoints[i];
                    const segmentEnd = majorPoints[i + 1];
                    
                    showMessage(`Planning stops between ${await getAddress(segmentStart)} and ${await getAddress(segmentEnd)}...`, 4000, 'info');

                    const segmentStops = await planSegment(segmentStart, segmentEnd, blacklistedChargerIds);
                    if (segmentStops === null) {
                        throw new Error(`Could not find a valid charging path for the segment ending at ${await getAddress(segmentEnd)}.`);
                    }
                    allPlannedStops.push(...segmentStops);
                }

                currentRoute.plannedWaypoints = allPlannedStops;
                
                clearSegmentRenderers();
                const finalWaypoints = allPlannedStops.map(wp => ({ location: new google.maps.LatLng(wp.location.latitude, wp.location.longitude), stopover: true }));
                
                const finalRequest = buildFinalRequest(startLocation, endLocation, geocodedWaypoints, finalWaypoints);

                directionsService.route(finalRequest, (finalResult, finalStatus) => {
                    if (finalStatus === 'OK') {
                        currentRoute.navigationDirections = finalResult;
                        displayRouteInfo(finalResult.routes[0].legs, allPlannedStops, selectedVehicle, finalResult);
                        showMessage("Route planning complete!", 3000, 'success');
                    } else {
                        showMessage(`Failed to assemble final route: ${finalStatus}`, 4000, 'error');
                    }
                    currentRoute.isPlanning = false;
                });

            } catch (error) {
                showMessage(`Error: ${error.message}`, 5000, 'error');
                currentRoute.isPlanning = false;
                 document.getElementById('route-details').innerHTML = `<p class="text-red-500 p-4">Route planning failed. Please try again.</p>`;
            }
        };

        // === Unified EV Route Planner Patch ===
        const routeOnce = (req) => new Promise(r => directionsService.route(req, (res, stat) => r({ res, stat })));

        function estimateKwhPerKm(leg) {
            const BASE = 0.18;
            const dur = (leg.duration_in_traffic ? leg.duration_in_traffic.value : leg.duration.value) || 0;
            const distKm = (leg.distance?.value || 0) / 1000;
            if (!dur || !distKm) return BASE;
            const avgSpeedKph = distKm / (dur / 3600);
            const trafficFactor = (leg.duration_in_traffic && leg.duration) ? (leg.duration_in_traffic.value / Math.max(1, leg.duration.value)) : 1;
            let speedAdj = 1.03;
            if (avgSpeedKph < 40) speedAdj = 1.10;
            else if (avgSpeedKph > 90) speedAdj = 1.05;
            return BASE * trafficFactor * speedAdj;
        }

        function kwhToPercent(vehicle, kwh) { return (kwh / vehicle.batteryCapacity) * 100; }
        function percentToKwh(vehicle, pct) { return (pct / 100) * vehicle.batteryCapacity; }

        function estimateChargeTimeSeconds(powerKw, energyKwh) {
            if (!powerKw || powerKw <= 0) powerKw = 11;
            return (energyKwh / powerKw) * 3600;
        }

        function isCompatible(vehicle, charger) {
            if (!vehicle.supportedPlugs || vehicle.supportedPlugs.length === 0) return true;
            const vehiclePlugs = vehicle.supportedPlugs.map(p => p.toUpperCase().trim());

            if (charger.Connections && Array.isArray(charger.Connections)) {
                return charger.Connections.some(conn => {
                    if (!conn.ConnectionType || !conn.ConnectionType.Title) return false;
                    const chargerPlug = conn.ConnectionType.Title.toUpperCase();
                    if (vehiclePlugs.includes('CCS2') && chargerPlug.includes('CCS')) return true;
                    if (vehiclePlugs.includes('CHADEMO') && chargerPlug.includes('CHADEMO')) return true;
                    if (vehiclePlugs.includes('TYPE 2') && chargerPlug.includes('TYPE 2')) return true;
                    if (vehiclePlugs.includes('GB/T') && chargerPlug.includes('GB/T')) return true;
                    return false;
                });
            }
            
            if (charger.connectorType) {
                const localPlug = charger.connectorType.toUpperCase().trim();
                return vehiclePlugs.includes(localPlug);
            }

            return false;
        }

        async function scoreChargerOption({ currentLegOrigin, charger, segmentEnd, vehicle, currentChargePct, kwhPerKm, targetArrivalPct }) {
            const chargerLoc = new google.maps.LatLng(charger.location.latitude, charger.location.longitude);

            const toCharger = await routeOnce({ origin: currentLegOrigin, destination: chargerLoc, travelMode: 'DRIVING', drivingOptions: { departureTime: new Date(), trafficModel: 'bestguess' } });
            if (toCharger.stat !== 'OK') return null;
            const legToCharger = toCharger.res.routes[0].legs[0];
            const distToChargerKm = legToCharger.distance.value / 1000;
            const timeToChargerSec = (legToCharger.duration_in_traffic ? legToCharger.duration_in_traffic.value : legToCharger.duration.value);

            const arrivalPct = currentChargePct - kwhToPercent(vehicle, distToChargerKm * kwhPerKm);
            if (arrivalPct <= 0) return null;

            const toEnd = await routeOnce({ origin: chargerLoc, destination: segmentEnd, travelMode: 'DRIVING', drivingOptions: { departureTime: new Date(), trafficModel: 'bestguess' } });
            if (toEnd.stat !== 'OK') return null;
            const legToEnd = toEnd.res.routes[0].legs[0];
            const distFromChargerToEndKm = legToEnd.distance.value / 1000;
            const timeFromChargerToEndSec = (legToEnd.duration_in_traffic ? legToEnd.duration_in_traffic.value : legToEnd.duration.value);

            const energyNeededKwh = distFromChargerToEndKm * kwhPerKm + percentToKwh(vehicle, targetArrivalPct);
            const haveKwhAtArrival = percentToKwh(vehicle, Math.max(arrivalPct, 0));
            const deltaKwh = Math.max(0, energyNeededKwh - haveKwhAtArrival);
            const chargeTimeSec = estimateChargeTimeSeconds(charger.rate || charger.Connections?.[0]?.PowerKW || 11, deltaKwh);

            const totalAddedSec = timeToChargerSec + chargeTimeSec + timeFromChargerToEndSec;
            return { charger, arrivalPct, chargeNeededKwh: deltaKwh, totalAddedSec, toChargerRoute: toCharger.res };
        }

        const planSegment = (segmentStart, segmentEnd, blacklistedChargerIds) => new Promise(async (resolve) => {
            const segmentWaypoints = [];
            let currentLegOrigin = segmentStart;
            let iter = 0;
            const MAX_ITER = 24;

            while (iter++ < MAX_ITER) {
                const baseRes = await routeOnce({ origin: currentLegOrigin, destination: segmentEnd, travelMode: 'DRIVING', drivingOptions: { departureTime: new Date(), trafficModel: 'bestguess' } });
                if (baseRes.stat !== 'OK') { resolve(null); return; }

                const leg = baseRes.res.routes[0].legs[0];
                const vehicle = currentRoute.vehicle;
                const kwhPerKm = estimateKwhPerKm(leg);
                const totalRangeKm = vehicle.batteryCapacity / kwhPerKm;
                const distanceToCoverKm = leg.distance.value / 1000;

                const requiredEndPct = parseInt(document.getElementById('end-charge').value, 10) || 0;
                const neededKwhNow = distanceToCoverKm * kwhPerKm + percentToKwh(vehicle, requiredEndPct);
                const haveKwhNow = percentToKwh(vehicle, currentRoute.currentCharge);

                if (haveKwhNow >= neededKwhNow) {
                    const chargeUsedPct = kwhToPercent(vehicle, distanceToCoverKm * kwhPerKm);
                    currentRoute.currentCharge = Math.max(0, currentRoute.currentCharge - chargeUsedPct);
                    resolve(segmentWaypoints); return;
                }

                const segmentChargers = await fetchChargersForRoute(baseRes.res.routes[0]);
                const safetyPct = 12;
                const maxReachKm = totalRangeKm * ((currentRoute.currentCharge - safetyPct) / 100);
                
                const prelim = segmentChargers.filter(c => {
                    return !blacklistedChargerIds.has(c.id) && c.location && c.status === 'available' && isCompatible(vehicle, c);
                });

                let best = null;
                for (let i = 0; i < prelim.length; i += 6) {
                    const batch = prelim.slice(i, i + 6);
                    const scored = await Promise.all(batch.map(c => scoreChargerOption({ currentLegOrigin, charger: c, segmentEnd, vehicle, currentChargePct: currentRoute.currentCharge, kwhPerKm, targetArrivalPct: requiredEndPct })));
                    for (const s of scored) {
                        if (!s) continue;
                        const straightKm = google.maps.geometry.spherical.computeDistanceBetween(currentLegOrigin, new google.maps.LatLng(s.charger.location.latitude, s.charger.location.longitude)) / 1000;
                        if (straightKm > maxReachKm) continue;
                        if (!best || s.totalAddedSec < best.totalAddedSec) best = s;
                    }
                    if (best) break; 
                }

                if (!best) { resolve(null); return; }
                
                blacklistedChargerIds.add(best.charger.id);
                best.charger.arrivalCharge = best.arrivalPct;
                best.charger.chargeNeededKwh = best.chargeNeededKwh;

                segmentWaypoints.push(best.charger);
                currentLegOrigin = new google.maps.LatLng(best.charger.location.latitude, best.charger.location.longitude);

                const distToChargerKm = best.toChargerRoute.routes[0].legs[0].distance.value / 1000;
                const usedPctToCharger = kwhToPercent(vehicle, distToChargerKm * kwhPerKm);
                const socAtArrival = Math.max(0, currentRoute.currentCharge - usedPctToCharger);
                const deltaPct = kwhToPercent(vehicle, best.chargeNeededKwh);
                currentRoute.currentCharge = Math.min(100, socAtArrival + deltaPct);
            }
            resolve(null);
        });

        function buildFinalRequest(startLocation, endLocation, geocodedWaypoints, finalWaypoints) {
            const allWaypoints = [
                ...geocodedWaypoints.map(wp => ({ location: wp, stopover: true })),
                ...finalWaypoints
            ];
            return {
                origin: startLocation,
                destination: endLocation,
                waypoints: allWaypoints,
                travelMode: 'DRIVING',
                optimizeWaypoints: false,
                drivingOptions: { departureTime: new Date(), trafficModel: 'bestguess' }
            };
        }
        // === End of Patch ===

        const getAddress = (latLng) => {
            return new Promise(resolve => {
                geocoder.geocode({ 'location': latLng }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        resolve(results[0].formatted_address.split(',').slice(0, 2).join(', '));
                    } else {
                        resolve("Unknown Location");
                    }
                });
            });
        };

        const checkVendorApplicationStatus = async (uid) => {
            const statusContainer = document.getElementById('vendor-application-status');
            const q = query(collection(db, "vendor_requests"), where("userId", "==", uid));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const appData = querySnapshot.docs[0].data();
                 if (appData.status === 'pending') {
                    statusContainer.innerHTML = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                        <p class="font-bold">Verification Pending</p>
                        <p>Your application to become a vendor is currently under review by an executive.</p>
                    </div>`;
                } else if (appData.status === 'approved') {
                     statusContainer.innerHTML = `<div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4" role="alert">
                        <p class="font-bold">Application Approved!</p>
                        <p>Congratulations! Please check your email for your temporary key and log in through the Vendor Portal.</p>
                    </div>`;
                }
            } else {
                statusContainer.innerHTML = `
                    <p class="mb-6 text-gray-600">To become a vendor, please submit a request for verification.</p>
                    <div class="space-y-4" id="vendor-application-form">
                        <input type="text" id="vendor-name" placeholder="Your Full Name or Business Name" class="w-full p-3 border rounded-lg form-field">
                        <button onclick="submitVendorApplication()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">Submit Request</button>
                    </div>
                `;
            }
        };

        const submitVendorApplication = async () => {
            const user = auth.currentUser;
            if (!user) { showMessage("You must be logged in.", 3000, 'error'); return; }

            const vendorName = document.getElementById('vendor-name').value;
            if (!vendorName) {
                showMessage("Please enter your name or business name.", 3000, 'error');
                return;
            }

            try {
                await addDoc(collection(db, "vendor_requests"), {
                    userId: user.uid,
                    email: user.email,
                    name: vendorName,
                    status: 'pending',
                    submittedAt: serverTimestamp()
                });

                showMessage("Request submitted successfully! Your request is under review.", 5000, 'success');
                checkVendorApplicationStatus(user.uid);
            } catch (error) {
                showMessage(`Request failed: ${error.message}`, 5000, 'error');
            }
        };
        
        const findNearbyPlaces = (charger) => {
            const nearbyPlacesContainer = document.getElementById('nearby-places');
            nearbyPlacesContainer.innerHTML = `<div class="text-center p-4"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div><p class="mt-2 font-semibold text-gray-700">Searching for nearby places...</p></div>`;
            nearbyPlacesContainer.classList.remove('hidden');

            const location = new google.maps.LatLng(charger.location.latitude, charger.location.longitude);

            const placeTypes = [
                { title: 'Restaurants', type: 'restaurant' },
                { title: 'Cafes', type: 'cafe' },
                { title: 'Hotels', type: 'lodging' },
                { title: 'Attractions', type: 'tourist_attraction' }
            ];

            const searchPromises = placeTypes.map(placeType => {
                return new Promise((resolve) => {
                    const request = {
                        location: location,
                        radius: '2000', // 2km radius
                        type: [placeType.type]
                    };
                    placesService.nearbySearch(request, (results, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                            resolve({ title: placeType.title, places: results });
                        } else {
                            resolve({ title: placeType.title, places: [] });
                        }
                    });
                });
            });

            Promise.all(searchPromises).then(results => {
                let allResultsHTML = '';
                let hasResults = false;
                results.forEach(category => {
                    if (category.places.length > 0) {
                        hasResults = true;
                        let html = `<h4 class="font-bold text-lg mt-4 mb-2">${category.title} Nearby</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-2">`;
                        category.places.slice(0, 4).forEach(place => {
                            const placeName = place.name.replace(/'/g, "\\'");
                            const placeVicinity = (place.vicinity || '').replace(/'/g, "\\'");
                            html += `<div class="bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-indigo-50" onclick="selectNearbyPlace('${placeName}', '${placeVicinity}')">
                                <p class="font-semibold text-sm">${place.name}</p>
                                <p class="text-xs text-gray-500">${place.vicinity || 'Address not available'}</p>
                                ${place.rating ? `<p class="text-xs text-yellow-500 font-bold">⭐ ${place.rating}</p>` : ''}
                            </div>`;
                        });
                        html += `</div>`;
                        allResultsHTML += html;
                    }
                });

                if (hasResults) {
                    nearbyPlacesContainer.innerHTML = allResultsHTML;
                } else {
                    nearbyPlacesContainer.innerHTML = `<p class="text-gray-600">No popular places found within 2km of the charger.</p>`;
                }
            });
        };


        const selectNearbyPlace = (name, vicinity) => {
            currentRoute.selectedPlace = { name, vicinity };
            showMessage(`'${name}' selected for your stop. This will be shown during live navigation.`, 4000, 'success');
        };

        const locateMe = (mapId) => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    let targetMap;
                    let targetInput;
                    if (mapId === 'route-start') {
                        targetMap = mainMap;
                        targetInput = document.getElementById('route-start');
                    } else if (mapId === 'near-me-map') {
                        targetMap = nearMeMap;
                        
                        if (nearMeUserMarker) {
                            nearMeUserMarker.setMap(null);
                        }
                        nearMeUserMarker = new google.maps.Marker({
                            position: pos,
                            map: targetMap,
                            title: 'Your Location',
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 8,
                                fillColor: '#4285F4',
                                fillOpacity: 1,
                                strokeWeight: 2,
                                strokeColor: 'white'
                            }
                        });
                    }

                    if (targetMap) {
                        targetMap.setCenter(pos);
                        targetMap.setZoom(12);
                    }

                    if (targetInput) {
                        geocoder.geocode({ location: pos }, (results, status) => {
                            if (status === 'OK' && results[0]) {
                                targetInput.value = results[0].formatted_address;
                            } else {
                                showMessage("Could not determine address from your location.", 3000, 'error');
                            }
                        });
                    }
                }, () => {
                    showMessage("Geolocation failed. Please enable location services.", 4000, 'error');
                });
            } else {
                showMessage("Your browser does not support geolocation.", 4000, 'error');
            }
        };

        const navigateToCharger = (lat, lng) => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const start = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    const end = { lat, lng };

                    const request = {
                        origin: start,
                        destination: end,
                        travelMode: 'DRIVING'
                    };

                    directionsService.route(request, (result, status) => {
                        if (status === 'OK') {
                            currentRoute.navigationDirections = result;
                            startInAppNavigation();
                        } else {
                            showMessage("Could not calculate route to this charger.", 3000, 'error');
                        }
                    });

                }, () => showMessage("Could not get your current location to start navigation.", 3000, 'error'));
            } else {
                showMessage("Geolocation is not supported by your browser.", 4000, 'error');
            }
        };
        
        const initUserMap = () => {
             if (mainMap) return;
             const defaultLocation = { lat: 19.0760, lng: 72.8777 }; // Mumbai
             mainMap = new google.maps.Map(document.getElementById("map"), {
                 zoom: 10,
                 center: defaultLocation,
                 mapTypeControl: false,
                 mapTypeId: google.maps.MapTypeId.TERRAIN
             });
             directionsService = new google.maps.DirectionsService();
             geocoder = new google.maps.Geocoder();
             placesService = new google.maps.places.PlacesService(mainMap);
             const startInput = document.getElementById('route-start');
             const endInput = document.getElementById('route-end');
             const waypointInput = document.getElementById('waypoint-input');
             if (startInput) new google.maps.places.Autocomplete(startInput);
             if (endInput) new google.maps.places.Autocomplete(endInput);
             if (waypointInput) new google.maps.places.Autocomplete(waypointInput);

             document.getElementById('start-charge').addEventListener('input', (e) => { document.getElementById('start-charge-value').textContent = e.target.value; });
             document.getElementById('end-charge').addEventListener('input', (e) => { document.getElementById('end-charge-value').textContent = e.target.value; });
             document.getElementById('search-radius').addEventListener('input', (e) => { document.getElementById('search-radius-value').textContent = e.target.value; });
             document.getElementById('nearby-radius').addEventListener('input', (e) => { document.getElementById('nearby-radius-value').textContent = e.target.value; });
             setupEnterKeyNavigation();
             console.log("User Map Initialized");
        };
        
        const clearAlternativeRoutes = () => {
            alternativeRouteRenderers.forEach(renderer => renderer.setMap(null));
            alternativeRouteRenderers = [];
        };

        const clearSegmentRenderers = () => {
            segmentRenderers.forEach(renderer => renderer.setMap(null));
            segmentRenderers = [];
        };

        const addWaypoint = () => {
            const waypointInput = document.getElementById('waypoint-input');
            const location = waypointInput.value;
            if (location) {
                waypoints.push(location);
                waypointInput.value = '';
                renderWaypoints();
            }
        };

        const removeWaypoint = (index) => {
            waypoints.splice(index, 1);
            renderWaypoints();
        };

        const renderWaypoints = () => {
            const container = document.getElementById('waypoints-container');
            container.innerHTML = '';
            waypoints.forEach((wp, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-gray-200 p-2 rounded-lg';
                div.innerHTML = `<span class="text-sm">${wp}</span>
                                 <button onclick="removeWaypoint(${index})" class="text-red-500 font-bold text-lg">&times;</button>`;
                container.appendChild(div);
            });
        };


        const initChargersNearMeMap = () => {
            if (nearMeMap) return;
            const defaultLocation = { lat: 19.0760, lng: 72.8777 }; // Mumbai
            nearMeMap = new google.maps.Map(document.getElementById("chargers-near-me-map"), {
                 zoom: 10,
                 center: defaultLocation,
                 mapTypeControl: false,
                 mapTypeId: google.maps.MapTypeId.TERRAIN
            });
            console.log("Chargers Near Me Map Initialized");
        };

        const initVendorMap = () => {
            if (vendorMap || !document.getElementById('vendor-map')) return;
            const defaultLocation = { lat: 19.0760, lng: 72.8777 }; // Mumbai
            vendorMap = new google.maps.Map(document.getElementById("vendor-map"), {
                zoom: 5,
                center: defaultLocation,
                mapTypeControl: false,
            });
            console.log("Vendor Map Initialized");
        };

        const showVendorTab = (tabId) => {
            document.querySelectorAll('.vendor-tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.vendor-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId)?.classList.add('active');
            document.querySelector(`.vendor-tab[onclick*="'${tabId}'"]`)?.classList.add('active');
            if (tabId === 'my-vmap') {
                if (!vendorMap) {
                    initVendorMap();
                }
                setTimeout(() => {
                    const center = vendorMap.getCenter();
                    google.maps.event.trigger(vendorMap, 'resize');
                    if (center) vendorMap.setCenter(center);
                }, 100);
            }
        };

        const calculateROI = () => {
            const investment = parseFloat(document.getElementById('investment').value);
            const monthlyRevenue = parseFloat(document.getElementById('monthly-revenue').value);
            const resultDiv = document.getElementById('roi-result');
            if (isNaN(investment) || isNaN(monthlyRevenue) || investment <= 0) {
                showMessage("Please enter valid investment and revenue values.", 3000, 'error');
                return;
            }
            const annualRevenue = monthlyRevenue * 12;
            const profit = annualRevenue - investment;
            const roi = (profit / investment) * 100;
            resultDiv.innerHTML = `
                <p><strong>Annual Revenue:</strong> ₹${annualRevenue.toLocaleString('en-IN')}</p>
                <p><strong>Annual Profit:</strong> ₹${profit.toLocaleString('en-IN')}</p>
                <p class="text-2xl font-bold mt-2">Annual ROI: <span class="${roi >= 0 ? 'text-green-600' : 'text-red-600'}">${roi.toFixed(2)}%</span></p>
            `;
            resultDiv.classList.remove('hidden');
        };

        const locateChargerOnMap = (lat, lng) => {
            showVendorTab('my-vmap');
            if (vendorMap) {
                vendorMap.setCenter({ lat, lng });
                vendorMap.setZoom(15);
            }
        };

        const openEditModal = (id, name, rate, status) => {
            document.getElementById('edit-charger-id').value = id;
            document.getElementById('edit-charger-name').value = name;
            document.getElementById('edit-charger-rate').value = rate;
            document.getElementById('edit-charger-status').value = status;
            document.getElementById('edit-charger-modal').classList.remove('hidden');
        };

        const closeEditModal = () => {
            document.getElementById('edit-charger-modal').classList.add('hidden');
        };

        const updateCharger = async () => {
            const id = document.getElementById('edit-charger-id').value;
            const name = document.getElementById('edit-charger-name').value;
            const rate = parseFloat(document.getElementById('edit-charger-rate').value);
            const status = document.getElementById('edit-charger-status').value;
            if (!id || !name || isNaN(rate)) {
                showMessage("Invalid data.", 3000, 'error');
                return;
            }
            try {
                await updateDoc(doc(db, "chargers", id), { name, rate, status });
                showMessage("Charger updated successfully!", 3000, 'success');
                closeEditModal();
            } catch (error) {
                showMessage(`Error updating charger: ${error.message}`, 4000, 'error');
            }
        };

        const setCustomPin = async () => {
            const newPin = document.getElementById('new-pin').value;
            const confirmPin = document.getElementById('confirm-pin').value;
            const ocmApiKey = document.getElementById('ocm-api-key').value;

            if (newPin !== confirmPin) {
                showMessage("PINs do not match.", 3000, 'error');
                return;
            }
            if (newPin.length < 6) {
                showMessage("PIN must be at least 6 characters long.", 3000, 'error');
                return;
            }

            const user = auth.currentUser;
            if (!user) {
                showMessage("User not authenticated.", 3000, 'error');
                return;
            }

            try {
                await updatePassword(user, newPin);
                
                const vendorQuery = query(collection(db, "vendors"), where("uid", "==", user.uid));
                const vendorSnapshot = await getDocs(vendorQuery);
                if (!vendorSnapshot.empty) {
                    const vendorDocRef = vendorSnapshot.docs[0].ref;
                    await updateDoc(vendorDocRef, { hasSetPin: true, ocmApiKey: ocmApiKey });
                }
                
                showMessage("PIN set successfully! You can now use this for all future logins.", 4000, 'success');
                document.getElementById('set-pin-form').style.display = 'none';
                document.getElementById('change-pin-form').style.display = 'block';
            } catch (error) {
                showMessage(`Failed to set PIN: ${error.message}. You may need to log out and log back in with your temporary key.`, 6000, 'error');
            }
        };

        const changeCustomPin = async () => {
            const currentPin = document.getElementById('current-pin').value;
            const newPin = document.getElementById('change-new-pin').value;
            const confirmPin = document.getElementById('change-confirm-pin').value;

            if (newPin !== confirmPin) {
                showMessage("New PINs do not match.", 3000, 'error');
                return;
            }
            if (newPin.length < 6) {
                showMessage("New PIN must be at least 6 characters long.", 3000, 'error');
                return;
            }

            const user = auth.currentUser;
            if (!user) {
                showMessage("User not authenticated.", 3000, 'error');
                return;
            }

            try {
                const credential = EmailAuthProvider.credential(user.email, currentPin);
                await reauthenticateWithCredential(user, credential);
                
                await updatePassword(user, newPin);
                
                showMessage("PIN changed successfully!", 3000, 'success');
                document.getElementById('change-pin-form').reset();
            } catch (error) {
                showMessage(`Failed to change PIN: ${error.message}. Please ensure your current PIN is correct.`, 6000, 'error');
            }
        };

        const initializeMapsAfterLogin = () => {
            if (googleMapsLoaded) return;
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyCLrNaIQ1Eu-XpKws7J4MFbdxw01p0bEnc&libraries=places,geometry,drawing&callback=googleMapsApiLoaded`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        };
        
        const speak = (text) => {
            if (isMuted || !('speechSynthesis' in window)) return;
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            speechSynthesis.speak(utterance);
        };

        const toggleMute = () => {
            isMuted = !isMuted;
            if (isMuted) {
                speechSynthesis.cancel();
            }
            updateMuteButtonUI();
        };

        const updateMuteButtonUI = () => {
            const muteBtn = document.getElementById('mute-btn');
            if (!muteBtn) return;
            if (isMuted) {
                muteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" /><path stroke-linecap="round" stroke-linejoin="round" d="M17 14l2-2m0 0l2-2m-2 2l-2 2m2-2l2 2" /></svg>`;
            } else {
                muteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>`;
            }
        };

        window.googleMapsApiLoaded = () => {
            googleMapsLoaded = true;
            console.log("Google Maps API loaded.");
            initUserMap();
            initChargersNearMeMap();
        };

        Object.assign(window, {
            showMessage, hideMessage, showSection, toggleMobileMenu,
            showLogin, showSignUp, backToPortalChoice,
            signUp, login, googleLogin,
            logout: async () => { await signOut(auth); showMessage("Logged out successfully.", 3000, 'info'); },
            findAlternativeRoutes, 
            submitVehicle, deleteVehicle, addCharger, listHomeCharger, deleteCharger,
            submitVendorApplication, locateMe, showVendorTab, calculateROI, locateChargerOnMap,
            openEditModal, closeEditModal, updateCharger, setCustomPin, changeCustomPin,
            initUserMap, initChargersNearMeMap, initVendorMap, updateMapMarkers,
            startInAppNavigation, stopInAppNavigation,
            selectNearbyPlace,
            nextStep, previousStep, startNextLeg, navigateToCharger,
            selectRouteForPlanning, startStopPlanning,
            addWaypoint, removeWaypoint,
            toggleMute
        });

        onAuthStateChanged(auth, async (user) => {
            const authSection = document.getElementById('auth-section');
            const appContent = document.getElementById('app-content');
            if (user) {
                authSection.style.display = 'none';
                appContent.style.display = 'flex';
                document.getElementById('user-info').textContent = user.displayName || user.email;
                initializeMapsAfterLogin();
                
                let isVendor = false;
                const vendorQuery = query(collection(db, "vendors"), where("uid", "==", user.uid));
                const vendorSnapshot = await getDocs(vendorQuery);
                if (!vendorSnapshot.empty) {
                    isVendor = true;
                    const vendorData = vendorSnapshot.docs[0].data();
                    if (vendorData.ocmApiKey) {
                        openChargeMapApiKey = vendorData.ocmApiKey;
                    }
                }
                
                console.log(`User ${user.uid} logged in. Is vendor: ${isVendor}`);

                document.querySelectorAll('.user-only-nav').forEach(el => el.style.display = isVendor ? 'none' : 'block');
                document.querySelectorAll('.vendor-only-nav').forEach(el => el.style.display = isVendor ? 'block' : 'none');
                
                if (isVendor) {
                    showSection('dashboard');
                    setupVendorDashboard(user.uid);
                } else {
                    showSection('home');
                    loadUserVehicles(user.uid);
                    checkVendorApplicationStatus(user.uid);
                }
            } else {
                authSection.style.display = 'flex';
                appContent.style.display = 'none';
                renderAuthForms();
            }
        });
    </script>
</body>
</html>
