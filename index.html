<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChargeFranchise - EV Charging Platform</title>
    <!-- Tailwind CSS for styling. NOTE: For production, it's recommended to install Tailwind via NPM/CLI. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for data visualization (pinned version for stable sourcemaps) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --accent: #06b6d4;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] {
            --primary: #818cf8;
            --primary-dark: #6366f1;
            --secondary: #f472b6;
            --accent: #22d3ee;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
            --glass-bg: rgba(0, 0, 0, 0.1);
            --glass-border: rgba(255, 255, 255, 0.05);
        }

        [data-theme="cyberpunk"] {
            --primary: #ff0080;
            --primary-dark: #e6007a;
            --secondary: #00ffff;
            --accent: #ffff00;
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a0a1a;
            --bg-tertiary: #2a1a2a;
            --text-primary: #00ffff;
            --text-secondary: #ff0080;
            --text-muted: #808080;
            --border: #ff0080;
            --shadow: rgba(255, 0, 128, 0.3);
            --glass-bg: rgba(255, 0, 128, 0.05);
            --glass-border: rgba(255, 0, 128, 0.1);
        }

        [data-theme="ocean"] {
            --primary: #0891b2;
            --primary-dark: #0e7490;
            --secondary: #06b6d4;
            --accent: #67e8f9;
            --bg-primary: #f0f9ff;
            --bg-secondary: #e0f2fe;
            --bg-tertiary: #bae6fd;
            --text-primary: #0c4a6e;
            --text-secondary: #075985;
            --text-muted: #0369a1;
            --border: #7dd3fc;
            --shadow: rgba(14, 116, 144, 0.2);
            --glass-bg: rgba(6, 182, 212, 0.05);
            --glass-border: rgba(6, 182, 212, 0.1);
        }

        * { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            background-attachment: fixed;
        }

        /* Glass Morphism Effects */
        .glass {
            background: rgba(255, 255, 255, 0.01);
            backdrop-filter: blur(4px) saturate(110%);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            box-shadow: 0 8px 32px var(--shadow);
            color: var(--text-primary);
            position: relative;
            z-index: 2;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.01);
            backdrop-filter: blur(4px) saturate(110%);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            box-shadow: 0 8px 32px var(--shadow);
            color: var(--text-primary);
            position: relative;
            z-index: 2;
        }
        
        /* Enhanced frosted glass for panels */
        .frosted-panel {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(6px) saturate(120%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            box-shadow: 0 12px 40px var(--shadow);
            color: var(--text-primary);
            position: relative;
            z-index: 2;
        }
        
        /* Frosted glass for cards */
        .frosted-card {
            background: rgba(255, 255, 255, 0.01);
            backdrop-filter: blur(4px) saturate(110%);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            box-shadow: 0 6px 28px var(--shadow);
            color: var(--text-primary);
            position: relative;
            z-index: 2;
        }

        /* Animated Background */
        .animated-bg { 
            position: relative; 
            overflow-x: hidden; 
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            background-attachment: fixed;
        }
        .animated-bg::before {
            content: '';
            position: absolute; 
            inset: 0;
            background:
                radial-gradient(circle at 20% 80%, var(--primary) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, var(--secondary) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, var(--accent) 0%, transparent 50%);
            opacity: 0.1; 
            animation: backgroundShift 20s ease-in-out infinite; 
            pointer-events: none; 
            z-index: 0;
        }
        .animated-bg::after {
            content: '';
            position: absolute;
            inset: 0;
            background: 
                linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%),
                linear-gradient(-45deg, transparent 30%, rgba(255,255,255,0.05) 50%, transparent 70%);
            animation: shimmer 8s ease-in-out infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        /* Additional dynamic background elements */
        .animated-bg .bg-orb {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, var(--primary), transparent);
            animation: orbFloat 15s infinite linear;
            pointer-events: none;
            z-index: -1;
        }
        
        .animated-bg .bg-orb:nth-child(1) {
            width: 200px;
            height: 200px;
            top: 10%;
            left: 10%;
            animation-delay: 0s;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.4), transparent);
        }
        
        .animated-bg .bg-orb:nth-child(2) {
            width: 150px;
            height: 150px;
            top: 60%;
            right: 15%;
            animation-delay: -5s;
            background: radial-gradient(circle, rgba(236, 72, 153, 0.4), transparent);
        }
        
        .animated-bg .bg-orb:nth-child(3) {
            width: 100px;
            height: 100px;
            top: 30%;
            right: 30%;
            animation-delay: -10s;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.4), transparent);
        }
        
        .animated-bg .bg-orb:nth-child(4) {
            width: 120px;
            height: 120px;
            bottom: 20%;
            left: 20%;
            animation-delay: -7s;
            background: radial-gradient(circle, rgba(245, 158, 11, 0.4), transparent);
        }
        
        @keyframes orbFloat {
            0%, 100% {
                transform: translateY(0px) translateX(0px) scale(1);
                opacity: 0.5;
            }
            25% {
                transform: translateY(-20px) translateX(10px) scale(1.1);
                opacity: 0.7;
            }
            50% {
                transform: translateY(-10px) translateX(-15px) scale(0.9);
                opacity: 0.6;
            }
            75% {
                transform: translateY(-30px) translateX(5px) scale(1.05);
                opacity: 0.8;
            }
        }
        @keyframes backgroundShift {
            0%, 100% { 
                opacity: 0.1; 
                transform: scale(1) rotate(0deg) translateX(0); 
            }
            25% { 
                opacity: 0.2; 
                transform: scale(1.1) rotate(90deg) translateX(10px); 
            }
            50% { 
                opacity: 0.15; 
                transform: scale(0.9) rotate(180deg) translateX(-5px); 
            }
            75% { 
                opacity: 0.25; 
                transform: scale(1.05) rotate(270deg) translateX(5px); 
            }
        }
        @keyframes shimmer {
            0%, 100% { 
                opacity: 0; 
                transform: translateX(-100%) translateY(-100%); 
            }
            50% { 
                opacity: 1; 
                transform: translateX(100%) translateY(100%); 
            }
        }
        
        /* Floating particles */
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--accent);
            border-radius: 50%;
            animation: floatParticle 15s infinite linear;
            opacity: 0.8;
            pointer-events: none;
            z-index: -1;
        }
        .particle:nth-child(odd) {
            animation-duration: 20s;
            animation-direction: reverse;
        }
        .particle:nth-child(3n) {
            animation-duration: 25s;
            background: var(--primary);
        }
        .particle:nth-child(4n) {
            animation-duration: 18s;
            background: var(--secondary);
        }
        @keyframes floatParticle {
            0% {
                transform: translateY(100vh) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.6;
            }
            90% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(-100px) translateX(100px) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* Interactive background elements */
        .interactive-bg {
            position: relative;
            overflow: hidden;
        }
        
        .interactive-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 25% 25%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(236, 72, 153, 0.1) 0%, transparent 50%);
            animation: pulse 4s ease-in-out infinite;
            pointer-events: none;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(1.05);
            }
        }
        
        /* Enhanced logout button styles */
        .logout-btn {
            position: relative;
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .logout-btn:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }
        
        .logout-btn:active {
            transform: scale(0.95);
        }
        
        /* Theme-synchronized button styles */
        .btn-primary {
            background: var(--primary) !important;
            color: white !important;
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark) !important;
            transform: scale(1.02);
        }
        
        .btn-secondary {
            background: var(--secondary) !important;
            color: white !important;
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: var(--secondary-dark) !important;
            transform: scale(1.02);
        }
        
        .btn-accent {
            background: var(--accent) !important;
            color: white !important;
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-accent:hover {
            background: var(--accent-dark) !important;
            transform: scale(1.02);
        }
        
        .btn-partner {
            background: linear-gradient(135deg, var(--primary), var(--secondary)) !important;
            color: white !important;
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-partner:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary-dark)) !important;
            transform: scale(1.02);
        }
        
        .btn-history {
            background: var(--accent) !important;
            color: white !important;
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-history:hover {
            background: var(--accent-dark) !important;
            transform: scale(1.02);
        }

        /* Neon Glow */
        .neon-glow {
            box-shadow: 0 0 5px var(--primary), 0 0 10px var(--primary), 0 0 15px var(--primary), 0 0 20px var(--primary);
            animation: neon-pulse 2s ease-in-out infinite alternate;
        }
        @keyframes neon-pulse {
            from { box-shadow: 0 0 5px var(--primary), 0 0 10px var(--primary), 0 0 15px var(--primary); }
            to { box-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary), 0 0 30px var(--primary); }
        }

        /* Buttons */
        .btn-modern {
            position: relative; overflow: hidden; background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            border: none; color: white; font-weight: 600; border-radius: 12px; padding: 12px 24px; cursor: pointer;
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-modern:hover { transform: translateY(-2px); box-shadow: 0 8px 25px var(--shadow); }
        .btn-modern::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .btn-modern:hover::before { left: 100%; }

        /* Inputs */
        .form-input { background: var(--bg-primary); border: 2px solid var(--border); border-radius: 12px; padding: 12px 16px; color: var(--text-primary); font-size: 16px; }
        .form-input::placeholder { color: var(--text-muted); opacity: 1; }
        .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99,102,241,0.1); transform: scale(1.02); }

        /* Ensure legacy form-field class inherits the new form-input look */
        .form-field { background: var(--bg-primary); border: 2px solid var(--border); border-radius: 12px; color: var(--text-primary); }
        .form-field::placeholder { color: var(--text-muted); opacity: 1; }
        select.form-field, select.form-input { color: var(--text-primary); }
        select.form-field option, select.form-input option { color: var(--text-primary); background: var(--bg-primary); }

        /* Cards */
        .feature-card { 
            background: rgba(99, 102, 241, 0.1); 
            border-radius: 20px; 
            padding: 24px; 
            border: 1px solid rgba(99, 102, 241, 0.2); 
            box-shadow: 0 4px 24px var(--shadow); 
            position: relative; 
            overflow: hidden; 
            transition: all 0.3s ease;
        }
        .feature-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent)); }
        .feature-card:hover { 
            transform: translateY(-8px) scale(1.02); 
            box-shadow: 0 12px 40px var(--shadow); 
            background: rgba(99, 102, 241, 0.15);
            border-color: rgba(99, 102, 241, 0.3);
        }
        
        /* Dynamic colored cards */
        .feature-card:nth-child(1) { background: rgba(99, 102, 241, 0.1); border-color: rgba(99, 102, 241, 0.2); }
        .feature-card:nth-child(1):hover { background: rgba(99, 102, 241, 0.15); border-color: rgba(99, 102, 241, 0.3); }
        
        .feature-card:nth-child(2) { background: rgba(236, 72, 153, 0.1); border-color: rgba(236, 72, 153, 0.2); }
        .feature-card:nth-child(2):hover { background: rgba(236, 72, 153, 0.15); border-color: rgba(236, 72, 153, 0.3); }
        
        .feature-card:nth-child(3) { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.2); }
        .feature-card:nth-child(3):hover { background: rgba(16, 185, 129, 0.15); border-color: rgba(16, 185, 129, 0.3); }
        
        .feature-card:nth-child(4) { background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.2); }
        .feature-card:nth-child(4):hover { background: rgba(245, 158, 11, 0.15); border-color: rgba(245, 158, 11, 0.3); }

        /* Navigation */
        .nav-glass { 
            background: rgba(255, 255, 255, 0.02); 
            backdrop-filter: blur(4px) saturate(110%); 
            border-bottom: 1px solid rgba(255, 255, 255, 0.05); 
            color: var(--text-primary); 
        }

        /* Section animation */
        .section, .vendor-tab-content { display: none; opacity: 0; }
        .section.active, .vendor-tab-content.active { display: block; animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }

        /* Theme selector */
        .theme-selector { display: flex; align-items: center; gap: 8px; }
        .theme-option { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .theme-option.active { border-color: var(--accent); transform: scale(1.2); box-shadow: 0 0 10px var(--accent); }
        .theme-light { background: linear-gradient(45deg, #6366f1, #ec4899); }
        .theme-dark { background: linear-gradient(45deg, #1e293b, #0f172a); }
        .theme-cyberpunk { background: linear-gradient(45deg, #ff0080, #00ffff); }
        .theme-ocean { background: linear-gradient(45deg, #0891b2, #67e8f9); }

        /* Message box */
        .message-box { position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 12px; z-index: 3001; backdrop-filter: blur(10px); border: 1px solid var(--glass-border); transform: translateX(120%); opacity: 0; display: none; }
        .message-box.show { transform: translateX(0); opacity: 1; display: flex; }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 3000; }
        .modal-content { 
            background: rgba(255, 255, 255, 0.02); 
            backdrop-filter: blur(6px) saturate(120%);
            border-radius: 20px; 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 20px 60px var(--shadow); 
            animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        @keyframes modalSlideIn { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        /* Loading */
        .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Progress */
        .progress-bar { width: 100%; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); border-radius: 4px; transition: width 0.3s ease; }

        /* Status chips */
        .status-available { background: linear-gradient(135deg, #10b981, #34d399); color: white; }
        .status-in-use { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; }
        .status-maintenance { background: linear-gradient(135deg, #ef4444, #f87171); color: white; }

        /* Route cards */
        .route-option { 
            background: rgba(99, 102, 241, 0.08); 
            border: 2px solid rgba(99, 102, 241, 0.15); 
            border-radius: 16px; 
            padding: 20px; 
            cursor: pointer; 
            position: relative; 
            overflow: hidden; 
            transition: all 0.3s ease;
        }
        .route-option::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent); transition: left 0.5s; }
        .route-option:hover::before { left: 100%; }
        .route-option:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 32px var(--shadow); 
            border-color: var(--primary); 
            background: rgba(99, 102, 241, 0.12);
        }
        .route-option.selected-route { 
            border-color: var(--primary); 
            background: rgba(99, 102, 241, 0.15); 
            box-shadow: 0 8px 32px var(--primary); 
        }

        /* FAB */
        .fab { position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; border: none; cursor: pointer; box-shadow: 0 8px 24px var(--shadow); z-index: 1000; }
        .fab:hover { transform: scale(1.1) rotate(180deg); box-shadow: 0 12px 36px var(--shadow); }

        /* Vehicle cards */
        .vehicle-card { 
            background: rgba(16, 185, 129, 0.08); 
            border: 1px solid rgba(16, 185, 129, 0.15); 
            border-radius: 16px; 
            padding: 16px; 
            position: relative; 
            overflow: hidden; 
            transition: all 0.3s ease;
        }
        .vehicle-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--primary), var(--accent)); }
        .vehicle-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 32px var(--shadow); 
            border-color: var(--primary); 
            background: rgba(16, 185, 129, 0.12);
        }

        /* Vendor tabs */
        .vendor-tab { position: relative; padding: 12px 20px; border-radius: 8px 8px 0 0; }
        .vendor-tab.active { background: var(--bg-primary); color: var(--primary); border-bottom: 3px solid var(--primary); }

        /* Map container */
        .map-container { border-radius: 16px; overflow: hidden; box-shadow: 0 8px 32px var(--shadow); border: 1px solid var(--border); }

        /* Metrics */
        .metric-card { 
            background: rgba(245, 158, 11, 0.08); 
            border: 1px solid rgba(245, 158, 11, 0.15); 
            border-radius: 16px; 
            padding: 24px; 
            text-align: center; 
            position: relative; 
            overflow: hidden; 
            transition: all 0.3s ease;
        }
        .metric-card::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, var(--primary), var(--secondary)); opacity: 0.05; }
        .metric-card:hover {
            background: rgba(245, 158, 11, 0.12);
            border-color: rgba(245, 158, 11, 0.25);
            transform: translateY(-2px);
        }
        .metric-value { position: relative; font-size: 2.5rem; font-weight: 800; background: linear-gradient(45deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

        /* Logo */
        .logo-enhanced { background: linear-gradient(45deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; position: relative; }
        .logo-enhanced::after { content: '⚡'; position: absolute; right: -30px; top: 50%; transform: translateY(-50%); animation: logoSpark 2s ease-in-out infinite; }
        @keyframes logoSpark { 0%, 100% { opacity: 0.5; transform: translateY(-50%) scale(1); } 50% { opacity: 1; transform: translateY(-50%) scale(1.2); } }

        /* Range slider */
        .range-slider { -webkit-appearance: none; appearance: none; height: 8px; background: var(--bg-tertiary); border-radius: 4px; outline: none; }
        .range-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: linear-gradient(45deg, var(--primary), var(--secondary)); border-radius: 50%; cursor: pointer; box-shadow: 0 2px 8px var(--shadow); }
        .range-slider::-moz-range-thumb { width: 20px; height: 20px; background: linear-gradient(45deg, var(--primary), var(--secondary)); border-radius: 50%; cursor: pointer; border: none; box-shadow: 0 2px 8px var(--shadow); }

        /* Toggle */
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 30px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; inset: 0; background: var(--bg-tertiary); border-radius: 30px; transition: 0.3s; border: 2px solid var(--border); }
        .toggle-slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 2px; bottom: 2px; background: var(--bg-primary); border-radius: 50%; transition: 0.3s; box-shadow: 0 2px 8px var(--shadow); }
        input:checked + .toggle-slider { background: linear-gradient(45deg, var(--primary), var(--accent)); border-color: var(--primary); }
        input:checked + .toggle-slider:before { transform: translateX(28px); background: white; }

        /* Grid */
        .responsive-grid { display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        @media (max-width: 640px) { 
            .responsive-grid { grid-template-columns: 1fr; gap: 16px; } 
            /* Hide floating theme button on mobile */
            .fixed.bottom-4.left-4 { display: none; }
        }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            *, ::before, ::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; }
        }

        /* Print */
        @media print {
            .no-print { display: none !important; }
            .glass, .glass-card { background: white !important; box-shadow: none !important; border: 1px solid #ccc !important; }
        }

        /* High contrast */
        @media (prefers-contrast: high) {
            .glass, .glass-card { border-width: 2px; border-color: var(--text-primary); }
            .btn-modern { border: 2px solid var(--text-primary); }
        }

        /* Ensure map container has a defined height */
        #live-navigation {
            height: calc(100vh - 150px);
        }

         /* Toggle Switch styles */
         input:checked ~ .dot {
            transform: translateX(100%);
            background-color: var(--primary);
        }
        input:checked ~ .block {
            background-color: var(--accent);
        }
    </style>
</head>

<body class="animated-bg font-sans min-h-screen flex flex-col" data-theme="light" style="position: relative;">
    <!-- Theme Control Panel (collapsible) -->
    <div class="fixed bottom-4 left-4 z-50 no-print">
        <div class="glass rounded-xl overflow-hidden">
            <button id="theme-toggle" class="btn-modern !rounded-none w-full" style="border-radius: 0;">Theme</button>
            <div id="theme-panel" class="p-3 hidden">
                <div class="theme-selector">
                    <div class="theme-option theme-light active" data-theme="light"></div>
                    <div class="theme-option theme-dark" data-theme="dark"></div>
                    <div class="theme-option theme-cyberpunk" data-theme="cyberpunk"></div>
                    <div class="theme-option theme-ocean" data-theme="ocean"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Message Box for feedback -->
    <div id="message-box" class="message-box glass text-white">
        <span id="message-text"></span>
        <button onclick="hideMessage()" class="text-white text-xl ml-4">&times;</button>
    </div>

    <!-- Edit Charger Modal -->
    <div id="edit-charger-modal" class="modal-overlay hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Edit Charger</h2>
            <div id="edit-charger-form" class="space-y-4">
                <input type="hidden" id="edit-charger-id">
                <input type="text" id="edit-charger-name" placeholder="Charger Name" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                <input type="number" id="edit-charger-rate" placeholder="Charging Rate (kW)" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                <select id="edit-charger-status" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <option value="available">Available</option>
                    <option value="in-use">In Use</option>
                    <option value="maintenance">Maintenance</option>
                </select>
                <div class="flex gap-4 pt-4">
                    <button id="update-charger-btn" onclick="updateCharger()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Update Charger</button>
                    <button onclick="closeEditModal()" class="w-full bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Suggestion Modal -->
    <div id="suggestion-modal" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg relative">
            <button onclick="closeSuggestionModal()" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            <h2 id="suggestion-title" class="text-2xl font-bold mb-4 text-gray-800">Time for a break?</h2>
            <p id="suggestion-subtitle" class="text-gray-600 mb-4">Here are some places nearby:</p>
            <div id="suggestion-list" class="space-y-3 max-h-64 overflow-y-auto custom-scrollbar">
                <!-- Suggestions will be injected here -->
            </div>
        </div>
    </div>


    <!-- Authentication Section -->
    <div id="auth-section" class="flex items-center justify-center min-h-screen p-4" style="position: relative; z-index: 1;">
        <!-- Forms are rendered here by JS -->
    </div>

    <!-- Main Application -->
    <div id="app-content" class="flex flex-col flex-grow interactive-bg" style="display: none; position: relative; z-index: 1;">
        <header class="nav-glass p-4 sticky top-0 z-10">
            <!-- Hamburger Menu Navigation -->
            <nav class="container mx-auto">
                <!-- Top Row -->
                <div class="flex justify-between items-center">
                    <!-- Left Side - Hamburger Menu Button -->
                    <div class="flex items-center gap-3">
                        <!-- Hamburger Menu Button -->
                        <button id="hamburger-btn" class="text-2xl hover:opacity-80 transition-all duration-300" style="color: var(--text-primary);" onclick="toggleHamburgerMenu()">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                        
                        <!-- Logo -->
                        <div class="logo-enhanced text-2xl font-extrabold tracking-tight" style="color: var(--text-primary);">ChargeFranchise</div>
                    </div>
                </div>
                
                <!-- Bottom Row - Status and User Controls -->
                <div class="flex justify-between items-center mt-2">
                    <!-- Left Side - Connection Status -->
                    <div id="connection-status" class="flex items-center gap-1" title="Connection Status">
                        <div id="connection-indicator" class="w-2 h-2 rounded-full bg-green-500"></div>
                        <span id="connection-text" class="text-xs" style="color: var(--text-secondary);">Online</span>
                    </div>
                    
                    <!-- Right Side - User Info and Logout -->
                    <div class="flex items-center gap-3">
                        <!-- User Info -->
                        <span id="user-info" style="color: var(--text-primary); font-weight: 500;"></span>
                        
                        <!-- Logout Button -->
                        <button onclick="logout()" class="logout-btn glass p-2 rounded-xl font-semibold transition-all duration-300 hover:scale-105 text-sm group relative overflow-hidden" style="background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-primary);" title="Logout">
                            <svg class="w-4 h-4 transition-transform duration-300 group-hover:rotate-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            <div class="absolute inset-0 bg-gradient-to-r from-red-500/20 to-pink-500/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-xl"></div>
                        </button>
                    </div>
                </div>
            </nav>
            
            <!-- Collapsible Hamburger Menu -->
            <div id="hamburger-menu" class="hidden mt-4 glass p-4 rounded-xl" style="background: var(--bg-secondary); border: 1px solid var(--border);">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                 <!-- User Links -->
                    <div class="user-only-nav">
                        <a href="#home" class="block font-medium p-3 rounded-lg transition-all duration-300 hover:scale-105" style="color: var(--text-primary); background: var(--bg-tertiary);" onmouseover="this.style.background='var(--primary)'; this.style.color='white';" onmouseout="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-primary)';" onclick="showSection('home'); toggleHamburgerMenu();">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                </svg>
                                Home
                            </div>
                        </a>
                    </div>
                    <div class="user-only-nav">
                        <a href="#find-chargers" class="block font-medium p-3 rounded-lg transition-all duration-300 hover:scale-105" style="color: var(--text-primary); background: var(--bg-tertiary);" onmouseover="this.style.background='var(--primary)'; this.style.color='white';" onmouseout="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-primary)';" onclick="showSection('find-chargers'); toggleHamburgerMenu();">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                                </svg>
                                AI Route Planner
                            </div>
                        </a>
                    </div>
                    <div class="user-only-nav">
                        <a href="#chargers-near-me" class="block font-medium p-3 rounded-lg transition-all duration-300 hover:scale-105" style="color: var(--text-primary); background: var(--bg-tertiary);" onmouseover="this.style.background='var(--primary)'; this.style.color='white';" onmouseout="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-primary)';" onclick="showSection('chargers-near-me'); toggleHamburgerMenu();">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Chargers Near Me
                            </div>
                        </a>
                    </div>
                    <div class="user-only-nav">
                        <a href="#vehicle-reg" class="block font-medium p-3 rounded-lg transition-all duration-300 hover:scale-105" style="color: var(--text-primary); background: var(--bg-tertiary);" onmouseover="this.style.background='var(--primary)'; this.style.color='white';" onmouseout="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-primary)';" onclick="showSection('vehicle-reg'); toggleHamburgerMenu();">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"></path>
                                </svg>
                                My Vehicles
                            </div>
                        </a>
                    </div>
                    <div class="user-only-nav">
                        <a href="#trip-history" class="block font-medium p-3 rounded-lg transition-all duration-300 hover:scale-105" style="color: var(--text-primary); background: var(--bg-tertiary);" onmouseover="this.style.background='var(--primary)'; this.style.color='white';" onmouseout="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-primary)';" onclick="showSection('trip-history'); toggleHamburgerMenu();">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Trip History
                            </div>
                        </a>
                    </div>
                    <div class="user-only-nav">
                        <a href="#rent-charger" class="block font-medium p-3 rounded-lg transition-all duration-300 hover:scale-105" style="color: var(--text-primary); background: var(--bg-tertiary);" onmouseover="this.style.background='var(--primary)'; this.style.color='white';" onmouseout="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-primary)';" onclick="showSection('rent-charger'); toggleHamburgerMenu();">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Rent My Charger
                            </div>
                        </a>
                    </div>
                    <div class="user-only-nav">
                        <a href="#become-vendor" class="block font-medium p-3 rounded-lg transition-all duration-300 hover:scale-105" style="color: var(--text-primary); background: var(--bg-tertiary);" onmouseover="this.style.background='var(--primary)'; this.style.color='white';" onmouseout="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-primary)';" onclick="showSection('become-vendor'); toggleHamburgerMenu();">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                                Become a Partner
                            </div>
                        </a>
                    </div>

                 <!-- Vendor Links -->
                    <div class="vendor-only-nav" style="display: none;">
                        <a href="#dashboard-performance" class="block font-medium p-3 rounded-lg transition-all duration-300 hover:scale-105" style="color: var(--text-primary); background: var(--bg-tertiary);" onmouseover="this.style.background='var(--primary)'; this.style.color='white';" onmouseout="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-primary)';" onclick="showSection('dashboard'); showVendorTab('performance-overview'); toggleHamburgerMenu();">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                Performance Overview
                            </div>
                        </a>
                    </div>
                    <div class="vendor-only-nav" style="display: none;">
                        <a href="#dashboard-manage" class="block font-medium p-3 rounded-lg transition-all duration-300 hover:scale-105" style="color: var(--text-primary); background: var(--bg-tertiary);" onmouseover="this.style.background='var(--primary)'; this.style.color='white';" onmouseout="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-primary)';" onclick="showSection('dashboard'); showVendorTab('manage-chargers'); toggleHamburgerMenu();">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Manage Chargers
                            </div>
                        </a>
                    </div>
                    <div class="vendor-only-nav" style="display: none;">
                        <a href="#dashboard-vmap" class="block font-medium p-3 rounded-lg transition-all duration-300 hover:scale-105" style="color: var(--text-primary); background: var(--bg-tertiary);" onmouseover="this.style.background='var(--primary)'; this.style.color='white';" onmouseout="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-primary)';" onclick="showSection('dashboard'); showVendorTab('my-vmap'); toggleHamburgerMenu();">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                                </svg>
                                My VMAP
                            </div>
                        </a>
                    </div>
                    <div class="vendor-only-nav" style="display: none;">
                        <a href="#dashboard-settings" class="block font-medium p-3 rounded-lg transition-all duration-300 hover:scale-105" style="color: var(--text-primary); background: var(--bg-tertiary);" onmouseover="this.style.background='var(--primary)'; this.style.color='white';" onmouseout="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-primary)';" onclick="showSection('dashboard'); showVendorTab('vendor-settings'); toggleHamburgerMenu();">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Settings
                            </div>
                        </a>
                    </div>
                </div>
                
                <!-- Theme Selector Section -->
                <div class="mt-6 pt-4 border-t" style="border-color: var(--border);">
                    <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">Theme</h3>
                    <div class="theme-selector flex gap-3">
                        <div class="theme-option theme-light active" data-theme="light" title="Light Theme"></div>
                        <div class="theme-option theme-dark" data-theme="dark" title="Dark Theme"></div>
                        <div class="theme-option theme-cyberpunk" data-theme="cyberpunk" title="Cyberpunk Theme"></div>
                        <div class="theme-option theme-ocean" data-theme="ocean" title="Ocean Theme"></div>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content container mx-auto p-4 flex-grow glass-card mt-4">
            <!-- Home Section -->
            <section id="home" class="section active">
                <div class="glass p-10 rounded-xl text-center">
                    <h1 class="text-4xl font-extrabold mb-4" style="color: var(--text-primary);">The Future of EV Charging is Collaborative</h1>
                    <p class="text-xl" style="color: var(--text-secondary);">Plan smart routes, manage your vehicles, and join our network of chargers.</p>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-6">
                    <div class="feature-card" id="vehicles-card" style="background: var(--bg-secondary); border: 1px solid var(--border); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
                        <h2 class="text-2xl font-semibold mb-2" style="color: var(--text-primary);">My Vehicles</h2>
                        <p class="mb-4" style="color: var(--text-secondary);">Register and manage your electric vehicles for smart route planning.</p>
                        <button id="vehicle-action-btn" onclick="showSection('vehicle-reg')" class="btn-modern w-full transition-all duration-300 hover:scale-105 btn-primary">Add Vehicle</button>
                    </div>
                    <div class="feature-card" style="background: var(--bg-secondary); border: 1px solid var(--border); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
                        <h2 class="text-2xl font-semibold mb-2" style="color: var(--text-primary);">AI Route Planner</h2>
                        <p class="mb-4" style="color: var(--text-secondary);">Get intelligent route planning with optimal charging stops for your EV journey.</p>
                        <button onclick="showSection('find-chargers')" class="btn-modern w-full transition-all duration-300 hover:scale-105 btn-secondary">Plan Trip</button>
                    </div>
                    <div class="feature-card" style="background: var(--bg-secondary); border: 1px solid var(--border); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
                        <h2 class="text-2xl font-semibold mb-2" style="color: var(--text-primary);">Trip History</h2>
                        <p class="mb-4" style="color: var(--text-secondary);">View your completed trips and statistics.</p>
                        <button onclick="showSection('trip-history')" class="btn-modern w-full transition-all duration-300 hover:scale-105 btn-history">View History</button>
                    </div>
                    <div class="feature-card" style="background: var(--bg-secondary); border: 1px solid var(--border); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
                        <h2 class="text-2xl font-semibold mb-2" style="color: var(--text-primary);">Become a Partner</h2>
                        <p class="mb-4" style="color: var(--text-secondary);">Earn by setting up your own charging station franchise.</p>
                        <button onclick="showSection('become-vendor')" class="btn-modern w-full transition-all duration-300 hover:scale-105 btn-partner">Apply Now</button>
                    </div>
                </div>
            </section>

            <!-- AI Route Planner Section -->
            <section id="find-chargers" class="section">
                 <div class="p-6">
                    <h2 class="text-3xl font-bold mb-4" style="color: var(--text-primary);">AI Route Planner</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 glass-card p-6 space-y-4" id="route-form">
                            <h3 class="text-xl font-semibold" style="color: var(--text-primary);">Plan your journey</h3>
                            <div>
                                <label class="block text-sm font-medium" style="color: var(--text-secondary);">Start Location</label>
                                <div class="flex items-center gap-2">
                                     <input type="text" id="route-start" placeholder="e.g. Thiruvananthapuram" class="w-full p-3 border rounded-lg form-field">
                                     <button onclick="locateMe('route-start')" class="p-2 rounded-lg transition-colors" style="background: var(--bg-tertiary);">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--text-secondary);">
                                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                                            <circle cx="12" cy="10" r="3" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- NEW: Waypoints UI -->
                            <div id="waypoints-container" class="space-y-2"></div>
                            <div>
                                <label class="block text-sm font-medium" style="color: var(--text-secondary);">Add Waypoint (for long trips)</label>
                                <div class="flex items-center gap-2">
                                    <input type="text" id="waypoint-input" placeholder="e.g. Delhi" class="w-full p-3 border rounded-lg form-input">
                                    <button onclick="addWaypoint()" class="p-2 rounded-lg transition-colors font-bold text-lg" style="background: var(--bg-tertiary);">+</button>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium" style="color: var(--text-secondary);">Destination</label>
                                <input type="text" id="route-end" placeholder="e.g. Pune" class="w-full p-3 border rounded-lg form-input">
                            </div>
                             <div>
                                <label class="block text-sm font-medium" style="color: var(--text-secondary);">Select Your Vehicle</label>
                                <select id="vehicle-select" class="w-full p-3 border rounded-lg form-field"></select>
                            </div>
                            <div>
                                <label for="start-charge" class="block text-sm font-medium" style="color: var(--text-secondary);">Starting Charge: <span id="start-charge-value">80</span>%</label>
                                <input type="range" id="start-charge" min="0" max="100" value="80" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="end-charge" class="block text-sm font-medium" style="color: var(--text-secondary);">Desired Charge at Arrival: <span id="end-charge-value">20</span>%</label>
                                <input type="range" id="end-charge" min="0" max="100" value="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="search-radius" class="block text-sm font-medium" style="color: var(--text-secondary);">Charger Search Radius: <span id="search-radius-value">10</span> km</label>
                                <input type="range" id="search-radius" min="5" max="50" value="10" step="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="nearby-radius" class="block text-sm font-medium" style="color: var(--text-secondary);">Nearby Places Radius: <span id="nearby-radius-value">5</span> km</label>
                                <input type="range" id="nearby-radius" min="1" max="20" value="5" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                             <div class="flex items-center justify-between">
                                <label for="toggle-suggestions" class="flex items-center cursor-pointer">
                                    <span class="text-sm font-medium text-gray-600">Meal & Stay Suggestions</span>
                                </label>
                                <div class="relative">
                                    <input type="checkbox" id="toggle-suggestions" class="sr-only" checked>
                                    <div class="block bg-gray-300 w-10 h-6 rounded-full"></div>
                                    <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                                </div>
                            </div>
                            <button id="find-route-btn" onclick="findAlternativeRoutes()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Find Available Routes</button>
                        </div>
                        <div class="lg:col-span-2 space-y-4">
                            <div id="route-details" class="glass-card p-4 hidden"></div>
                            <div class="glass-card p-2">
                                <div id="map" class="w-full h-[500px] rounded-lg"></div>
                            </div>
                             <!-- Nearby Places will be shown here after selecting a charger -->
                            <div id="nearby-places" class="glass-card p-4 hidden"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Chargers Near Me Section -->
            <section id="chargers-near-me" class="section">
                <div class="p-6">
                    <h2 class="text-3xl font-bold mb-4" style="color: var(--text-primary);">EV Chargers Near Me</h2>
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-gray-600 mb-2">Find the closest available chargers around your location.</p>
                            <div class="flex items-center gap-4">
                                <label for="near-me-radius" class="text-sm font-medium" style="color: var(--text-secondary);">Search Radius: <span id="near-me-radius-value">10</span> km</label>
                                <input type="range" id="near-me-radius" min="5" max="50" value="10" step="5" class="w-32 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        <div class="flex gap-2">
                        <button onclick="locateMe('near-me-map')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                                <circle cx="12" cy="10" r="3" />
                            </svg>
                            Locate Me
                        </button>
                            <button onclick="testChargerLoading()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                                Test Loading
                        </button>
                        </div>
                    </div>
                    <div class="glass-card p-2">
                        <div id="chargers-near-me-map" class="w-full h-[600px] rounded-lg"></div>
                    </div>
                </div>
            </section>

            <!-- Live Navigation Section -->
            <section id="live-navigation" class="section">
                <div class="p-6 h-full flex flex-col relative">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-bold text-gray-800">Live Navigation</h2>
                        <div class="flex items-center gap-4">
                             <button id="mute-btn" onclick="toggleMute()" class="bg-gray-200 text-gray-700 p-2 rounded-full font-semibold hover:bg-gray-300 transition-colors">
                                <!-- Speaker Icon will be injected by JS -->
                            </button>
                            <button onclick="stopInAppNavigation()" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition-colors">Stop Navigation</button>
                        </div>
                    </div>
                    <!-- Info box for selected nearby place -->
                    <div id="selected-place-info" class="absolute top-20 left-1/2 -translate-x-1/2 z-10 bg-white p-3 rounded-lg shadow-lg hidden">
                        <p class="font-bold text-indigo-600">Visiting:</p>
                        <p id="selected-place-text" class="text-sm"></p>
                    </div>
                    <!-- Turn-by-turn directions panel -->
                    <div id="turn-by-turn-directions" class="absolute top-20 left-4 z-10 bg-white p-4 rounded-lg shadow-lg w-full max-w-sm">
                        <!-- Directions will be injected here by JS -->
                    </div>
                    <div id="live-navigation-map" class="w-full rounded-lg shadow-md flex-grow"></div>
                </div>
            </section>


            <!-- My Vehicles Section -->
            <section id="vehicle-reg" class="section">
                 <div class="p-6">
                    <h2 class="text-3xl font-bold mb-4" style="color: var(--text-primary);">My Vehicles</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass-card p-6" id="vehicle-form">
                            <h3 class="text-xl font-semibold mb-3" style="color: var(--text-primary);">Add a New Vehicle</h3>
                            <div class="space-y-4">
                                <input type="text" id="reg-no" placeholder="Registration No. (e.g. MH01AB1234)" class="w-full p-3 border rounded-lg form-field">
                                <input type="text" id="vehicle-make" placeholder="Make (e.g. Tesla)" class="w-full p-3 border rounded-lg form-field">
                                <input type="text" id="vehicle-model" placeholder="Model (e.g. Model 3)" class="w-full p-3 border rounded-lg form-field">
                                <input type="number" id="battery-capacity" placeholder="Battery Capacity (kWh)" class="w-full p-3 border rounded-lg form-field">
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-2">Supported Connector Types</label>
                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                        <label class="flex items-center space-x-2"><input type="checkbox" class="form-checkbox h-4 w-4 text-indigo-600 supported-plug" value="CCS2"> <span>CCS2</span></label>
                                        <label class="flex items-center space-x-2"><input type="checkbox" class="form-checkbox h-4 w-4 text-indigo-600 supported-plug" value="CHADEMO"> <span>CHAdeMO</span></label>
                                        <label class="flex items-center space-x-2"><input type="checkbox" class="form-checkbox h-4 w-4 text-indigo-600 supported-plug" value="TYPE 2"> <span>Type 2 (AC)</span></label>
                                        <label class="flex items-center space-x-2"><input type="checkbox" class="form-checkbox h-4 w-4 text-indigo-600 supported-plug" value="GB/T"> <span>GB/T</span></label>
                                    </div>
                                </div>
                                <button id="submit-vehicle-btn" onclick="submitVehicle()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">Register Vehicle</button>
                            </div>
                        </div>
                        <div class="glass-card p-6 custom-scrollbar overflow-y-auto max-h-96">
                            <h3 class="text-xl font-semibold mb-3" style="color: var(--text-primary);">My Registered Vehicles</h3>
                            <div id="my-vehicles-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Trip History Section -->
            <section id="trip-history" class="section">
                <div class="p-6">
                    <h2 class="text-3xl font-bold mb-4" style="color: var(--text-primary);">Trip History</h2>
                    <div class="glass-card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold" style="color: var(--text-primary);">Your Completed Trips</h3>
                            <div class="flex gap-2">
                            <button onclick="exportTripHistory()" class="btn-modern">Export History</button>
                            <button onclick="clearTripHistory()" class="btn-modern" style="background: #ef4444; color: white;">Clear History</button>
                            <button onclick="cleanOldData()" class="btn-modern" style="background: #f59e0b; color: white;">Clean Old Data</button>
                        </div>
                        </div>
                        <div id="trip-history-list" class="space-y-4 custom-scrollbar overflow-y-auto max-h-96">
                            <p style="color: var(--text-secondary);">No trips completed yet. Start planning your first route!</p>
                        </div>
                    </div>
                    
                    <div class="glass-card p-6 mt-6">
                        <h3 class="text-xl font-semibold mb-4" style="color: var(--text-primary);">Trip Statistics</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="metric-card">
                                <div class="text-sm" style="color: var(--text-secondary);">Total Trips</div>
                                <div id="total-trips" class="metric-value">0</div>
                            </div>
                            <div class="metric-card">
                                <div class="text-sm" style="color: var(--text-secondary);">Distance Traveled</div>
                                <div id="total-distance" class="metric-value">0 km</div>
                            </div>
                            <div class="metric-card">
                                <div class="text-sm" style="color: var(--text-secondary);">Energy Used</div>
                                <div id="total-energy" class="metric-value">0 kWh</div>
                            </div>
                            <div class="metric-card">
                                <div class="text-sm" style="color: var(--text-secondary);">CO₂ Saved</div>
                                <div id="co2-saved" class="metric-value">0 kg</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Rent My Charger Section -->
            <section id="rent-charger" class="section">
                <div class="p-6">
                    <h2 class="text-3xl font-bold mb-4" style="color: var(--text-primary);">Rent Your Home Charger</h2>
                    <p class="mb-6 text-gray-600">Earn extra income by listing your personal EV charger for others to use when you're not.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-6 bg-gray-50 rounded-lg shadow-inner" id="home-charger-form">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">List Your Charger</h3>
                            <div class="space-y-4">
                                <input type="text" id="home-charger-name" placeholder="Charger Nickname (e.g. My Home Charger)" class="w-full p-3 border rounded-lg form-field">
                                <input type="number" id="home-charger-rate" placeholder="Charging Rate (kW)" class="w-full p-3 border rounded-lg form-field">
                                <input type="text" id="home-charger-address" placeholder="Your Full Address" class="w-full p-3 border rounded-lg form-field">
                                <input type="text" id="home-charger-type" placeholder="Connector Type" class="w-full p-3 border rounded-lg form-field">
                                <button id="list-charger-btn" onclick="listHomeCharger()" class="w-full bg-teal-600 text-white py-3 rounded-lg font-semibold hover:bg-teal-700">List My Charger</button>
                            </div>
                        </div>
                        <div class="glass-card p-6 custom-scrollbar overflow-y-auto max-h-96">
                            <h3 class="text-xl font-semibold mb-3" style="color: var(--text-primary);">My Listed Chargers</h3>
                            <div id="user-chargers-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>
            </section>

             <!-- Become a Vendor Section -->
            <section id="become-vendor" class="section">
                 <div class="p-6 max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold mb-4" style="color: var(--text-primary);">Become a Vendor Partner</h2>
                    <div id="vendor-application-status"></div>
                </div>
            </section>

            <!-- Vendor Dashboard Section -->
            <section id="dashboard" class="section">
                <div class="p-6">


                    <div id="performance-overview" class="vendor-tab-content active">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">Performance Overview</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-6 bg-gray-50 rounded-lg shadow-inner">
                                <h3 class="text-xl font-semibold mb-3 text-gray-700">Monthly Earnings</h3>
                                <canvas id="chargingChart"></canvas>
                            </div>
                            <div class="p-6 bg-gray-50 rounded-lg shadow-inner" id="roi-calculator">
                                <h3 class="text-xl font-semibold mb-3 text-gray-700">Return on Investment (ROI) Calculator</h3>
                                <div class="space-y-4">
                                    <input type="number" id="investment" placeholder="Total Investment (₹)" class="w-full p-3 border rounded-lg">
                                    <input type="number" id="monthly-revenue" placeholder="Avg. Monthly Revenue (₹)" class="w-full p-3 border rounded-lg">
                                    <button onclick="calculateROI()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">Calculate Annual ROI</button>
                                    <div id="roi-result" class="mt-4 p-4 bg-blue-100 rounded-lg hidden"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="manage-chargers" class="vendor-tab-content">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="p-6 bg-gray-50 rounded-lg shadow-inner">
                                <h3 class="text-xl font-semibold mb-3 text-gray-700">My Franchise Chargers</h3>
                                <div id="vendor-chargers-list" class="space-y-3 max-h-[400px] overflow-y-auto custom-scrollbar"></div>
                            </div>
                             <div class="p-6 bg-gray-50 rounded-lg shadow-inner" id="vendor-charger-form">
                                <h3 class="text-xl font-semibold mb-3 text-gray-700">Add a New Franchise Charger</h3>
                                <div class="space-y-4">
                                    <input type="text" id="charger-name" placeholder="Charger Name" class="w-full p-3 border rounded-lg form-field">
                                    <input type="number" id="charger-rate" placeholder="Charging Rate (kW)" class="w-full p-3 border rounded-lg form-field">
                                    <input type="number" id="charger-lat" placeholder="Latitude" class="w-full p-3 border rounded-lg form-field">
                                    <input type="number" id="charger-lng" placeholder="Longitude" class="w-full p-3 border rounded-lg form-field">
                                    <select id="connector-type-select" class="w-full p-3 border rounded-lg form-field">
                                        <option value="">Select Connector Type</option>
                                        <option value="CCS2">CCS2</option>
                                        <option value="CHAdeMO">CHAdeMO</option>
                                        <option value="Type 2 AC">Type 2 AC</option>
                                        <option value="3-pin plug">3-pin plug</option>
                                    </select>
                                    <select id="charger-type-select" class="w-full p-3 border rounded-lg form-field">
                                        <option value="">Select Charger Type</option>
                                        <option value="AC Slow">AC Slow</option>
                                        <option value="AC Fast">AC Fast</option>
                                        <option value="DC Fast">DC Fast Charger</option>
                                    </select>
                                    <button id="add-charger-btn" onclick="addCharger()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">Add Charger</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="my-vmap" class="vendor-tab-content">
                         <h3 class="text-2xl font-bold mb-4 text-gray-800">My Charger Locations</h3>
                        <div class="glass-card p-2"><div id="vendor-map" class="w-full h-[500px] rounded-lg"></div></div>
                    </div>

                    <div id="vendor-settings" class="vendor-tab-content">
                        <h3 class="text-2xl font-bold mb-4" style="color: var(--text-primary);">Vendor Settings</h3>
                        <div class="p-6 bg-gray-50 rounded-lg shadow-inner max-w-md mx-auto" id="set-pin-form">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">Set Your Custom PIN</h3>
                            <p class="text-gray-600 mb-4">This PIN will be used for all future logins.</p>
                            <div class="space-y-4">
                                <input type="password" id="new-pin" placeholder="New PIN" class="w-full p-3 border rounded-lg form-field">
                                <input type="password" id="confirm-pin" placeholder="Confirm New PIN" class="w-full p-3 border rounded-lg form-field">
                                <button onclick="setCustomPin()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">Set PIN</button>
                            </div>
                        </div>

                        <div class="p-6 bg-gray-50 rounded-lg shadow-inner max-w-md mx-auto mt-6" id="change-pin-form" style="display:none;">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">Change Your PIN</h3>
                            <div class="space-y-4">
                                <input type="password" id="current-pin" placeholder="Current PIN" class="w-full p-3 border rounded-lg form-field">
                                <input type="password" id="change-new-pin" placeholder="New PIN" class="w-full p-3 border rounded-lg form-field">
                                <input type="password" id="change-confirm-pin" placeholder="Confirm New PIN" class="w-full p-3 border rounded-lg form-field">
                                <button onclick="changeCustomPin()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">Change PIN</button>
                            </div>
                        </div>

                        <div class="p-6 bg-gray-50 rounded-lg shadow-inner max-w-md mx-auto mt-6">
                            <h3 class="text-xl font-semibold mb-3 text-gray-700">Open Charge Map API Key</h3>
                            <p class="text-gray-600 mb-4">Enter your Open Charge Map API key for global charger data.</p>
                            <input type="text" id="ocm-api-key" placeholder="Enter API Key" class="w-full p-3 border rounded-lg form-field">
                        </div>
                    </div>
                </div>
            </section>
        </main>
        <footer class="mt-auto p-6 text-center" style="color: var(--text-secondary);">
            &copy; <span id="year"></span> ChargeFranchise · Built for EV entrepreneurs
        </footer>
    </div>
    
    <!-- Main Application Script -->
    <script type="module">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCB2GoSkw4qdFkUmFxNAmIUgGgzFXCZZp8",
            authDomain: "chargeshare-a327a.firebaseapp.com",
            databaseURL: "https://chargeshare-a327a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "chargeshare-a327a",
            storageBucket: "chargeshare-a327a.appspot.com",
            messagingSenderId: "77947942873",
            appId: "1:77947942873:web:b8366adbb41f39b8a8cbc8"
        };

        // Network status tracking
        let isOnline = navigator.onLine;
        let networkErrors = [];

        // Update connection status indicator
        const updateConnectionStatus = (online) => {
            const indicator = document.getElementById('connection-indicator');
            const text = document.getElementById('connection-text');
            
            if (indicator && text) {
                if (online) {
                    indicator.className = 'w-2 h-2 rounded-full bg-green-500';
                    text.textContent = 'Online';
                    text.style.color = 'var(--text-secondary)';
                } else {
                    indicator.className = 'w-2 h-2 rounded-full bg-red-500';
                    text.textContent = 'Offline';
                    text.style.color = '#ef4444';
                }
            }
        };

        // Monitor network status
        window.addEventListener('online', () => {
            isOnline = true;
            updateConnectionStatus(true);
            showMessage('Connection restored!', 3000, 'success');
            hideNetworkError();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            updateConnectionStatus(false);
            showMessage('You are offline. Some features may not work.', 5000, 'warning');
            showNetworkError();
        });

        // Check network connectivity
        const checkNetworkStatus = async () => {
            try {
                const response = await fetch('https://www.google.com/favicon.ico', { 
                    method: 'HEAD', 
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                isOnline = true;
                hideNetworkError();
                return true;
            } catch (error) {
                isOnline = false;
                showNetworkError();
                return false;
            }
        };

        // Show network error indicator
        const showNetworkError = () => {
            let errorDiv = document.getElementById('network-error');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.id = 'network-error';
                errorDiv.className = 'fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg';
                errorDiv.style.cssText = `
                    background: #fef3c7;
                    border: 1px solid #f59e0b;
                    color: #92400e;
                    max-width: 300px;
                `;
                errorDiv.innerHTML = `
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 19.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <div>
                            <div class="font-semibold">Connection Issues</div>
                            <div class="text-sm">Some features may not work properly</div>
                        </div>
                        <button onclick="hideNetworkError()" class="ml-2 text-gray-500 hover:text-gray-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                `;
                document.body.appendChild(errorDiv);
            }
        };

        // Hide network error indicator
        const hideNetworkError = () => {
            const errorDiv = document.getElementById('network-error');
            if (errorDiv) {
                errorDiv.remove();
            }
        };

        // Restore saved theme on load
        (function(){
            try {
                const saved = localStorage.getItem('cf-theme') || 'light';
                document.body.setAttribute('data-theme', saved);
                document.querySelectorAll('.theme-option').forEach(el=>{
                    el.classList.toggle('active', el.getAttribute('data-theme') === saved);
                });
            } catch(e) {}
        })();
        // Use a placeholder for the Open Charge Map API key, which can be updated in the settings
        let openChargeMapApiKey = "6aa27df2-0e7d-4ce3-9787-5e869d304fd7"; 

        // Firebase Service Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
            signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup,
            signOut, updateProfile, updatePassword, reauthenticateWithCredential, EmailAuthProvider,
            setPersistence, browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, getDoc, addDoc, collection,
            query, onSnapshot, serverTimestamp, deleteDoc, GeoPoint, where, updateDoc, getDocs,
            initializeFirestore, persistentLocalCache, persistentMultipleTabManager, writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, ref, uploadBytes, getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Initialize Firebase with error handling
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = initializeFirestore(app, {
            localCache: persistentLocalCache({ tabManager: persistentMultipleTabManager() })
        });
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization failed:', error);
            showMessage('Failed to initialize database. Some features may not work.', 5000, 'error');
            // Create mock objects to prevent crashes
            auth = { currentUser: null };
            db = null;
        }
        const storage = getStorage(app);

        // Enable Persistence
        (async () => {
            try {
                await setPersistence(auth, browserLocalPersistence);
                console.log("Firebase persistence enabled (new cache API).");
            } catch (error) {
                console.error("Firebase persistence error:", error);
            }
        })();

        // Collapsible theme panel behavior and click handlers
        (function(){
            const panel = document.getElementById('theme-panel');
            const toggleBtn = document.getElementById('theme-toggle');
            if (toggleBtn && panel) {
                toggleBtn.addEventListener('click', () => panel.classList.toggle('hidden'));
            }
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    const theme = opt.getAttribute('data-theme');
                    uiManager.themeManager.setTheme(theme);
                    document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('active'));
                    opt.classList.add('active');
                    
                    // Update map themes when app theme changes
                    updateMapThemes();
                });
            });
        })();

        // Map Themes
        const getMapTheme = (appTheme) => {
            const themes = {
                light: [
                    { elementType: "geometry", stylers: [{ color: "#f5f5f5" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#616161" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#f5f5f5" }] },
                    { featureType: "water", elementType: "geometry", stylers: [{ color: "#c9c9c9" }] },
                    { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#9e9e9e" }] },
                    { featureType: "road", elementType: "geometry", stylers: [{ color: "#ffffff" }] },
                    { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
                    { featureType: "poi", elementType: "geometry", stylers: [{ color: "#eeeeee" }] },
                    { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
                    { featureType: "transit", elementType: "geometry", stylers: [{ color: "#e5e5e5" }] },
                    { featureType: "transit", elementType: "labels.text.fill", stylers: [{ color: "#9e9e9e" }] },
                    { featureType: "administrative", elementType: "geometry", stylers: [{ color: "#e5e5e5" }] },
                    { featureType: "administrative", elementType: "labels.text.fill", stylers: [{ color: "#bdbdbd" }] }
                ],
                dark: [
                    { elementType: "geometry", stylers: [{ color: "#212121" }] },
                    { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#212121" }] },
                    { featureType: "administrative", elementType: "geometry", stylers: [{ color: "#757575" }] },
                    { featureType: "administrative.country", elementType: "labels.text.fill", stylers: [{ color: "#9e9e9e" }] },
                    { featureType: "administrative.land_parcel", stylers: [{ visibility: "off" }] },
                    { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#bdbdbd" }] },
                    { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
                    { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#181818" }] },
                    { featureType: "poi.park", elementType: "labels.text.fill", stylers: [{ color: "#616161" }] },
                    { featureType: "poi.park", elementType: "labels.text.stroke", stylers: [{ color: "#1b1b1b" }] },
                    { featureType: "road", elementType: "geometry.fill", stylers: [{ color: "#2c2c2c" }] },
                    { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#8a8a8a" }] },
                    { featureType: "road.arterial", elementType: "geometry", stylers: [{ color: "#373737" }] },
                    { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#3c3c3c" }] },
                    { featureType: "road.highway.controlled_access", elementType: "geometry", stylers: [{ color: "#4e4e4e" }] },
                    { featureType: "road.local", elementType: "labels.text.fill", stylers: [{ color: "#616161" }] },
                    { featureType: "transit", elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
                    { featureType: "water", elementType: "geometry", stylers: [{ color: "#000000" }] },
                    { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#3d3d3d" }] }
                ],
                cyberpunk: [
                    { elementType: "geometry", stylers: [{ color: "#0a0a0a" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#ff0080" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#0a0a0a" }] },
                    { featureType: "water", elementType: "geometry", stylers: [{ color: "#001122" }] },
                    { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#00ffff" }] },
                    { featureType: "road", elementType: "geometry", stylers: [{ color: "#1a1a1a" }] },
                    { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#ff0080" }] },
                    { featureType: "poi", elementType: "geometry", stylers: [{ color: "#0f0f0f" }] },
                    { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#00ffff" }] },
                    { featureType: "transit", elementType: "geometry", stylers: [{ color: "#1a1a1a" }] },
                    { featureType: "transit", elementType: "labels.text.fill", stylers: [{ color: "#ff0080" }] },
                    { featureType: "administrative", elementType: "geometry", stylers: [{ color: "#1a1a1a" }] },
                    { featureType: "administrative", elementType: "labels.text.fill", stylers: [{ color: "#00ffff" }] }
                ],
                ocean: [
                    { elementType: "geometry", stylers: [{ color: "#0c4a6e" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#0891b2" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#0c4a6e" }] },
                    { featureType: "water", elementType: "geometry", stylers: [{ color: "#0e7490" }] },
                    { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#67e8f9" }] },
                    { featureType: "road", elementType: "geometry", stylers: [{ color: "#155e75" }] },
                    { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#0891b2" }] },
                    { featureType: "poi", elementType: "geometry", stylers: [{ color: "#164e63" }] },
                    { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#67e8f9" }] },
                    { featureType: "transit", elementType: "geometry", stylers: [{ color: "#155e75" }] },
                    { featureType: "transit", elementType: "labels.text.fill", stylers: [{ color: "#0891b2" }] },
                    { featureType: "administrative", elementType: "geometry", stylers: [{ color: "#155e75" }] },
                    { featureType: "administrative", elementType: "labels.text.fill", stylers: [{ color: "#67e8f9" }] }
                ]
            };
            return themes[appTheme] || themes.dark;
        };

        const updateMapThemes = () => {
            const currentTheme = document.body.getAttribute('data-theme') || 'light';
            const mapTheme = getMapTheme(currentTheme);
            
            if (mainMap) mainMap.setOptions({ styles: mapTheme });
            if (nearMeMap) nearMeMap.setOptions({ styles: mapTheme });
            if (liveNavigationMap) liveNavigationMap.setOptions({ styles: mapTheme });
            if (vendorMap) vendorMap.setOptions({ styles: mapTheme });
        };

        // Global App State
        let mainMap, nearMeMap, liveNavigationMap, directionsService, chargingChart, geocoder, placesService, vendorMap;
        let allChargers = [];
        let userVehicles = [];
        let chargerMarkers = [];
        let nearMeChargerMarkers = [];
        let vendorChargerMarkers = [];
        let vendorChargersData = []; // To store vendor charger data for the map
        let userLocationMarker = null; // This will be the moving blue dot for live navigation
        let nearMeUserMarker = null; // This is the static pin for the "Chargers Near Me" map
        let watchId = null;
        const MASTER_KEY = "25annu30athu";
        let googleMapsLoaded = false;
        let alternativeRouteRenderers = []; // To hold renderers for alternative routes
        let segmentRenderers = []; // To hold renderers for intermediate planning segments
        let waypoints = []; // To store user-added waypoints
        let isMuted = false; // To control voice navigation
        let suggestionInterval = null; // To hold the interval for suggestions
        let lastSuggestionTime = { breakfast: 0, lunch: 0, dinner: 0, lodging: 0 };
        
        let currentRoute = {
            vehicle: null,
            navigationDirections: null, 
            selectedChargerId: null,
            chargersOnRoute: [], 
            selectedPlace: null,
            currentLegIndex: 0,
            currentStepIndex: 0,
            isAtLegEnd: false,
            finalOrigin: null,
            finalDestination: null,
            currentOrigin: null,
            plannedWaypoints: [],
            isPlanning: false,
            completeChargerList: [],
            currentCharge: 100, // Tracks battery percentage throughout planning
            alternativeRoutesResponse: null,
            selectedRouteIndex: null
        };
        
        // --- All functions are defined here for proper scoping ---
        
        const showMessage = (message, duration = 3000, type = 'info') => {
            const msgBox = document.getElementById('message-box');
            const msgText = document.getElementById('message-text');
            if(!msgBox || !msgText) return;
            msgText.textContent = message;
            msgBox.className = `message-box glass text-white show`;
            
            // If duration is 0, return a function to clear the message
            if (duration === 0) {
                return () => hideMessage();
            }
            
            setTimeout(() => hideMessage(), duration);
        };

        const hideMessage = () => {
            const msgBox = document.getElementById('message-box');
            if(msgBox) msgBox.className = 'message-box glass text-white';
        };

        const showSection = (sectionId) => {
            uiManager.showSection(sectionId);
            window.location.hash = sectionId;

            // Trigger map resize for all maps to ensure they render correctly when their section becomes visible
            setTimeout(() => {
                if (mainMap && sectionId === 'find-chargers') {
                    google.maps.event.trigger(mainMap, 'resize');
                }
                if (nearMeMap && sectionId === 'chargers-near-me') {
                    google.maps.event.trigger(nearMeMap, 'resize');
                }
                if (liveNavigationMap && sectionId === 'live-navigation') {
                    google.maps.event.trigger(liveNavigationMap, 'resize');
                }
                if (vendorMap && sectionId === 'dashboard' && document.getElementById('my-vmap').classList.contains('active')) {
                    google.maps.event.trigger(vendorMap, 'resize');
                }
            }, 150);
        };
        
        // Handle URL hash changes (back/forward navigation)
        window.onpopstate = function(event) {
            const hash = window.location.hash.replace('#', '');
            if (hash) {
                // Handle special dashboard tabs
                if (hash.startsWith('dashboard-')) {
                    const tabId = hash.replace('dashboard-', '');
                    showSection('dashboard');
                    showVendorTab(tabId);
                } else {
                    showSection(hash);
                }
            } else {
                showSection('home');
            }
        };

        // Handle initial page load with hash
        const handleInitialHash = () => {
            const hash = window.location.hash.replace('#', '');
            if (hash) {
                // Handle special dashboard tabs
                if (hash.startsWith('dashboard-')) {
                    const tabId = hash.replace('dashboard-', '');
                    showSection('dashboard');
                    showVendorTab(tabId);
                } else {
                    showSection(hash);
                }
            }
        };

        const toggleHamburgerMenu = () => {
            uiManager.toggleHamburgerMenu();
        };
        
        const renderAuthForms = () => {
            const authSection = document.getElementById('auth-section');
            if(!authSection) return;
            authSection.innerHTML = `
                <div id="portal-choice" class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg text-center">
                    <h1 class="text-3xl font-bold text-indigo-600 mb-4">⚡ ChargeFranchise</h1>
                    <p class="text-gray-600 mb-6">Welcome! Please select your portal.</p>
                    <div class="space-y-4">
                        <button onclick="showLogin('user')" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">User Portal</button>
                        <button onclick="showLogin('vendor')" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">Vendor / Executive Portal</button>
                    </div>
                </div>
                <div id="login-container" class="max-w-md w-full" style="display:none;"></div>
                <div id="signup-container" class="max-w-md w-full" style="display:none;"></div>
            `;
        };

        const showLogin = (role) => {
            document.getElementById('portal-choice').style.display = 'none';
            const container = document.getElementById('login-container');
            container.style.display = 'block';
            let passwordLabel = role === 'user' ? 'Password' : 'Password / Key / Master Key';
            let loginButtonText = role === 'user' ? 'Login' : 'Login / Verify';
            container.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-indigo-600 mb-6 text-center">Login to ${role === 'user' ? 'User' : 'Vendor'} Portal</h2>
                    <div class="space-y-4" id="login-form">
                        <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 border rounded-lg form-field">
                        <input type="password" id="loginPassword" placeholder="${passwordLabel}" class="w-full p-3 border rounded-lg form-field">
                        <button id="login-btn" onclick="login('${role}')" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">${loginButtonText}</button>
                        ${role === 'user' ? `<button onclick="googleLogin()" class="w-full flex items-center justify-center gap-3 bg-white text-gray-700 py-3 rounded-lg border hover:bg-gray-100">
                           <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="h-5"> Sign in with Google
                        </button>` : ''}
                        <div id="loginError" class="text-red-500 text-sm"></div>
                        <p class="text-sm text-gray-500 pt-2">New here? <a href="#" onclick="showSignUp('user')" class="text-indigo-600 hover:underline">Create a user account</a></p>
                        <button onclick="backToPortalChoice()" class="w-full bg-gray-400 text-white py-3 rounded-lg font-semibold hover:bg-gray-500">Back</button>
                    </div>
                </div>
            `;
            setupEnterKeyNavigation();
        };

        const showSignUp = (role) => {
            document.getElementById('portal-choice').style.display = 'none';
            document.getElementById('login-container').style.display = 'none';
            const container = document.getElementById('signup-container');
            container.style.display = 'block';
            container.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-indigo-600 mb-6 text-center">Create a User Account</h2>
                    <p class="text-center text-gray-500 mb-4">Vendor accounts are created after executive verification.</p>
                    <div class="space-y-4" id="signup-form">
                        <input type="email" id="signupEmail" placeholder="Email" class="w-full p-3 border rounded-lg form-field">
                        <input type="password" id="signupPassword" placeholder="Password" class="w-full p-3 border rounded-lg form-field">
                        <input type="text" id="signupName" placeholder="Name" class="w-full p-3 border rounded-lg form-field">
                        <button id="signup-btn" onclick="signUp('user')" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">Create Account</button>
                        
                        <div class="relative flex py-2 items-center">
                            <div class="flex-grow border-t border-gray-300"></div>
                            <span class="flex-shrink mx-4 text-gray-500 text-sm">OR</span>
                            <div class="flex-grow border-t border-gray-300"></div>
                        </div>

                        <button onclick="googleLogin()" class="w-full flex items-center justify-center gap-3 bg-white text-gray-700 py-3 rounded-lg border hover:bg-gray-100">
                           <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="h-5"> Sign up with Google
                        </button>

                        <div id="signupError" class="text-red-500 text-sm"></div>
                        <p class="text-sm text-gray-500 pt-2">Already have an account? <a href="#" onclick="showLogin('user')" class="text-indigo-600 hover:underline">Login</a></p>
                        <button onclick="backToPortalChoice()" class="w-full bg-gray-400 text-white py-3 rounded-lg font-semibold hover:bg-gray-500">Back</button>
                    </div>
                </div>
            `;
            setupEnterKeyNavigation();
        };

        const backToPortalChoice = () => {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('signup-container').style.display = 'none';
            document.getElementById('portal-choice').style.display = 'block';
        };
        
        const setupEnterKeyNavigation = () => {
            const formContainers = ['login-form', 'signup-form', 'vehicle-form', 'home-charger-form', 'vendor-charger-form', 'route-form', 'edit-charger-form'];
            formContainers.forEach(formId => {
                const container = document.getElementById(formId);
                if (!container) return;
                const fields = [...container.querySelectorAll('.form-field')];
                const submitButton = container.querySelector('button[id$="-btn"]');
                fields.forEach((field, index) => {
                    field.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const nextField = fields[index + 1];
                            if (nextField) nextField.focus();
                            else if (submitButton) submitButton.click();
                        }
                    });
                });
            });
        };

        const loadUserVehicles = (uid) => {
            const q = query(collection(db, "users", uid, "vehicles"));
            onSnapshot(q, (snapshot) => {
                userVehicles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const vehicleSelect = document.getElementById('vehicle-select');
                const listEl = document.getElementById('my-vehicles-list');
                
                // Update home button text based on vehicle count
                updateVehicleButton(userVehicles.length);
                
                if (vehicleSelect) {
                    vehicleSelect.innerHTML = '<option value="">Select a vehicle</option>';
                    userVehicles.forEach(v => {
                        const option = document.createElement('option');
                        option.value = v.id;
                        option.textContent = `${v.make} ${v.model} (${v.regNo})`;
                        vehicleSelect.appendChild(option);
                    });
                }
                if (listEl) {
                    listEl.innerHTML = userVehicles.length === 0 ? `<p style="color: var(--text-secondary);">No vehicles added yet.</p>` : '';
                    userVehicles.forEach(vehicle => {
                        const item = document.createElement('div');
                        item.className = 'vehicle-card flex justify-between items-center';
                        item.innerHTML = `<div><p class="font-semibold" style="color: var(--text-primary);">${vehicle.make} ${vehicle.model}</p><p class="text-sm" style="color: var(--text-secondary);">${vehicle.regNo}</p></div>
                        <button onclick=\"deleteVehicle('${vehicle.id}')\" class=\"font-semibold\" style=\"color:#ef4444;\">Delete</button>`;
                        listEl.appendChild(item);
                    });
                }
            });
        };

        const updateVehicleButton = (vehicleCount) => {
            vehicleManager.updateVehicleButton();
        };

        // Trip History Management
        let userTrips = [];
        let tripStats = { totalTrips: 0, totalDistance: 0, totalEnergy: 0, co2Saved: 0 };

        const loadTripHistory = (uid) => {
            const q = query(collection(db, "users", uid, "trips"));
            onSnapshot(q, (snapshot) => {
                userTrips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTripHistory();
                updateTripStats();
            });
        };

        const addTripToHistory = async (tripData) => {
            if (!auth.currentUser) return;
            
            try {
                // Create a unique trip identifier based on route
                const tripId = `${tripData.from.toLowerCase().replace(/\s+/g, '_')}_to_${tripData.to.toLowerCase().replace(/\s+/g, '_')}`;
                
                // Check if this exact trip already exists
                const existingTripQuery = query(
                    collection(db, "users", auth.currentUser.uid, "trips"),
                    where("tripId", "==", tripId)
                );
                
                const existingTrips = await getDocs(existingTripQuery);
                
                if (!existingTrips.empty) {
                    // Trip exists, increment frequency
                    const existingTrip = existingTrips.docs[0];
                    const currentFreq = existingTrip.data().frequency || 1;
                    
                    await updateDoc(existingTrip.ref, {
                        frequency: currentFreq + 1,
                        lastCompletedAt: serverTimestamp(),
                        totalDistance: (existingTrip.data().totalDistance || 0) + (tripData.distance || 0),
                        totalEnergyUsed: (existingTrip.data().totalEnergyUsed || 0) + (tripData.energyUsed || 0),
                        totalDuration: (existingTrip.data().totalDuration || 0) + (tripData.duration || 0)
                    });
                    
                    showMessage(`Trip updated! Frequency: ${currentFreq + 1}`, 3000, 'success');
                } else {
                    // New trip, create with frequency 1
            const trip = {
                        tripId: tripId,
                        from: tripData.from,
                        to: tripData.to,
                        distance: tripData.distance || 0,
                        duration: tripData.duration || 0,
                        energyUsed: tripData.energyUsed || 0,
                        vehicle: tripData.vehicle || 'Unknown Vehicle',
                        chargingStops: tripData.chargingStops || 0,
                        waypoints: tripData.waypoints || 0,
                        frequency: 1,
                completedAt: serverTimestamp(),
                        lastCompletedAt: serverTimestamp(),
                        totalDistance: tripData.distance || 0,
                        totalEnergyUsed: tripData.energyUsed || 0,
                        totalDuration: tripData.duration || 0,
                userId: auth.currentUser.uid
            };
            
                await addDoc(collection(db, "users", auth.currentUser.uid, "trips"), trip);
                    showMessage('Trip completed and added to history!', 3000, 'success');
                }
            } catch (error) {
                console.error('Error saving trip:', error);
                showMessage('Failed to save trip to history', 3000, 'error');
            }
        };

        const renderTripHistory = () => {
            const listEl = document.getElementById('trip-history-list');
            if (!listEl) return;

            console.log('Rendering trip history with', userTrips.length, 'trips');
            console.log('Trip data:', userTrips);

            if (userTrips.length === 0) {
                listEl.innerHTML = `<p style="color: var(--text-secondary);">No trips completed yet. Start planning your first route!</p>`;
                return;
            }

            listEl.innerHTML = '';
            userTrips.sort((a, b) => (b.lastCompletedAt?.seconds || b.completedAt?.seconds) - (a.lastCompletedAt?.seconds || a.completedAt?.seconds)).forEach(trip => {
                console.log('Rendering trip:', trip);
                console.log('Trip frequency:', trip.frequency);
                
                const tripEl = document.createElement('div');
                tripEl.className = 'glass p-4 rounded-lg';
                
                // Handle undefined or missing data
                const from = trip.from || trip.startLocation || 'Unknown Start';
                const to = trip.to || trip.endLocation || 'Unknown End';
                const vehicle = trip.vehicle || trip.vehicleName || 'Unknown Vehicle';
                
                const completedDate = trip.lastCompletedAt?.toDate ? trip.lastCompletedAt.toDate().toLocaleDateString() : 
                                    (trip.completedAt?.toDate ? trip.completedAt.toDate().toLocaleDateString() : 'Unknown date');
                const duration = trip.duration ? formatDuration(trip.duration) : 'N/A';
                const frequency = trip.frequency || 1;
                
                console.log('Final frequency value:', frequency);
                
                tripEl.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-semibold" style="color: var(--text-primary);">${from} → ${to}</h4>
                            <p class="text-sm" style="color: var(--text-secondary);">Last completed: ${completedDate}</p>
                            ${frequency > 1 ? `<p class="text-xs" style="color: var(--accent-color);">Completed ${frequency} times</p>` : ''}
                        </div>
                        <div class="text-right">
                            <span class="px-2 py-1 rounded-full text-xs status-available">${vehicle}</span>
                            ${frequency > 1 ? `<div class="mt-1 px-2 py-1 rounded-full text-xs" style="background: var(--accent); color: white;">${frequency}x</div>` : ''}
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div><span style="color: var(--text-secondary);">Distance:</span> <span style="color: var(--text-primary);">${trip.distance?.toFixed(1) || 0} km</span></div>
                        <div><span style="color: var(--text-secondary);">Duration:</span> <span style="color: var(--text-primary);">${duration}</span></div>
                        <div><span style="color: var(--text-secondary);">Energy:</span> <span style="color: var(--text-primary);">${trip.energyUsed?.toFixed(1) || 0} kWh</span></div>
                    </div>
                    ${trip.chargingStops > 0 ? `<div class="mt-2 text-sm" style="color: var(--text-secondary);">Charging stops: ${trip.chargingStops}</div>` : ''}
                    ${frequency > 1 ? `<div class="mt-2 text-sm" style="color: var(--text-secondary);">Total distance: ${trip.totalDistance?.toFixed(1) || 0} km | Total energy: ${trip.totalEnergyUsed?.toFixed(1) || 0} kWh</div>` : ''}
                `;
                listEl.appendChild(tripEl);
            });
        };

        const updateTripStats = () => {
            const stats = userTrips.reduce((acc, trip) => {
                const frequency = trip.frequency || 1;
                const totalDistance = trip.totalDistance || (trip.distance || 0) * frequency;
                const totalEnergy = trip.totalEnergyUsed || (trip.energyUsed || 0) * frequency;
                
                return {
                    totalTrips: acc.totalTrips + frequency,
                    totalDistance: acc.totalDistance + totalDistance,
                    totalEnergy: acc.totalEnergy + totalEnergy,
                    co2Saved: acc.co2Saved + (totalDistance * 0.21) // Approx 210g CO2/km saved vs petrol
                };
            }, { totalTrips: 0, totalDistance: 0, totalEnergy: 0, co2Saved: 0 });

            document.getElementById('total-trips').textContent = stats.totalTrips;
            document.getElementById('total-distance').textContent = `${stats.totalDistance.toFixed(0)} km`;
            document.getElementById('total-energy').textContent = `${stats.totalEnergy.toFixed(0)} kWh`;
            document.getElementById('co2-saved').textContent = `${stats.co2Saved.toFixed(0)} kg`;
        };

        const exportTripHistory = () => {
            if (userTrips.length === 0) {
                showMessage('No trips to export', 3000, 'error');
                return;
            }

            const csvContent = "data:text/csv;charset=utf-8," + 
                "Last Completed,From,To,Distance (km),Duration,Energy Used (kWh),Vehicle,Charging Stops,Frequency,Total Distance (km),Total Energy (kWh)\n" +
                userTrips.map(trip => {
                    const date = trip.lastCompletedAt?.toDate ? trip.lastCompletedAt.toDate().toLocaleDateString() : 
                                (trip.completedAt?.toDate ? trip.completedAt.toDate().toLocaleDateString() : '');
                    const duration = trip.duration ? formatDuration(trip.duration) : '';
                    const frequency = trip.frequency || 1;
                    const totalDistance = trip.totalDistance || (trip.distance || 0) * frequency;
                    const totalEnergy = trip.totalEnergyUsed || (trip.energyUsed || 0) * frequency;
                    const from = trip.from || trip.startLocation || 'Unknown Start';
                    const to = trip.to || trip.endLocation || 'Unknown End';
                    const vehicle = trip.vehicle || trip.vehicleName || 'Unknown Vehicle';
                    
                    return `"${date}","${from}","${to}","${trip.distance || 0}","${duration}","${trip.energyUsed || 0}","${vehicle}","${trip.chargingStops || 0}","${frequency}","${totalDistance.toFixed(1)}","${totalEnergy.toFixed(1)}"`;
                }).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "trip_history.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage('Trip history exported successfully!');
        };

        const clearTripHistory = async () => {
            if (!auth.currentUser) {
                showMessage('You must be logged in to clear trip history', 3000, 'error');
                return;
            }

            console.log('Current userTrips length:', userTrips.length);
            console.log('Current userTrips:', userTrips);

            if (userTrips.length === 0) {
                showMessage('No trips to clear', 3000, 'info');
                return;
            }

            if (confirm(`Are you sure you want to clear all ${userTrips.length} trips from your history? This action cannot be undone.`)) {
                try {
                    console.log('Starting to clear trip history for user:', auth.currentUser.uid);
                    
                    // Get fresh data from Firebase to ensure we have all trips
                    const q = query(collection(db, "users", auth.currentUser.uid, "trips"));
                    const snapshot = await getDocs(q);
                    const allTrips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    console.log('Found trips in Firebase:', allTrips.length);
                    console.log('Firebase trips:', allTrips);
                    
                    if (allTrips.length === 0) {
                        showMessage('No trips found in database', 3000, 'info');
                        return;
                    }
                    
                    // Delete all trips from Firebase
                    const deletePromises = allTrips.map(async (trip) => {
                        const tripRef = doc(db, "users", auth.currentUser.uid, "trips", trip.id);
                        console.log('Deleting trip from Firebase:', trip.id);
                        return deleteDoc(tripRef);
                    });
                    
                    await Promise.all(deletePromises);
                    
                    // Clear local array
                    userTrips = [];
                    tripStats = { totalTrips: 0, totalDistance: 0, totalEnergy: 0, co2Saved: 0 };
                    
                    // Update UI immediately
                    renderTripHistory();
                    updateTripStats();
                    
                    showMessage(`Successfully cleared ${allTrips.length} trips from history!`, 3000, 'success');
                } catch (error) {
                    console.error('Error clearing trip history:', error);
                    showMessage('Failed to clear trip history: ' + error.message, 3000, 'error');
                }
            }
        };

        const cleanOldData = async () => {
            if (!auth.currentUser) {
                showMessage('You must be logged in to clean old data', 3000, 'error');
                return;
            }

            try {
                console.log('Starting to clean old malformed data...');
                
                // Get all trips from Firebase
                const q = query(collection(db, "users", auth.currentUser.uid, "trips"));
                const snapshot = await getDocs(q);
                const allTrips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                console.log('Found trips in Firebase:', allTrips.length);
                
                if (allTrips.length === 0) {
                    showMessage('No trips found to clean', 3000, 'info');
                    return;
                }
                
                // Find malformed trips (trips with missing or invalid data)
                const malformedTrips = allTrips.filter(trip => {
                    return !trip.from || !trip.to || 
                           trip.distance === 0 || trip.distance === undefined ||
                           trip.energyUsed === 0 || trip.energyUsed === undefined ||
                           !trip.completedAt || !trip.lastCompletedAt;
                });
                
                console.log('Found malformed trips:', malformedTrips.length);
                console.log('Malformed trips:', malformedTrips);
                
                if (malformedTrips.length === 0) {
                    showMessage('No malformed data found. All trips are properly formatted!', 3000, 'success');
                    return;
                }
                
                if (confirm(`Found ${malformedTrips.length} malformed trips. Do you want to delete them? This will remove trips with missing data like "Unknown date" and "0 km".`)) {
                    // Delete malformed trips
                    const deletePromises = malformedTrips.map(async (trip) => {
                        const tripRef = doc(db, "users", auth.currentUser.uid, "trips", trip.id);
                        console.log('Deleting malformed trip:', trip.id);
                        return deleteDoc(tripRef);
                    });
                    
                    await Promise.all(deletePromises);
                    
                    showMessage(`Successfully cleaned ${malformedTrips.length} malformed trips!`, 3000, 'success');
                }
            } catch (error) {
                console.error('Error cleaning old data:', error);
                showMessage('Failed to clean old data: ' + error.message, 3000, 'error');
            }
        };

        // Make functions globally accessible
        window.clearTripHistory = clearTripHistory;
        window.exportTripHistory = exportTripHistory;
        window.cleanOldData = cleanOldData;



        const updateMapMarkers = (mapInstance, markerArray, markersToShow) => {
            markerArray.forEach(marker => marker.setMap(null));
            markerArray.length = 0;

            const markerData = markersToShow || allChargers;

            // Custom SVG icons for different charger types
            const createCustomIcon = (color, type) => {
                const svg = `
                    <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="18" fill="${color}" stroke="white" stroke-width="2"/>
                        <text x="20" y="26" text-anchor="middle" fill="white" font-family="Arial" font-size="16" font-weight="bold">⚡</text>
                        ${type === 'home' ? '<circle cx="20" cy="20" r="12" fill="none" stroke="white" stroke-width="1" stroke-dasharray="2,2"/>' : ''}
                    </svg>
                `;
                return {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg),
                    scaledSize: new google.maps.Size(40, 40),
                    anchor: new google.maps.Point(20, 20)
                };
            };

            markerData.forEach(charger => {
                if (!charger.location) return;
                
                let icon;
                if (charger.type === 'home' || charger.IsPrivate) {
                    icon = createCustomIcon('#8B5CF6', 'home'); // Purple for private/home
                } else if (charger.status !== 'available') {
                    icon = createCustomIcon('#EF4444', 'unavailable'); // Red for in-use/maintenance
                } else {
                    icon = createCustomIcon('#3B82F6', 'available'); // Blue for available public
                }
                
                const marker = new google.maps.Marker({
                    position: { lat: charger.location.latitude, lng: charger.location.longitude },
                    map: mapInstance, 
                    title: charger.name || charger.AddressInfo?.Title,
                    icon: icon
                });
                
                let infoWindowContent = `<div><strong>${charger.name || charger.AddressInfo?.Title || 'N/A'}</strong><br>
                    ${charger.rate || charger.Connections?.[0]?.PowerKW || 'N/A'} kW | ${charger.type || (charger.IsPrivate ? 'Private' : 'Public')}<br>
                    Status: <span class="font-bold ${charger.status === 'available' ? 'text-green-600' : 'text-red-600'}">${charger.status || 'available'}</span>`;

                if (mapInstance === nearMeMap) {
                    infoWindowContent += `<br><button onclick="navigateToCharger(${charger.location.latitude}, ${charger.location.longitude})" class="mt-2 bg-indigo-500 text-white text-xs py-1 px-2 rounded-md hover:bg-indigo-600">Navigate</button>`;
                }
                infoWindowContent += `</div>`;

                const infoWindow = new google.maps.InfoWindow({ content: infoWindowContent });

                marker.addListener('click', () => infoWindow.open(mapInstance, marker));
                markerArray.push(marker);
            });
        };
        
        const displayRouteInfo = (legs, chargers, vehicle, directionsResult) => {
            const routeDetailsEl = document.getElementById('route-details');
            let totalDistance = legs.reduce((sum, leg) => sum + leg.distance.value, 0);
            let totalDuration = legs.reduce((sum, leg) => sum + (leg.duration_in_traffic ? leg.duration_in_traffic.value : leg.duration.value), 0);
            
            // More accurate charging time calculation
            let chargingTime = 0;
            chargers.forEach(charger => {
                // Use the dynamically calculated chargeNeededKwh if available
                const energyNeeded = charger.chargeNeededKwh || (vehicle.batteryCapacity * 0.7); // Fallback to 70% charge
                chargingTime += (energyNeeded / (charger.rate || 11)) * 3600; // Default to 11kW if rate is unknown
            });

            const totalTripTime = totalDuration + chargingTime;
            let html = `<h4 class="font-bold text-lg mb-2">Trip Summary</h4>
                        <p><strong>Total Distance:</strong> ${(totalDistance / 1000).toFixed(1)} km</p>
                        <p><strong>Driving Time (with traffic):</strong> ${formatDuration(totalDuration)}</p>`;
            if(chargers.length > 0) {
                html += `<p><strong>Est. Charging Time:</strong> ${formatDuration(chargingTime)}</p>
                         <p class="font-bold"><strong>Total Trip Time:</strong> ${formatDuration(totalTripTime)}</p>
                         <h5 class="font-semibold mt-2">Charging Stops:</h5><ul class="list-disc pl-5">`;
                chargers.forEach(c => { 
                    html += `<li>${c.name || c.AddressInfo?.Title} (${c.rate || c.Connections?.[0]?.PowerKW || 'N/A'} kW) - Arrive at ~${c.arrivalCharge.toFixed(0)}%</li>`; 
                });
                html += `</ul>`;
            } else {
                 html += `<p class="text-green-600 font-semibold mt-2">No charging stops needed for this trip!</p>`;
            }
            html += `<p class="text-sm mt-2">Estimated arrival charge: ${currentRoute.currentCharge.toFixed(0)}%</p>`;
            html += `<button onclick="startInAppNavigation()" class="mt-4 w-full bg-green-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-600">Start Live Navigation</button>`;
            routeDetailsEl.innerHTML = html;
            routeDetailsEl.classList.remove('hidden');

            clearAlternativeRoutes();
            const finalRenderer = new google.maps.DirectionsRenderer({
                map: mainMap,
                directions: directionsResult,
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: '#4f46e5',
                    strokeWeight: 6,
                    strokeOpacity: 0.9
                }
            });
            alternativeRouteRenderers.push(finalRenderer);
            addRouteMarkers(directionsResult, chargers);
        };

        const addRouteMarkers = (directionsResult, chargers) => {
            chargerMarkers.forEach(marker => marker.setMap(null));
            chargerMarkers = [];

            const startMarker = new google.maps.Marker({
                position: directionsResult.routes[0].legs[0].start_location,
                map: mainMap,
                title: 'Start',
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
                    scaledSize: new google.maps.Size(40, 40)
                }
            });
            chargerMarkers.push(startMarker);

            const endMarker = new google.maps.Marker({
                position: directionsResult.routes[0].legs[directionsResult.routes[0].legs.length - 1].end_location,
                map: mainMap,
                title: 'Destination',
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                    scaledSize: new google.maps.Size(40, 40)
                }
            });
            chargerMarkers.push(endMarker);

            chargers.forEach(charger => {
                const position = { lat: charger.location.latitude, lng: charger.location.longitude };
                const stopMarker = new google.maps.Marker({
                    position: position,
                    map: mainMap,
                    title: `Charger: ${charger.name || charger.AddressInfo?.Title}`,
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                        scaledSize: new google.maps.Size(40, 40)
                    }
                });

                stopMarker.addListener('click', () => {
                    const infoWindow = new google.maps.InfoWindow({
                        content: `<div><strong>${charger.name || charger.AddressInfo?.Title}</strong><p>Showing nearby places.</p></div>`
                    });
                    infoWindow.open(mainMap, stopMarker);
                    findNearbyPlaces(charger);
                    currentRoute.selectedPlace = null; 
                });

                chargerMarkers.push(stopMarker);
            });
        };

        const startInAppNavigation = () => {
            const directionsResult = currentRoute.navigationDirections;
            if (!directionsResult) {
                showMessage("No complete route available to navigate.", 3000, 'error');
                return;
            }

            showSection('live-navigation');
            updateMuteButtonUI();
            
            const liveMapElement = document.getElementById('live-navigation-map');
            if (!liveNavigationMap) {
                const currentTheme = document.body.getAttribute('data-theme') || 'light';
                const mapTheme = getMapTheme(currentTheme);
                
                liveNavigationMap = new google.maps.Map(liveMapElement, {
                    zoom: 15,
                    center: directionsResult.routes[0].legs[0].start_location,
                    mapTypeControl: false,
                    mapTypeId: google.maps.MapTypeId.TERRAIN,
                    styles: mapTheme
                });
            } else {
                liveNavigationMap.setCenter(directionsResult.routes[0].legs[0].start_location);
            }

            setTimeout(() => {
                google.maps.event.trigger(liveNavigationMap, 'resize');
                liveNavigationMap.setCenter(directionsResult.routes[0].legs[0].start_location);
            }, 200);


            const liveDirectionsRenderer = new google.maps.DirectionsRenderer({ map: liveNavigationMap, suppressMarkers: true });
            liveDirectionsRenderer.setDirections(directionsResult);

            const placeInfoBox = document.getElementById('selected-place-info');
            if (currentRoute.selectedPlace) {
                document.getElementById('selected-place-text').textContent = `${currentRoute.selectedPlace.name} (${currentRoute.selectedPlace.vicinity})`;
                placeInfoBox.classList.remove('hidden');
            } else {
                placeInfoBox.classList.add('hidden');
            }

            if (navigator.geolocation) {
                if (userLocationMarker) userLocationMarker.setMap(null);
                userLocationMarker = new google.maps.Marker({
                    position: liveNavigationMap.getCenter(),
                    map: liveNavigationMap,
                    title: 'Your Location',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: '#4285F4',
                        fillOpacity: 1,
                        strokeWeight: 2,
                        strokeColor: 'white'
                    }
                });

                if (watchId) navigator.geolocation.clearWatch(watchId);
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        userLocationMarker.setPosition(pos);
                        liveNavigationMap.panTo(pos);
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        showMessage("Failed to get live location. Check your device settings.", 4000, 'error');
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                showMessage("Your browser does not support geolocation.", 4000, 'error');
            }
            
            currentRoute.currentLegIndex = 0;
            currentRoute.currentStepIndex = 0;
            currentRoute.isAtLegEnd = false;
            speak("Starting navigation.");
            displayCurrentStep();
        };
        
        const displayCurrentStep = () => {
            const directionsPanel = document.getElementById('turn-by-turn-directions');
            if (!directionsPanel || !currentRoute.navigationDirections) return;

            const route = currentRoute.navigationDirections.routes[0];
            if (!route) {
                directionsPanel.innerHTML = '<p>Route not available.</p>';
                return;
            }

            if (currentRoute.isAtLegEnd) {
                 const isFinalLeg = currentRoute.currentLegIndex >= route.legs.length - 1;
                 let arrivalMessage;
                 if (isFinalLeg) {
                     arrivalMessage = "You have arrived at your final destination!";
                     directionsPanel.innerHTML = `<div class="text-center p-4"><p class="text-lg font-bold text-green-600">${arrivalMessage}</p></div>`;
                 } else {
                     const leg = route.legs[currentRoute.currentLegIndex];
                     arrivalMessage = `You have arrived at your stop, ${leg.end_address}.`;
                     directionsPanel.innerHTML = `
                        <div class="text-center p-4">
                            <p class="text-lg font-bold text-indigo-600">Arrived at Stop:</p>
                            <p class="my-2">${leg.end_address}</p>
                            <button onclick="startNextLeg()" class="mt-4 w-full bg-green-500 text-white py-2 rounded-lg font-semibold hover:bg-green-600">Continue to Next Stop</button>
                        </div>`;
                 }
                 speak(arrivalMessage);
                 return;
            }

            const leg = route.legs[currentRoute.currentLegIndex];
            const step = leg.steps[currentRoute.currentStepIndex];

            if (!step) {
                directionsPanel.innerHTML = `<div class="text-center p-4"><p class="text-lg font-bold text-green-600">You have arrived!</p></div>`;
                speak("You have arrived!");
                return;
            }

            let html = `
                <div class="p-2">
                    <p class="text-sm text-gray-500">Next turn in: ${step.distance.text}</p>
                    <div class="text-xl font-bold text-gray-800 my-2">${step.instructions}</div>
                    <p class="text-sm text-gray-600">Leg ${currentRoute.currentLegIndex + 1} of ${route.legs.length} - Remaining: ${leg.distance.text}</p>
                </div>
                <div class="flex justify-between mt-4 border-t pt-2">
                    <button id="prev-step-btn" onclick="previousStep()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">&larr; Previous</button>
                    <button id="next-step-btn" onclick="nextStep()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Next &rarr;</button>
                </div>
            `;
            directionsPanel.innerHTML = html;
            
            const instructionText = step.instructions.replace(/<[^>]*>/g, '');
            speak(instructionText);

            if (currentRoute.currentLegIndex === 0 && currentRoute.currentStepIndex === 0) {
                document.getElementById('prev-step-btn').disabled = true;
                document.getElementById('prev-step-btn').classList.add('opacity-50', 'cursor-not-allowed');
            }
        };

        const startNextLeg = () => {
            currentRoute.isAtLegEnd = false;
            currentRoute.currentLegIndex++;
            currentRoute.currentStepIndex = 0;
            displayCurrentStep();
        };

        const nextStep = () => {
            const route = currentRoute.navigationDirections.routes[0];
            if (!route) return;

            const leg = route.legs[currentRoute.currentLegIndex];
            if (currentRoute.currentStepIndex < leg.steps.length - 1) {
                currentRoute.currentStepIndex++;
            } else { 
                currentRoute.isAtLegEnd = true;
            }
            displayCurrentStep();
        };

        const previousStep = () => {
            if (currentRoute.isAtLegEnd) {
                currentRoute.isAtLegEnd = false;
                displayCurrentStep();
                return;
            }

            const route = currentRoute.navigationDirections.routes[0];
            if (!route) return;

            if (currentRoute.currentStepIndex > 0) {
                currentRoute.currentStepIndex--;
            } else if (currentRoute.currentLegIndex > 0) {
                currentRoute.currentLegIndex--;
                const prevLeg = route.legs[currentRoute.currentLegIndex];
                currentRoute.currentStepIndex = prevLeg.steps.length - 1;
            }
            displayCurrentStep();
        };

        const stopInAppNavigation = () => {
            // Check if we should complete the trip
            if (currentRoute && currentRoute.from && currentRoute.to) {
                const tripData = {
                    from: currentRoute.from,
                    to: currentRoute.to,
                    distance: currentRoute.totalDistance / 1000, // Convert to km
                    duration: currentRoute.totalDuration,
                    energyUsed: currentRoute.estimatedEnergyUsed || 0,
                    vehicle: currentRoute.vehicle || 'Unknown Vehicle',
                    chargingStops: currentRoute.chargingStops || 0,
                    waypoints: waypoints.length
                };
                
                // Ask user if they completed the trip
                if (confirm('Did you complete this trip? This will add it to your trip history.')) {
                    addTripToHistory(tripData);
                }
            }
            
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            if (userLocationMarker) {
                userLocationMarker.setMap(null);
                userLocationMarker = null;
            }
            if (currentRoute) currentRoute.selectedPlace = null;
            document.getElementById('selected-place-info').classList.add('hidden');
            document.getElementById('turn-by-turn-directions').innerHTML = '';
            speak("Navigation stopped.");
            showSection('find-chargers'); 
            showMessage("Live navigation stopped.", 3000, 'info');
        };

        const formatDuration = (seconds) => {
            if (isNaN(seconds) || seconds === null) return 'N/A';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return `${h > 0 ? h + 'h ' : ''}${m}m`;
        };

        const signUp = async (role = 'user') => {
             if (role === 'vendor') {
                showMessage("Vendor registration is by executive approval only.", 4000, 'error');
                return;
            }
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const name = document.getElementById('signupName').value;
            const errorElement = document.getElementById('signupError');
            errorElement.textContent = '';
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: name });
                await setDoc(doc(db, 'users', userCredential.user.uid), { name, email, role: 'user', createdAt: serverTimestamp() });
                showMessage('Sign up successful!', 3000, 'success');
            } catch (error) { errorElement.textContent = error.message; }
        };

        const login = async (role) => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorElement = document.getElementById('loginError');
            errorElement.textContent = '';

            if (role === 'vendor' && password === MASTER_KEY) {
                await executiveVerify(email);
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                if (role === 'user') {
                    const userDoc = await getDoc(doc(db, "users", userCredential.user.uid));
                    if (userDoc.exists() && userDoc.data().role === 'user') {
                         showMessage('Login successful!', 3000, 'success');
                    } else {
                        await signOut(auth);
                        errorElement.textContent = `This account is not a registered user.`;
                    }
                } else if (role === 'vendor') {
                    const q = query(collection(db, "vendors"), where("uid", "==", userCredential.user.uid));
                    const vendorSnapshot = await getDocs(q);
                     if (!vendorSnapshot.empty) {
                         showMessage('Vendor login successful!', 3000, 'success');
                     } else {
                        await signOut(auth);
                        errorElement.textContent = `This account is not a registered vendor.`;
                     }
                }
            } catch (error) { errorElement.textContent = error.message; }
        };

        const executiveVerify = async (vendorEmail) => {
            try {
                const q = query(collection(db, "vendor_requests"), where("email", "==", vendorEmail), where("status", "==", "pending"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showMessage("No pending vendor request found for this email.", 4000, 'error');
                    return;
                }

                const requestDoc = querySnapshot.docs[0];
                const vendorName = requestDoc.data().name;
                
                // Check if a user with this email already exists in Firestore
                const userQuery = query(collection(db, "users"), where("email", "==", vendorEmail));
                const userSnapshot = await getDocs(userQuery);

                let vendorUid;
                if (!userSnapshot.empty) {
                    // User exists, promote them
                    const userDoc = userSnapshot.docs[0];
                    vendorUid = userDoc.id;
                    await updateDoc(userDoc.ref, { role: "vendor" });
                    showMessage(`User ${vendorEmail} has been promoted to a vendor. They will be prompted to set a PIN on their next login.`, 8000, 'success');
                } else {
                    // User does not exist, create a new one
                    const tempKey = 'TEMP' + Math.random().toString(36).substr(2, 8).toUpperCase();
                    const userCredential = await createUserWithEmailAndPassword(auth, email, tempKey);
                    vendorUid = userCredential.user.uid;
                    await updateProfile(userCredential.user, { displayName: vendorName });
                    // Create a user doc for the new vendor
                    await setDoc(doc(db, 'users', vendorUid), { name: vendorName, email: vendorEmail, role: 'vendor', createdAt: serverTimestamp() });
                    showMessage(`New vendor ${vendorEmail} created. Temporary key: ${tempKey}`, 10000, 'success');
                }

                // Create the vendor document
                const vendorDocName = `${vendorName.replace(/[^\w\s]/gi, '').replace(/\s+/g, '_')}_key`;
                await setDoc(doc(db, "vendors", vendorDocName), {
                    uid: vendorUid,
                    email: vendorEmail,
                    name: vendorName,
                    hasSetPin: false,
                    createdAt: serverTimestamp()
                });

                await updateDoc(requestDoc.ref, { status: "approved" });
                await signOut(auth);

            } catch (error) {
                showMessage(`Verification failed: ${error.message}`, 5000, 'error');
            }
        };

        const googleLogin = async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (!userDocSnap.exists()) {
                     await setDoc(userDocRef, { name: user.displayName, email: user.email, role: 'user', createdAt: serverTimestamp() });
                }
                showMessage('Logged in with Google!', 3000, 'success');
            } catch (error) { showMessage(`Google login failed: ${error.message}`, 5000, 'error'); }
        };

        const submitVehicle = async () => {
            const regNo = document.getElementById('reg-no').value.toUpperCase();
            const make = document.getElementById('vehicle-make').value;
            const model = document.getElementById('vehicle-model').value;
            const batteryCapacity = parseFloat(document.getElementById('battery-capacity').value);
            const supportedPlugs = [...document.querySelectorAll('.supported-plug:checked')].map(cb => cb.value.toUpperCase());
            
            const rtoRegex = /^[A-Z]{2}[0-9]{1,2}[A-Z]{1,2}[0-9]{1,4}$/;
            if (!rtoRegex.test(regNo)) {
                showMessage('Invalid Registration Number format.', 3000, 'error'); return;
            }
            if (!make || !model || isNaN(batteryCapacity) || supportedPlugs.length === 0) {
                showMessage('Please fill all vehicle fields and select at least one connector type.', 3000, 'error'); return;
            }
            try {
                const user = auth.currentUser;
                if (!user) throw new Error("User not logged in.");
                await addDoc(collection(db, "users", user.uid, "vehicles"), { regNo, make, model, batteryCapacity, supportedPlugs });
                showMessage('Vehicle added successfully!', 3000, 'success');
                document.getElementById('vehicle-form').reset();
            } catch (error) { showMessage(`Error: ${error.message}`, 4000, 'error'); }
        };

        const deleteVehicle = async (vehicleId) => {
            if (!confirm("Delete this vehicle?")) return;
            try {
                const user = auth.currentUser;
                if (!user) throw new Error("User not logged in.");
                await deleteDoc(doc(db, "users", user.uid, "vehicles", vehicleId));
                showMessage('Vehicle deleted.', 3000, 'success');
            } catch (error) { showMessage(`Error: ${error.message}`, 4000, 'error'); }
        };
        
        const addCharger = async (isHomeCharger = false) => {
            const user = auth.currentUser;
            if (!user) { showMessage("You must be logged in.", 3000, 'error'); return; }
            let name, rate, connectorType, chargerType, location, address;

            if (isHomeCharger) {
                name = document.getElementById('home-charger-name').value;
                rate = parseFloat(document.getElementById('home-charger-rate').value);
                connectorType = document.getElementById('home-charger-type').value;
                address = document.getElementById('home-charger-address').value;
                if (!name || isNaN(rate) || !connectorType || !address) {
                    showMessage('Please fill all home charger fields.', 3000, 'error'); return;
                }
                try {
                    const results = await new Promise((resolve, reject) => {
                        geocoder.geocode({ address }, (results, status) => {
                            if (status === 'OK') resolve(results);
                            else reject(new Error('Geocode failed: ' + status));
                        });
                    });
                    location = new GeoPoint(results[0].geometry.location.lat(), results[0].geometry.location.lng());
                    
                    await addDoc(collection(db, "chargers"), {
                        vendorId: user.uid, name, rate, location, connectorType,
                        status: 'available', type: 'home', createdAt: serverTimestamp()
                    });
                    showMessage('Charger added successfully!', 3000, 'success');
                    document.getElementById('home-charger-form').reset();
                    showSection('find-chargers');
                    setTimeout(() => {
                        if (mainMap) {
                           mainMap.setCenter({ lat: location.latitude, lng: location.longitude });
                           mainMap.setZoom(15);
                        }
                        showMessage("Your charger is now pinned on the map!", 4000, 'info');
                    }, 200);

                } catch (error) { showMessage(`Could not add charger. ${error.message}`, 5000, 'error'); return; }

            } else {
                name = document.getElementById('charger-name').value;
                rate = parseFloat(document.getElementById('charger-rate').value);
                connectorType = document.getElementById('connector-type-select').value;
                chargerType = document.getElementById('charger-type-select').value;
                const lat = parseFloat(document.getElementById('charger-lat').value);
                const lng = parseFloat(document.getElementById('charger-lng').value);
                if (!name || isNaN(rate) || !connectorType || !chargerType || isNaN(lat) || isNaN(lng)) {
                    showMessage('Please fill all franchise charger fields.', 3000, 'error'); return;
                }
                location = new GeoPoint(lat, lng);
                try {
                    await addDoc(collection(db, "chargers"), {
                        vendorId: user.uid, name, rate, location, connectorType, chargerType,
                        status: 'available', type: 'franchise', createdAt: serverTimestamp()
                    });
                    showMessage('Charger added successfully!', 3000, 'success');
                    document.getElementById('vendor-charger-form').reset();
                } catch (error) {
                     showMessage(`Error adding charger: ${error.message}`, 4000, 'error');
                }
            }
        };

        const listHomeCharger = () => addCharger(true);

        const deleteCharger = async (chargerId) => {
            if (!confirm("Are you sure you want to delete this charger? This action cannot be undone.")) return;
            try {
                await deleteDoc(doc(db, "chargers", chargerId));
                showMessage('Charger deleted successfully.', 3000, 'success');
            } catch (error) { showMessage(`Error deleting charger: ${error.message}`, 4000, 'error'); }
        };
        
        const setupVendorDashboard = async (uid) => {
            const chargersList = document.getElementById('vendor-chargers-list');
            const q = query(collection(db, "chargers"), where("vendorId", "==", uid), where("type", "==", "franchise"));
            
            onSnapshot(q, (snapshot) => {
                vendorChargersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (chargersList) {
                    chargersList.innerHTML = vendorChargersData.length === 0 ? `<p class="text-gray-500">No franchise chargers added yet.</p>` : '';
                    vendorChargersData.forEach(charger => {
                        const item = document.createElement('div');
                        item.className = 'bg-white p-4 rounded-lg shadow-sm flex justify-between items-center';
                        item.innerHTML = `<div>
                                            <p class="font-semibold">${charger.name}</p>
                                            <p class="text-sm text-gray-600">${charger.rate} kW | ${charger.connectorType || 'N/A'} | ${charger.chargerType || 'N/A'} | <span class="font-bold ${charger.status === 'available' ? 'text-green-600' : 'text-red-600'}">${charger.status}</span></p>
                                          </div>
                                          <div class="flex gap-2 flex-wrap">
                                            <button onclick="openEditModal('${charger.id}', '${charger.name}', ${charger.rate}, '${charger.status}')" class="text-blue-500 hover:text-blue-700 font-semibold text-sm">Edit</button>
                                            <button onclick="locateChargerOnMap(${charger.location.latitude}, ${charger.location.longitude})" class="text-purple-500 hover:text-purple-700 font-semibold text-sm">Locate</button>
                                            <button onclick="deleteCharger('${charger.id}')" class="text-red-500 hover:text-red-700 font-semibold text-sm">Delete</button>
                                          </div>`;
                        chargersList.appendChild(item);
                    });
                }
                renderVendorMapMarkers();
            });

            const ctx = document.getElementById('chargingChart')?.getContext('2d');
            if (ctx) {
                if(chargingChart) chargingChart.destroy();
                chargingChart = new Chart(ctx, { 
                    type: 'line', 
                    data: { 
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], 
                        datasets: [{ 
                            label: 'Earnings (₹)', 
                            data: [6500, 7200, 8100, 7800, 9000, 9500], 
                            borderColor: '#4f46e5', 
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.4 
                        }] 
                    } 
                });
            }

            const vendorQuery = query(collection(db, "vendors"), where("uid", "==", uid));
            const vendorSnapshot = await getDocs(vendorQuery);
            if (!vendorSnapshot.empty) {
                const vendorData = vendorSnapshot.docs[0].data();
                if (vendorData.hasSetPin) {
                    document.getElementById('set-pin-form').style.display = 'none';
                    document.getElementById('change-pin-form').style.display = 'block';
                } else {
                    document.getElementById('set-pin-form').style.display = 'block';
                    document.getElementById('change-pin-form').style.display = 'none';
                    showMessage("Welcome! Please set your custom PIN for future logins.", 5000, 'info');
                    showSection('dashboard');
                    showVendorTab('vendor-settings');
                }
            }
        };

        const renderVendorMapMarkers = () => {
            if (!vendorMap || !vendorChargersData) return;
            
            vendorChargerMarkers.forEach(marker => marker.setMap(null));
            vendorChargerMarkers = [];
            const bounds = new google.maps.LatLngBounds();
            
            vendorChargersData.forEach(charger => {
                if (!charger.location) return;
                const pos = { lat: charger.location.latitude, lng: charger.location.longitude };
                const marker = new google.maps.Marker({
                    position: pos,
                    map: vendorMap,
                    title: charger.name
                });
                vendorChargerMarkers.push(marker);
                bounds.extend(pos);
            });

            if (vendorChargersData.length > 0) {
                vendorMap.fitBounds(bounds);
            }
        };

        const fetchChargersForRoute = async (route) => {
            const states = await getStatesFromRoute(route.overview_path);
            if (states.size === 0) {
                showMessage("Could not determine states for the selected route. Fetching nearby chargers instead.", 4000, 'error');
                const allChargersSnapshot = await getDocs(query(collection(db, "chargers")));
                return allChargersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }
            showMessage(`Fetching chargers in ${[...states].join(', ')}...`, 4000, 'info');

            const localChargersSnapshot = await getDocs(query(collection(db, "chargers")));
            const localChargers = localChargersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const ocmUrl = `https://api.openchargemap.io/v3/poi/?output=json&countrycode=IN&maxresults=5000&key=${openChargeMapApiKey}`;
            
            let ocmChargers = [];
            try {
                const response = await fetch(ocmUrl); // Direct API call, no proxy
                if (!response.ok) throw new Error(`Open Charge Map API error: ${response.statusText}`);
                const data = await response.json();
                
                const ocmChargersInRelevantStates = data.filter(charger => {
                    const chargerState = charger.AddressInfo?.StateOrProvince;
                    return chargerState && states.has(chargerState.toLowerCase());
                });

                ocmChargers = ocmChargersInRelevantStates.map(item => ({
                    id: `ocm-${item.ID}`,
                    name: item.AddressInfo.Title,
                    AddressInfo: item.AddressInfo,
                    Connections: item.Connections,
                    IsPrivate: item.IsPrivate,
                    location: {
                        latitude: item.AddressInfo.Latitude,
                        longitude: item.AddressInfo.Longitude
                    },
                    rate: item.Connections?.[0]?.PowerKW,
                    status: 'available',
                    type: 'ocm'
                })).filter(c => c.location.latitude && c.location.longitude);

            } catch (error) {
                console.error("Error fetching Open Charge Map data:", error);
                showMessage("Failed to load global chargers from Open Charge Map. Showing local chargers only.", 5000, 'error');
            }

            const mergedChargers = [...ocmChargers, ...localChargers];
            const uniqueChargerIds = new Set();
            return mergedChargers.filter(charger => {
                const isDuplicate = uniqueChargerIds.has(charger.id);
                uniqueChargerIds.add(charger.id);
                return !isDuplicate;
            });
        };

        const getStatesFromRoute = async (path) => {
            const states = new Set();
            const sampleIndices = [
                0,
                Math.floor(path.length * 0.25),
                Math.floor(path.length * 0.5),
                Math.floor(path.length * 0.75),
                path.length - 1
            ];
            
            const geocodePromises = sampleIndices.map(index => {
                return new Promise(resolve => {
                    geocoder.geocode({ 'location': path[index] }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            for (const component of results[0].address_components) {
                                if (component.types.includes('administrative_area_level_1')) {
                                    states.add(component.long_name.toLowerCase());
                                    break;
                                }
                            }
                        }
                        resolve();
                    });
                });
            });

            await Promise.all(geocodePromises);
            return states;
        };

        
        const findAlternativeRoutes = async () => {
            if (currentRoute.isPlanning) {
                showMessage("A route is already being planned.", 2000, 'info');
                return;
            }
            const start = document.getElementById('route-start').value;
            const end = document.getElementById('route-end').value;
            const vehicleId = document.getElementById('vehicle-select').value;
            if (!start || !end || !vehicleId) {
                showMessage("Please fill all fields.", 3000, 'error'); return;
            }

            clearAlternativeRoutes();
            chargerMarkers.forEach(m => m.setMap(null));
            chargerMarkers = [];
            
            const request = {
                origin: start,
                destination: end,
                travelMode: 'DRIVING',
                provideRouteAlternatives: waypoints.length === 0,
                waypoints: waypoints.map(wp => ({ location: wp, stopover: true })),
                drivingOptions: {
                    departureTime: new Date(),
                    trafficModel: 'bestguess'
                }
            };

            directionsService.route(request, (response, status) => {
                if (status === 'OK') {
                    currentRoute.alternativeRoutesResponse = response;
                    displayAlternativeRoutes(response);
                } else {
                    showMessage(`Could not find routes: ${status}`, 4000, 'error');
                }
            });
        };

        const displayAlternativeRoutes = (response) => {
            const routeDetailsEl = document.getElementById('route-details');
            let html = `<h3 class="text-xl font-bold mb-3 text-gray-800">Please select your preferred route:</h3><div class="space-y-3">`;

            const colors = ['#4f46e5', '#16a34a', '#ca8a04'];

            response.routes.forEach((route, index) => {
                let totalDurationInTraffic = 0;
                let totalDistance = 0;

                route.legs.forEach(leg => {
                    totalDistance += leg.distance.value;
                    totalDurationInTraffic += leg.duration_in_traffic ? leg.duration_in_traffic.value : leg.duration.value;
                });

                const durationText = formatDuration(totalDurationInTraffic) + " (with traffic)";
                const distanceText = (totalDistance / 1000).toFixed(1) + " km";

                html += `
                    <div id="route-option-${index}" class="route-option p-4 border-2 rounded-lg cursor-pointer bg-white shadow-sm" onclick="selectRouteForPlanning(${index})">
                        <p class="font-bold text-lg text-indigo-700">Route ${index + 1} <span class="text-gray-600 font-medium text-base">(${route.summary || 'Main Route'})</span></p>
                        <div class="flex justify-between text-sm mt-1">
                            <span>${distanceText}</span>
                            <span>${durationText}</span>
                        </div>
                    </div>
                `;

                const routeRenderer = new google.maps.DirectionsRenderer({
                    map: mainMap,
                    directions: response,
                    routeIndex: index,
                    suppressMarkers: true,
                    polylineOptions: {
                        strokeColor: colors[index % colors.length],
                        strokeWeight: 6,
                        strokeOpacity: index === 0 ? 0.9 : 0.6
                    }
                });
                alternativeRouteRenderers.push(routeRenderer);
            });

            html += `</div><button id="plan-stops-btn" onclick="startStopPlanning()" class="mt-4 w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors hidden">Plan Charging Stops for Selected Route</button>`;
            routeDetailsEl.innerHTML = html;
            routeDetailsEl.classList.remove('hidden');

            if (response.routes.length === 1) {
                selectRouteForPlanning(0);
            }
        };
        
        const selectRouteForPlanning = (routeIndex) => {
            currentRoute.selectedRouteIndex = routeIndex;
            
            document.querySelectorAll('.route-option').forEach(el => el.classList.remove('selected-route'));
            document.getElementById(`route-option-${routeIndex}`).classList.add('selected-route');

            document.getElementById('plan-stops-btn').classList.remove('hidden');

            alternativeRouteRenderers.forEach((renderer, index) => {
                renderer.setOptions({
                    polylineOptions: {
                        strokeOpacity: index === routeIndex ? 0.9 : 0.3,
                        strokeWeight: index === routeIndex ? 8 : 6
                    }
                });
            });
        };

        const startStopPlanning = async () => {
            if (currentRoute.selectedRouteIndex === null) {
                showMessage("Please select a route first.", 3000, 'error'); return;
            }
            if (currentRoute.isPlanning) return;

            const selectedVehicle = userVehicles.find(v => v.id === document.getElementById('vehicle-select').value);
            if (!selectedVehicle) {
                showMessage("Vehicle not found.", 3000, 'error'); return;
            }

            currentRoute.isPlanning = true;
            document.getElementById('route-details').innerHTML = `<div class="text-center p-4"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div><p>Analyzing route with live traffic...</p></div>`;

            try {
                const selectedRoute = currentRoute.alternativeRoutesResponse.routes[currentRoute.selectedRouteIndex];
                
                const startLocation = selectedRoute.legs[0].start_location;
                const endLocation = selectedRoute.legs[selectedRoute.legs.length - 1].end_location;

                const geocodePromises = waypoints.map(wp => {
                    return new Promise((resolve, reject) => {
                        geocoder.geocode({ address: wp }, (results, status) => {
                            if (status === 'OK') {
                                resolve(results[0].geometry.location);
                            } else {
                                reject(`Geocode failed for waypoint "${wp}": ${status}`);
                            }
                        });
                    });
                });
                const geocodedWaypoints = await Promise.all(geocodePromises);

                currentRoute.vehicle = selectedVehicle;
                currentRoute.plannedWaypoints = [];
                currentRoute.navigationDirections = null;
                currentRoute.currentCharge = parseInt(document.getElementById('start-charge').value, 10);

                // Only use waypoints if they're actually needed and don't create unnecessary detours
                let majorPoints = [startLocation, endLocation];
                
                // Only add waypoints if they're significantly off the direct route
                if (geocodedWaypoints.length > 0) {
                    const directRoute = await routeOnce({ 
                        origin: startLocation, 
                        destination: endLocation, 
                        travelMode: 'DRIVING' 
                    });
                    
                    if (directRoute.stat === 'OK') {
                        const directDistance = directRoute.res.routes[0].legs[0].distance.value;
                        
                        // Only add waypoints that don't create excessive detours (more than 20% longer)
                        for (const waypoint of geocodedWaypoints) {
                            const routeWithWaypoint = await routeOnce({
                                origin: startLocation,
                                destination: endLocation,
                                waypoints: [{ location: waypoint, stopover: true }],
                                travelMode: 'DRIVING'
                            });
                            
                            if (routeWithWaypoint.stat === 'OK') {
                                const waypointDistance = routeWithWaypoint.res.routes[0].legs.reduce((sum, leg) => sum + leg.distance.value, 0);
                                const detourRatio = waypointDistance / directDistance;
                                
                                // Only add waypoint if it doesn't create more than 20% detour
                                if (detourRatio <= 1.2) {
                                    majorPoints.splice(-1, 0, waypoint); // Insert before end location
                                }
                            }
                        }
                    }
                }
                
                let allPlannedStops = [];
                const blacklistedChargerIds = new Set(); 

                for (let i = 0; i < majorPoints.length - 1; i++) {
                    const segmentStart = majorPoints[i];
                    const segmentEnd = majorPoints[i + 1];
                    
                    showMessage(`Planning stops between ${await getAddress(segmentStart)} and ${await getAddress(segmentEnd)}...`, 4000, 'info');

                    const segmentStops = await planSegment(segmentStart, segmentEnd, blacklistedChargerIds);
                    if (segmentStops === null) {
                        const startAddress = await getAddress(segmentStart);
                        const endAddress = await getAddress(segmentEnd);
                        throw new Error(`Could not find a valid charging path between ${startAddress} and ${endAddress}. This may be due to insufficient charging infrastructure in the area. Try adjusting your route or starting with a higher charge level.`);
                    }
                    allPlannedStops.push(...segmentStops);
                }

                currentRoute.plannedWaypoints = allPlannedStops;
                
                clearSegmentRenderers();
                const finalWaypoints = allPlannedStops.map(wp => ({ location: new google.maps.LatLng(wp.location.latitude, wp.location.longitude), stopover: true }));
                
                const finalRequest = buildFinalRequest(startLocation, endLocation, geocodedWaypoints, finalWaypoints);

                directionsService.route(finalRequest, (finalResult, finalStatus) => {
                    if (finalStatus === 'OK') {
                        currentRoute.navigationDirections = finalResult;
                        displayRouteInfo(finalResult.routes[0].legs, allPlannedStops, selectedVehicle, finalResult);
                        showMessage("Route planning complete!", 3000, 'success');
                    } else {
                        showMessage(`Failed to assemble final route: ${finalStatus}`, 4000, 'error');
                    }
                    currentRoute.isPlanning = false;
                });

            } catch (error) {
                console.error('Route planning error:', error);
                currentRoute.isPlanning = false;
                
                let errorMessage = "Route planning failed. Please try again.";
                if (error.message.includes('Geocode failed')) {
                    errorMessage = "Invalid waypoint address. Please check your waypoints and try again.";
                } else if (error.message.includes('ZERO_RESULTS')) {
                    errorMessage = "No route found. Please check your start and destination addresses.";
                } else if (error.message.includes('OVER_QUERY_LIMIT')) {
                    errorMessage = "Too many requests. Please wait a moment and try again.";
                } else if (error.message.includes('REQUEST_DENIED')) {
                    errorMessage = "Route planning service unavailable. Please try again later.";
                }
                
                showMessage(errorMessage, 5000, 'error');
                document.getElementById('route-details').innerHTML = `
                    <div class="p-4 rounded-lg" style="background: var(--bg-secondary); border: 1px solid var(--border);">
                        <div class="flex items-center gap-3 mb-3">
                            <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 19.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            <h3 class="text-lg font-semibold" style="color: var(--text-primary);">Route Planning Failed</h3>
                        </div>
                        <p class="mb-4" style="color: var(--text-secondary);">${errorMessage}</p>
                        
                        <div class="mb-4 p-3 rounded-lg" style="background: var(--bg-tertiary); border: 1px solid var(--border);">
                            <h4 class="font-semibold mb-2" style="color: var(--text-primary);">💡 Suggestions:</h4>
                            <ul class="text-sm space-y-1" style="color: var(--text-secondary);">
                                <li>• Start with a higher charge level (80-100%)</li>
                                <li>• Add waypoints through major cities with charging infrastructure</li>
                                <li>• Try a different route that passes through urban areas</li>
                                <li>• Check if your vehicle's range settings are correct</li>
                            </ul>
                        </div>
                        
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="startStopPlanning()" class="px-4 py-2 rounded-lg font-medium transition-all duration-300 hover:scale-105" style="background: var(--primary); color: white;">Try Again</button>
                            <button onclick="suggestAlternativeRoute()" class="px-4 py-2 rounded-lg font-medium transition-all duration-300 hover:scale-105" style="background: var(--secondary); color: white;">Find Alternative Route</button>
                            <button onclick="showSection('find-chargers')" class="px-4 py-2 rounded-lg font-medium transition-all duration-300 hover:scale-105" style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border);">Back to Planner</button>
                        </div>
                    </div>
                `;
            }
        };

        // === Unified EV Route Planner Patch ===
        const routeOnce = (req) => new Promise(r => directionsService.route(req, (res, stat) => r({ res, stat })));

        async function scoreChargerOption({ currentLegOrigin, charger, segmentEnd, vehicle, currentChargePct, kwhPerKm, targetArrivalPct }) {
            const chargerLoc = new google.maps.LatLng(charger.location.latitude, charger.location.longitude);

            const toCharger = await routeOnce({ origin: currentLegOrigin, destination: chargerLoc, travelMode: 'DRIVING', drivingOptions: { departureTime: new Date(), trafficModel: 'bestguess' } });
            if (toCharger.stat !== 'OK') return null;
            const legToCharger = toCharger.res.routes[0].legs[0];
            const distToChargerKm = legToCharger.distance.value / 1000;
            const timeToChargerSec = (legToCharger.duration_in_traffic ? legToCharger.duration_in_traffic.value : legToCharger.duration.value);

            const arrivalPct = currentChargePct - kwhToPercent(vehicle, distToChargerKm * kwhPerKm);
            if (arrivalPct <= 0) return null;

            const toEnd = await routeOnce({ origin: chargerLoc, destination: segmentEnd, travelMode: 'DRIVING', drivingOptions: { departureTime: new Date(), trafficModel: 'bestguess' } });
            if (toEnd.stat !== 'OK') return null;
            const legToEnd = toEnd.res.routes[0].legs[0];
            const distFromChargerToEndKm = legToEnd.distance.value / 1000;
            const timeFromChargerToEndSec = (legToEnd.duration_in_traffic ? legToEnd.duration_in_traffic.value : legToEnd.duration.value);

            const energyNeededKwh = distFromChargerToEndKm * kwhPerKm + percentToKwh(vehicle, targetArrivalPct);
            const haveKwhAtArrival = percentToKwh(vehicle, Math.max(arrivalPct, 0));
            const deltaKwh = Math.max(0, energyNeededKwh - haveKwhAtArrival);
            const chargeTimeSec = estimateChargeTimeSeconds(charger.rate || charger.Connections?.[0]?.PowerKW || 11, deltaKwh);

            const totalAddedSec = timeToChargerSec + chargeTimeSec + timeFromChargerToEndSec;
            return { charger, arrivalPct, chargeNeededKwh: deltaKwh, totalAddedSec, toChargerRoute: toCharger.res };
        }

        // Function to suggest alternative routes
        const suggestAlternativeRoute = async () => {
            try {
                const startInput = document.getElementById('route-start');
                const endInput = document.getElementById('route-end');
                
                if (!startInput || !endInput) {
                    showMessage('Please enter start and destination locations first.', 3000, 'error');
                    return;
                }
                
                const startAddress = startInput.value;
                const endAddress = endInput.value;
                
                if (!startAddress || !endAddress) {
                    showMessage('Please enter both start and destination locations.', 3000, 'error');
                    return;
                }
                
                showMessage('Finding alternative routes with better charging infrastructure...', 3000, 'info');
                
                // Geocode the addresses
                const startGeocode = await new Promise((resolve, reject) => {
                    geocoder.geocode({ address: startAddress }, (results, status) => {
                        if (status === 'OK') resolve(results[0].geometry.location);
                        else reject(new Error(`Geocode failed for start: ${status}`));
                    });
                });
                
                const endGeocode = await new Promise((resolve, reject) => {
                    geocoder.geocode({ address: endAddress }, (results, status) => {
                        if (status === 'OK') resolve(results[0].geometry.location);
                        else reject(new Error(`Geocode failed for end: ${status}`));
                    });
                });
                
                // Find major cities along the route for waypoints
                const midPoint = new google.maps.LatLng(
                    (startGeocode.lat() + endGeocode.lat()) / 2,
                    (startGeocode.lng() + endGeocode.lng()) / 2
                );
                
                // Common major cities in India with good charging infrastructure
                const majorCities = [
                    { name: 'Bangalore', lat: 12.9716, lng: 77.5946 },
                    { name: 'Chennai', lat: 13.0827, lng: 80.2707 },
                    { name: 'Hyderabad', lat: 17.3850, lng: 78.4867 },
                    { name: 'Mumbai', lat: 19.0760, lng: 72.8777 },
                    { name: 'Delhi', lat: 28.7041, lng: 77.1025 },
                    { name: 'Kolkata', lat: 22.5726, lng: 88.3639 },
                    { name: 'Pune', lat: 18.5204, lng: 73.8567 },
                    { name: 'Ahmedabad', lat: 23.0225, lng: 72.5714 },
                    { name: 'Kochi', lat: 9.9312, lng: 76.2673 },
                    { name: 'Coimbatore', lat: 11.0168, lng: 76.9558 }
                ];
                
                // Find the closest major city to the midpoint
                let closestCity = null;
                let minDistance = Infinity;
                
                majorCities.forEach(city => {
                    const cityLocation = new google.maps.LatLng(city.lat, city.lng);
                    const distance = google.maps.geometry.spherical.computeDistanceBetween(midPoint, cityLocation);
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestCity = city;
                    }
                });
                
                if (closestCity) {
                    // Add the major city as a waypoint
                    const waypointInput = document.getElementById('waypoint-input');
                    if (waypointInput) {
                        waypointInput.value = closestCity.name;
                        showMessage(`Added ${closestCity.name} as a waypoint for better charging options.`, 4000, 'success');
                        
                        // Try planning the route again
                        setTimeout(() => {
                            startStopPlanning();
                        }, 2000);
                    }
                } else {
                    showMessage('Could not find a suitable alternative route. Please try manually adding waypoints through major cities.', 5000, 'warning');
                }
                
            } catch (error) {
                console.error('Error suggesting alternative route:', error);
                showMessage('Failed to suggest alternative route. Please try manually adding waypoints.', 5000, 'error');
            }
        };

        // Helper function to find chargers near a location
        const findChargersNearLocation = async (location, radiusKm = 25) => {
            try {
                const allChargers = [];
                
                // Fetch from Firebase
                if (db) {
                    const chargersSnapshot = await getDocs(collection(db, 'chargers'));
                    chargersSnapshot.forEach(doc => {
                        const charger = { id: doc.id, ...doc.data() };
                        if (charger.location) {
                            allChargers.push(charger);
                        }
                    });
                }
                
                // Fetch from OpenChargeMap API
                try {
                    const response = await fetch(`https://api.openchargemap.io/v3/poi/?output=json&countrycode=IN&maxresults=50&latitude=${location.lat()}&longitude=${location.lng()}&distance=${radiusKm}&distanceunit=km`);
                    if (response.ok) {
                        const apiChargers = await response.json();
                        apiChargers.forEach(charger => {
                            if (charger.AddressInfo) {
                                allChargers.push({
                                    id: `ocm_${charger.ID}`,
                                    name: charger.AddressInfo.Title || 'Unknown Charger',
                                    location: {
                                        latitude: charger.AddressInfo.Latitude,
                                        longitude: charger.AddressInfo.Longitude
                                    },
                                    powerKw: charger.Connections?.[0]?.PowerKW || 30,
                                    status: 'unknown',
                                    connectorTypes: charger.Connections?.map(c => c.ConnectionType?.Title) || ['Unknown']
                                });
                            }
                        });
                    }
                } catch (apiError) {
                    console.log('OpenChargeMap API failed:', apiError);
                }
                
                // Filter by distance
                return allChargers.filter(charger => {
                    const distance = google.maps.geometry.spherical.computeDistanceBetween(
                        location,
                        new google.maps.LatLng(charger.location.latitude, charger.location.longitude)
                    ) / 1000;
                    return distance <= radiusKm;
                });
                
            } catch (error) {
                console.error('Error finding chargers near location:', error);
                return [];
            }
        };

        function estimateKwhPerKm(leg) {
            const BASE = 0.18; // Restored to original value from index(1).html
            const dur = (leg.duration_in_traffic ? leg.duration_in_traffic.value : leg.duration.value) || 0;
            const distKm = (leg.distance?.value || 0) / 1000;
            if (!dur || !distKm) return BASE;
            const avgSpeedKph = distKm / (dur / 3600);
            const trafficFactor = (leg.duration_in_traffic && leg.duration) ? (leg.duration_in_traffic.value / Math.max(1, leg.duration.value)) : 1;
            let speedAdj = 1.03; // Restored to original logic
            if (avgSpeedKph < 40) speedAdj = 1.10;
            else if (avgSpeedKph > 90) speedAdj = 1.05;
            return BASE * trafficFactor * speedAdj;
        }

        function kwhToPercent(vehicle, kwh) { return (kwh / vehicle.batteryCapacity) * 100; }
        function percentToKwh(vehicle, pct) { return (pct / 100) * vehicle.batteryCapacity; }

        function estimateChargeTimeSeconds(powerKw, energyKwh) {
            if (!powerKw || powerKw <= 0) powerKw = 11;
            return (energyKwh / powerKw) * 3600;
        }

        function isCompatible(vehicle, charger) {
            if (!vehicle.supportedPlugs || vehicle.supportedPlugs.length === 0) return true;
            const vehiclePlugs = vehicle.supportedPlugs.map(p => p.toUpperCase().trim());

            if (charger.Connections && Array.isArray(charger.Connections)) {
                return charger.Connections.some(conn => {
                    if (!conn.ConnectionType || !conn.ConnectionType.Title) return false;
                    const chargerPlug = conn.ConnectionType.Title.toUpperCase();
                    if (vehiclePlugs.includes('CCS2') && chargerPlug.includes('CCS')) return true;
                    if (vehiclePlugs.includes('CHADEMO') && chargerPlug.includes('CHADEMO')) return true;
                    if (vehiclePlugs.includes('TYPE 2') && chargerPlug.includes('TYPE 2')) return true;
                    if (vehiclePlugs.includes('GB/T') && chargerPlug.includes('GB/T')) return true;
                    return false;
                });
            }
            
            if (charger.connectorType) {
                const localPlug = charger.connectorType.toUpperCase().trim();
                return vehiclePlugs.includes(localPlug);
            }

            return false;
        }

        const planSegment = (segmentStart, segmentEnd, blacklistedChargerIds) => new Promise(async (resolve) => {
            const segmentWaypoints = [];
            let currentLegOrigin = segmentStart;
            let iter = 0;
            const MAX_ITER = 24; // Restored to original value for better accuracy

            while (iter++ < MAX_ITER) {
                const baseRes = await routeOnce({ origin: currentLegOrigin, destination: segmentEnd, travelMode: 'DRIVING', drivingOptions: { departureTime: new Date(), trafficModel: 'bestguess' } });
                if (baseRes.stat !== 'OK') { resolve(null); return; }

                const leg = baseRes.res.routes[0].legs[0];
                const vehicle = currentRoute.vehicle;
                const kwhPerKm = estimateKwhPerKm(leg);
                const totalRangeKm = vehicle.batteryCapacity / kwhPerKm;
                const distanceToCoverKm = leg.distance.value / 1000;

                const requiredEndPct = parseInt(document.getElementById('end-charge').value, 10) || 0;
                const neededKwhNow = distanceToCoverKm * kwhPerKm + percentToKwh(vehicle, requiredEndPct);
                const haveKwhNow = percentToKwh(vehicle, currentRoute.currentCharge);

                if (haveKwhNow >= neededKwhNow) {
                    const chargeUsedPct = kwhToPercent(vehicle, distanceToCoverKm * kwhPerKm);
                    currentRoute.currentCharge = Math.max(0, currentRoute.currentCharge - chargeUsedPct);
                    resolve(segmentWaypoints); return;
                }

                const segmentChargers = await fetchChargersForRoute(baseRes.res.routes[0]);
                const safetyPct = 12; // Restored to original safety margin
                const maxReachKm = totalRangeKm * ((currentRoute.currentCharge - safetyPct) / 100);
                
                const prelim = segmentChargers.filter(c => {
                    return !blacklistedChargerIds.has(c.id) && c.location && c.status === 'available' && isCompatible(vehicle, c);
                });

                let best = null;
                for (let i = 0; i < prelim.length; i += 6) {
                    const batch = prelim.slice(i, i + 6);
                    const scored = await Promise.all(batch.map(c => scoreChargerOption({ currentLegOrigin, charger: c, segmentEnd, vehicle, currentChargePct: currentRoute.currentCharge, kwhPerKm, targetArrivalPct: requiredEndPct })));
                    for (const s of scored) {
                        if (!s) continue;
                        const straightKm = google.maps.geometry.spherical.computeDistanceBetween(currentLegOrigin, new google.maps.LatLng(s.charger.location.latitude, s.charger.location.longitude)) / 1000;
                        if (straightKm > maxReachKm) continue;
                        if (!best || s.totalAddedSec < best.totalAddedSec) best = s;
                    }
                    if (best) break; 
                }

                if (!best) { resolve(null); return; }
                
                blacklistedChargerIds.add(best.charger.id);
                best.charger.arrivalCharge = best.arrivalPct;
                best.charger.chargeNeededKwh = best.chargeNeededKwh;

                segmentWaypoints.push(best.charger);
                currentLegOrigin = new google.maps.LatLng(best.charger.location.latitude, best.charger.location.longitude);

                const distToChargerKm = best.toChargerRoute.routes[0].legs[0].distance.value / 1000;
                const usedPctToCharger = kwhToPercent(vehicle, distToChargerKm * kwhPerKm);
                const socAtArrival = Math.max(0, currentRoute.currentCharge - usedPctToCharger);
                const deltaPct = kwhToPercent(vehicle, best.chargeNeededKwh);
                currentRoute.currentCharge = Math.min(100, socAtArrival + deltaPct);
            }
            resolve(null);
        });

        function buildFinalRequest(startLocation, endLocation, geocodedWaypoints, finalWaypoints) {
            const allWaypoints = [
                ...geocodedWaypoints.map(wp => ({ location: wp, stopover: true })),
                ...finalWaypoints
            ];
            return {
                origin: startLocation,
                destination: endLocation,
                waypoints: allWaypoints,
                travelMode: 'DRIVING',
                optimizeWaypoints: false,
                drivingOptions: { departureTime: new Date(), trafficModel: 'bestguess' }
            };
        }
        // === End of Patch ===

        const getAddress = (latLng) => {
            return new Promise(resolve => {
                geocoder.geocode({ 'location': latLng }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        resolve(results[0].formatted_address.split(',').slice(0, 2).join(', '));
                    } else {
                        resolve("Unknown Location");
                    }
                });
            });
        };

        const checkVendorApplicationStatus = async (uid) => {
            const statusContainer = document.getElementById('vendor-application-status');
            const q = query(collection(db, "vendor_requests"), where("userId", "==", uid));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const appData = querySnapshot.docs[0].data();
                 if (appData.status === 'pending') {
                    statusContainer.innerHTML = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                        <p class="font-bold">Verification Pending</p>
                        <p>Your application to become a vendor is currently under review by an executive.</p>
                    </div>`;
                } else if (appData.status === 'approved') {
                     statusContainer.innerHTML = `<div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4" role="alert">
                        <p class="font-bold">Application Approved!</p>
                        <p>Congratulations! Please check your email for your temporary key and log in through the Vendor Portal.</p>
                    </div>`;
                }
            } else {
                statusContainer.innerHTML = `
                    <p class="mb-6 text-gray-600">To become a vendor, please submit a request for verification.</p>
                    <div class="space-y-4" id="vendor-application-form">
                        <input type="text" id="vendor-name" placeholder="Your Full Name or Business Name" class="w-full p-3 border rounded-lg form-field">
                        <button onclick="submitVendorApplication()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">Submit Request</button>
                    </div>
                `;
            }
        };

        const submitVendorApplication = async () => {
            const user = auth.currentUser;
            if (!user) { showMessage("You must be logged in.", 3000, 'error'); return; }

            const vendorName = document.getElementById('vendor-name').value;
            if (!vendorName) {
                showMessage("Please enter your name or business name.", 3000, 'error');
                return;
            }

            try {
                await addDoc(collection(db, "vendor_requests"), {
                    userId: user.uid,
                    email: user.email,
                    name: vendorName,
                    status: 'pending',
                    submittedAt: serverTimestamp()
                });

                showMessage("Request submitted successfully! Your request is under review.", 5000, 'success');
                checkVendorApplicationStatus(user.uid);
            } catch (error) {
                showMessage(`Request failed: ${error.message}`, 5000, 'error');
            }
        };
        
        const findNearbyPlaces = (charger) => {
            const nearbyPlacesContainer = document.getElementById('nearby-places');
            nearbyPlacesContainer.innerHTML = `<div class="text-center p-4"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2" style="border-color: var(--primary);"></div><p class="mt-2 font-semibold" style="color: var(--text-secondary);">Searching for nearby places...</p></div>`;
            nearbyPlacesContainer.classList.remove('hidden');

            const location = new google.maps.LatLng(charger.location.latitude, charger.location.longitude);

            // Ensure placesService is initialized
            if (!placesService) {
                placesService = new google.maps.places.PlacesService(mainMap || nearMeMap);
            }

            const placeTypes = [
                { title: 'Restaurants', type: 'restaurant' },
                { title: 'Cafes', type: 'cafe' },
                { title: 'Hotels', type: 'lodging' },
                { title: 'Attractions', type: 'tourist_attraction' },
                { title: 'Gas Stations', type: 'gas_station' },
                { title: 'Shopping', type: 'shopping_mall' }
            ];

            const searchPromises = placeTypes.map(placeType => {
                return new Promise((resolve) => {
                    const radiusKm = document.getElementById('nearby-radius')?.value || 5;
                    const radiusMeters = radiusKm * 1000;
                    
                    const request = {
                        location: location,
                        radius: radiusMeters.toString(),
                        type: [placeType.type]
                    };
                    
                    try {
                    placesService.nearbySearch(request, (results, status) => {
                            console.log(`Places API search for ${placeType.title}:`, status, results?.length || 0);
                            
                        if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                            resolve({ title: placeType.title, places: results });
                            } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                                console.log(`No ${placeType.title} found nearby`);
                                resolve({ title: placeType.title, places: [] });
                        } else {
                                console.error(`Places API error for ${placeType.title}:`, status);
                            resolve({ title: placeType.title, places: [] });
                        }
                    });
                    } catch (error) {
                        console.error(`Error searching for ${placeType.title}:`, error);
                        resolve({ title: placeType.title, places: [] });
                    }
                });
            });

            Promise.all(searchPromises).then(results => {
                let allResultsHTML = '';
                let hasResults = false;
                
                results.forEach(category => {
                    if (category.places && category.places.length > 0) {
                        hasResults = true;
                        let html = `<h4 class="font-bold text-lg mt-4 mb-2" style="color: var(--text-primary);">${category.title} Nearby</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-2">`;
                        category.places.slice(0, 4).forEach(place => {
                            const placeName = place.name ? place.name.replace(/'/g, "\\'").replace(/"/g, '&quot;') : 'Unknown Place';
                            const placeVicinity = place.vicinity ? place.vicinity.replace(/'/g, "\\'").replace(/"/g, '&quot;') : 'Address not available';
                            const rating = place.rating ? place.rating.toFixed(1) : 'N/A';
                            const priceLevel = place.price_level ? '₹'.repeat(place.price_level) : '';
                            
                            html += `<div class="glass p-3 rounded-lg cursor-pointer hover:bg-opacity-80 transition-all" onclick="selectNearbyPlace('${placeName}', '${placeVicinity}')">
                                <p class="font-semibold text-sm" style="color: var(--text-primary);">${place.name}</p>
                                <p class="text-xs" style="color: var(--text-secondary);">${place.vicinity || 'Address not available'}</p>
                                <div class="flex justify-between items-center mt-1">
                                    ${place.rating ? `<p class="text-xs text-yellow-500 font-bold">⭐ ${rating}</p>` : ''}
                                    ${priceLevel ? `<p class="text-xs" style="color: var(--accent-color);">${priceLevel}</p>` : ''}
                                </div>
                            </div>`;
                        });
                        html += `</div>`;
                        allResultsHTML += html;
                    }
                });

                if (hasResults) {
                    nearbyPlacesContainer.innerHTML = allResultsHTML;
                } else {
                    nearbyPlacesContainer.innerHTML = `
                        <div class="text-center p-4">
                            <p style="color: var(--text-secondary);">No popular places found within 5km of the charger.</p>
                            <p class="text-sm mt-2" style="color: var(--text-secondary);">Try searching in a different area or check if Places API is enabled.</p>
                        </div>`;
                }
            }).catch(error => {
                console.error('Error in findNearbyPlaces:', error);
                nearbyPlacesContainer.innerHTML = `
                    <div class="text-center p-4">
                        <p style="color: var(--text-secondary);">Error loading nearby places.</p>
                        <p class="text-sm mt-2" style="color: var(--text-secondary);">Please check your internet connection and try again.</p>
                    </div>`;
            });
        };


        const selectNearbyPlace = (name, vicinity) => {
            currentRoute.selectedPlace = { name, vicinity };
            showMessage(`'${name}' selected for your stop. This will be shown during live navigation.`, 4000, 'success');
        };

        // Function to find chargers near user's location
        const findChargersNearMe = async (userPosition) => {
            console.log('findChargersNearMe called with position:', userPosition);
            
            if (!nearMeMap) {
                console.error('Near Me Map not initialized');
                showMessage('❌ Map not initialized. Please refresh the page.', 4000, 'error');
                return;
            }

            console.log('Near Me Map is initialized, proceeding with search...');

            // Show loading indicator
            const loadingMessage = showMessage('🔍 Searching for chargers near your location...', 0, 'info');
            
            // Add loading overlay to map
            const mapContainer = document.getElementById('chargers-near-me-map');
            if (mapContainer) {
                // Remove any existing loading overlay
                const existingOverlay = document.getElementById('chargers-loading-overlay');
                if (existingOverlay) {
                    existingOverlay.remove();
                }
                
                const loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'chargers-loading-overlay';
                loadingOverlay.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                    border-radius: 8px;
                `;
                loadingOverlay.innerHTML = `
                    <div style="background: white; border-radius: 8px; padding: 24px; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                        <div style="display: inline-block; width: 32px; height: 32px; border: 3px solid #e5e7eb; border-top: 3px solid #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px;"></div>
                        <p style="color: #374151; font-weight: 600; margin: 0 0 8px 0; font-size: 16px;">Finding chargers...</p>
                        <p style="color: #6b7280; margin: 0; font-size: 14px;">This may take a few seconds</p>
                    </div>
                `;
                
                // Add CSS animation if not already present
                if (!document.getElementById('loading-spinner-style')) {
                    const style = document.createElement('style');
                    style.id = 'loading-spinner-style';
                    style.textContent = `
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                mapContainer.style.position = 'relative';
                mapContainer.appendChild(loadingOverlay);
                console.log('Loading overlay added to map');
            } else {
                console.error('Map container not found');
            }

            try {
                console.log('Starting charger search for position:', userPosition);
                
                // Get all chargers from Firebase
                let allChargers = [];
                try {
                    console.log('Fetching chargers from Firebase...');
                    const chargersSnapshot = await getDocs(collection(db, "chargers"));
                    allChargers = chargersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log(`Found ${allChargers.length} chargers in Firebase`);
                } catch (error) {
                    console.error('Firebase chargers fetch error:', error);
                }

                // Also fetch from OpenChargeMap API for more comprehensive results
                let ocmChargers = [];
                try {
                    console.log('Fetching chargers from OpenChargeMap API...');
                    const ocmUrl = `https://api.openchargemap.io/v3/poi/?output=json&countrycode=IN&maxresults=1000&key=${openChargeMapApiKey}`;
                    
                    // Add timeout and retry logic
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                    
                    const response = await fetch(ocmUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`OpenChargeMap API returned ${data.length} chargers`);
                        
                        ocmChargers = data.map(charger => ({
                            id: `ocm_${charger.ID}`,
                            name: charger.AddressInfo?.Title || 'Unknown Charger',
                            location: {
                                latitude: charger.AddressInfo?.Latitude,
                                longitude: charger.AddressInfo?.Longitude
                            },
                            rate: charger.Connections?.[0]?.PowerKW || 'N/A',
                            type: 'public',
                            status: 'available',
                            IsPrivate: false,
                            AddressInfo: charger.AddressInfo,
                            Connections: charger.Connections
                        })).filter(charger => charger.location?.latitude && charger.location?.longitude);
                        
                        console.log(`Filtered to ${ocmChargers.length} valid OCM chargers`);
                    } else {
                        console.error('OpenChargeMap API response not ok:', response.status, response.statusText);
                        // Try with a different endpoint or parameters
                        console.log('Trying alternative API call...');
                        const altUrl = `https://api.openchargemap.io/v3/poi/?output=json&countrycode=IN&maxresults=500&key=${openChargeMapApiKey}`;
                        try {
                            const altResponse = await fetch(altUrl);
                            if (altResponse.ok) {
                                const altData = await altResponse.json();
                                console.log(`Alternative API call returned ${altData.length} chargers`);
                                // Process alternative data...
                            }
                        } catch (altError) {
                            console.error('Alternative API call also failed:', altError);
                        }
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.error('OpenChargeMap API request timed out');
                    } else {
                        console.error('OpenChargeMap API error:', error);
                    }
                }

                // If no chargers found from APIs, use fallback sample data
                if (allChargers.length === 0 && ocmChargers.length === 0) {
                    console.log('No chargers found from APIs, using fallback data');
                    ocmChargers = getFallbackChargers(userPosition);
                }

                // Combine all chargers
                const combinedChargers = [...allChargers, ...ocmChargers];
                console.log(`Total combined chargers: ${combinedChargers.length}`);

                // Filter chargers within radius of user location
                const radiusKm = parseInt(document.getElementById('near-me-radius')?.value || 10);
                const nearbyChargers = combinedChargers.filter(charger => {
                    if (!charger.location?.latitude || !charger.location?.longitude) return false;
                    
                    const distance = calculateDistance(
                        userPosition.lat, userPosition.lng,
                        charger.location.latitude, charger.location.longitude
                    );
                    
                    return distance <= radiusKm;
                });

                console.log(`Found ${nearbyChargers.length} chargers within ${radiusKm}km`);

                // Sort by distance
                nearbyChargers.sort((a, b) => {
                    const distA = calculateDistance(
                        userPosition.lat, userPosition.lng,
                        a.location.latitude, a.location.longitude
                    );
                    const distB = calculateDistance(
                        userPosition.lat, userPosition.lng,
                        b.location.latitude, b.location.longitude
                    );
                    return distA - distB;
                });

                // Update map markers
                updateMapMarkers(nearMeMap, nearMeChargerMarkers, nearbyChargers);

                // Update the map bounds to show all nearby chargers
                if (nearbyChargers.length > 0) {
                    const bounds = new google.maps.LatLngBounds();
                    bounds.extend(userPosition);
                    nearbyChargers.forEach(charger => {
                        bounds.extend({
                            lat: charger.location.latitude,
                            lng: charger.location.longitude
                        });
                    });
                    nearMeMap.fitBounds(bounds);
                }

                // Show results message
                if (nearbyChargers.length > 0) {
                    showMessage(`✅ Found ${nearbyChargers.length} chargers within ${radiusKm}km of your location`, 4000, 'success');
                } else {
                    showMessage(`⚠️ No chargers found within ${radiusKm}km. Try increasing the search radius.`, 4000, 'warning');
                }

            } catch (error) {
                console.error('Error finding nearby chargers:', error);
                showMessage('❌ Error loading nearby chargers. Please try again.', 4000, 'error');
                
                // Add retry button to the map
                const retryOverlay = document.createElement('div');
                retryOverlay.id = 'chargers-retry-overlay';
                retryOverlay.className = 'absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10';
                retryOverlay.innerHTML = `
                    <div class="bg-white rounded-lg p-6 text-center">
                        <p class="text-gray-700 font-semibold mb-4">Failed to load chargers</p>
                        <button onclick="retryChargerSearch()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                            Retry Search
                        </button>
                    </div>
                `;
                mapContainer.appendChild(retryOverlay);
            } finally {
                // Remove loading overlay
                const overlay = document.getElementById('chargers-loading-overlay');
                if (overlay) {
                    overlay.remove();
                }
                // Clear loading message
                if (loadingMessage) {
                    clearTimeout(loadingMessage);
                }
            }
        };

        // Test function for charger loading
        const testChargerLoading = () => {
            console.log('Testing charger loading...');
            const testPosition = {
                lat: 8.5241, // Thiruvananthapuram coordinates
                lng: 76.9366
            };
            console.log('Using test position:', testPosition);
            findChargersNearMe(testPosition);
        };

        // Retry function for charger search
        const retryChargerSearch = () => {
            const retryOverlay = document.getElementById('chargers-retry-overlay');
            if (retryOverlay) {
                retryOverlay.remove();
            }
            
            // Get current user position and retry
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    findChargersNearMe(pos);
                }, () => {
                    showMessage('❌ Could not get your location. Please try again.', 4000, 'error');
                });
            } else {
                showMessage('❌ Geolocation not supported by your browser.', 4000, 'error');
            }
        };

        // Fallback charger data for when APIs fail
        const getFallbackChargers = (userPosition) => {
            const fallbackChargers = [
                {
                    id: 'fallback_1',
                    name: 'Sample EV Charging Station 1',
                    location: {
                        latitude: userPosition.lat + 0.01,
                        longitude: userPosition.lng + 0.01
                    },
                    rate: '50',
                    type: 'public',
                    status: 'available',
                    IsPrivate: false
                },
                {
                    id: 'fallback_2',
                    name: 'Sample EV Charging Station 2',
                    location: {
                        latitude: userPosition.lat - 0.01,
                        longitude: userPosition.lng + 0.01
                    },
                    rate: '30',
                    type: 'public',
                    status: 'available',
                    IsPrivate: false
                },
                {
                    id: 'fallback_3',
                    name: 'Sample EV Charging Station 3',
                    location: {
                        latitude: userPosition.lat + 0.01,
                        longitude: userPosition.lng - 0.01
                    },
                    rate: '22',
                    type: 'public',
                    status: 'available',
                    IsPrivate: false
                }
            ];
            
            console.log('Using fallback charger data');
            return fallbackChargers;
        };

        // Helper function to calculate distance between two points
        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371; // Radius of the Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Distance in km
        };

        // Debug function to test Places API
        const testPlacesAPI = () => {
            if (!placesService) {
                console.error('Places Service not initialized');
                return;
            }
            
            const testLocation = new google.maps.LatLng(8.5241, 76.9366); // Thiruvananthapuram
            const request = {
                location: testLocation,
                radius: '1000',
                type: ['restaurant']
            };
            
            placesService.nearbySearch(request, (results, status) => {
                console.log('Places API Test Result:', status, results);
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    console.log('Places API is working correctly');
                } else {
                    console.error('Places API Error:', status);
                }
            });
        };

        const locateMe = (mapId) => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    let targetMap;
                    let targetInput;
                    if (mapId === 'route-start') {
                        targetMap = mainMap;
                        targetInput = document.getElementById('route-start');
                    } else if (mapId === 'near-me-map') {
                        targetMap = nearMeMap;
                        
                        if (nearMeUserMarker) {
                            nearMeUserMarker.setMap(null);
                        }
                        nearMeUserMarker = new google.maps.Marker({
                            position: pos,
                            map: targetMap,
                            title: 'Your Location',
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 8,
                                fillColor: '#4285F4',
                                fillOpacity: 1,
                                strokeWeight: 2,
                                strokeColor: 'white'
                            }
                        });
                        
                        // Find and display nearby chargers
                        console.log('Calling findChargersNearMe with position:', pos);
                        findChargersNearMe(pos);
                    }

                    if (targetMap) {
                        targetMap.setCenter(pos);
                        targetMap.setZoom(12);
                    }

                    if (targetInput) {
                        geocoder.geocode({ location: pos }, (results, status) => {
                            if (status === 'OK' && results[0]) {
                                targetInput.value = results[0].formatted_address;
                            } else {
                                showMessage("Could not determine address from your location.", 3000, 'error');
                            }
                        });
                    }
                }, () => {
                    showMessage("Geolocation failed. Please enable location services.", 4000, 'error');
                });
            } else {
                showMessage("Your browser does not support geolocation.", 4000, 'error');
            }
        };

        const navigateToCharger = (lat, lng) => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const start = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    const end = { lat, lng };

                    const request = {
                        origin: start,
                        destination: end,
                        travelMode: 'DRIVING'
                    };

                    directionsService.route(request, (result, status) => {
                        if (status === 'OK') {
                            currentRoute.navigationDirections = result;
                            startInAppNavigation();
                        } else {
                            showMessage("Could not calculate route to this charger.", 3000, 'error');
                        }
                    });

                }, () => showMessage("Could not get your current location to start navigation.", 3000, 'error'));
            } else {
                showMessage("Geolocation is not supported by your browser.", 4000, 'error');
            }
        };
        
        const initUserMap = () => {
             if (mainMap) return;
             
             try {
                 const defaultLocation = { lat: 8.5241, lng: 76.9366 }; // Thiruvananthapuram
                 
                 const currentTheme = document.body.getAttribute('data-theme') || 'light';
                 const mapTheme = getMapTheme(currentTheme);
                 
             mainMap = new google.maps.Map(document.getElementById("map"), {
                 zoom: 10,
                 center: defaultLocation,
                 mapTypeControl: false,
                     mapTypeId: google.maps.MapTypeId.TERRAIN,
                     styles: mapTheme,
                     disableDefaultUI: false,
                     zoomControl: true,
                     streetViewControl: false,
                     fullscreenControl: true,
                     mapTypeControl: true,
                     mapTypeControlOptions: {
                         style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                         position: google.maps.ControlPosition.TOP_CENTER
                     }
             });
             directionsService = new google.maps.DirectionsService();
             geocoder = new google.maps.Geocoder();
             placesService = new google.maps.places.PlacesService(mainMap);
                 console.log("Places Service initialized with mainMap");
             } catch (error) {
                 console.error('Failed to initialize main map:', error);
                 showMessage('Failed to load map. Please check your internet connection.', 5000, 'error');
                 // Show fallback message
                 const mapElement = document.getElementById("map");
                 if (mapElement) {
                     mapElement.innerHTML = `
                         <div class="flex items-center justify-center h-full bg-gray-100 rounded-lg">
                             <div class="text-center p-6">
                                 <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                 </svg>
                                 <h3 class="text-lg font-semibold text-gray-700 mb-2">Map Unavailable</h3>
                                 <p class="text-gray-500 mb-4">Unable to load Google Maps. Please check your internet connection.</p>
                                 <button onclick="initUserMap()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                     Retry
                                 </button>
                             </div>
                         </div>
                     `;
                 }
             }
             const startInput = document.getElementById('route-start');
             const endInput = document.getElementById('route-end');
             const waypointInput = document.getElementById('waypoint-input');
             if (startInput) new google.maps.places.Autocomplete(startInput);
             if (endInput) new google.maps.places.Autocomplete(endInput);
             if (waypointInput) new google.maps.places.Autocomplete(waypointInput);

             document.getElementById('start-charge').addEventListener('input', (e) => { document.getElementById('start-charge-value').textContent = e.target.value; });
             document.getElementById('end-charge').addEventListener('input', (e) => { document.getElementById('end-charge-value').textContent = e.target.value; });
             document.getElementById('search-radius').addEventListener('input', (e) => { document.getElementById('search-radius-value').textContent = e.target.value; });
             document.getElementById('nearby-radius').addEventListener('input', (e) => { document.getElementById('nearby-radius-value').textContent = e.target.value; });
             document.getElementById('near-me-radius').addEventListener('input', (e) => { document.getElementById('near-me-radius-value').textContent = e.target.value; });
             setupEnterKeyNavigation();
             console.log("User Map Initialized");
        };
        
        const clearAlternativeRoutes = () => {
            alternativeRouteRenderers.forEach(renderer => renderer.setMap(null));
            alternativeRouteRenderers = [];
        };

        const clearSegmentRenderers = () => {
            segmentRenderers.forEach(renderer => renderer.setMap(null));
            segmentRenderers = [];
        };

        const addWaypoint = () => {
            const waypointInput = document.getElementById('waypoint-input');
            const location = waypointInput.value;
            if (location) {
                waypoints.push(location);
                waypointInput.value = '';
                renderWaypoints();
            }
        };

        const removeWaypoint = (index) => {
            waypoints.splice(index, 1);
            renderWaypoints();
        };

        const renderWaypoints = () => {
            const container = document.getElementById('waypoints-container');
            container.innerHTML = '';
            waypoints.forEach((wp, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between glass p-2 rounded-lg';
                div.innerHTML = `<span class="text-sm" style="color: var(--text-primary);">${wp}</span>
                                 <button onclick="removeWaypoint(${index})" class="font-bold text-lg" style="color:#ef4444;">&times;</button>`;
                container.appendChild(div);
            });
        };


        const initChargersNearMeMap = () => {
            if (nearMeMap) return;
            const defaultLocation = { lat: 8.5241, lng: 76.9366 }; // Thiruvananthapuram
            
            const currentTheme = document.body.getAttribute('data-theme') || 'light';
            const mapTheme = getMapTheme(currentTheme);
            
            nearMeMap = new google.maps.Map(document.getElementById("chargers-near-me-map"), {
                 zoom: 10,
                 center: defaultLocation,
                 mapTypeControl: false,
                 mapTypeId: google.maps.MapTypeId.TERRAIN,
                 styles: mapTheme
            });
            console.log("Chargers Near Me Map Initialized");
        };

        const initVendorMap = () => {
            if (vendorMap || !document.getElementById('vendor-map')) return;
            const defaultLocation = { lat: 8.5241, lng: 76.9366 }; // Thiruvananthapuram
            
            const currentTheme = document.body.getAttribute('data-theme') || 'light';
            const mapTheme = getMapTheme(currentTheme);
            
            vendorMap = new google.maps.Map(document.getElementById("vendor-map"), {
                zoom: 5,
                center: defaultLocation,
                mapTypeControl: false,
                styles: mapTheme
            });
            renderVendorMapMarkers(); // Draw markers as soon as map is ready
            console.log("Vendor Map Initialized");
        };

        const showVendorTab = (tabId) => {
            // Map URL tab names to actual tab IDs
            const tabMapping = {
                'vmap': 'my-vmap',
                'manage': 'manage-chargers',
                'performance': 'performance-overview',
                'settings': 'vendor-settings'
            };
            
            const actualTabId = tabMapping[tabId] || tabId;
            
            document.querySelectorAll('.vendor-tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.vendor-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(actualTabId)?.classList.add('active');
            document.querySelector(`.vendor-tab[onclick*="'${actualTabId}'"]`)?.classList.add('active');
            if (actualTabId === 'my-vmap') {
                if (!vendorMap) {
                    initVendorMap();
                }
                setTimeout(() => {
                    const center = vendorMap.getCenter();
                    google.maps.event.trigger(vendorMap, 'resize');
                    if (center) vendorMap.setCenter(center);
                }, 100);
            }
        };

        const calculateROI = () => {
            const investment = parseFloat(document.getElementById('investment').value);
            const monthlyRevenue = parseFloat(document.getElementById('monthly-revenue').value);
            const resultDiv = document.getElementById('roi-result');
            if (isNaN(investment) || isNaN(monthlyRevenue) || investment <= 0) {
                showMessage("Please enter valid investment and revenue values.", 3000, 'error');
                return;
            }
            const annualRevenue = monthlyRevenue * 12;
            const profit = annualRevenue - investment;
            const roi = (profit / investment) * 100;
            resultDiv.innerHTML = `
                <p><strong>Annual Revenue:</strong> ₹${annualRevenue.toLocaleString('en-IN')}</p>
                <p><strong>Annual Profit:</strong> ₹${profit.toLocaleString('en-IN')}</p>
                <p class="text-2xl font-bold mt-2">Annual ROI: <span class="${roi >= 0 ? 'text-green-600' : 'text-red-600'}">${roi.toFixed(2)}%</span></p>
            `;
            resultDiv.classList.remove('hidden');
        };

        const locateChargerOnMap = (lat, lng) => {
            showVendorTab('my-vmap');
            if (vendorMap) {
                vendorMap.setCenter({ lat, lng });
                vendorMap.setZoom(15);
            }
        };

        const openEditModal = (id, name, rate, status) => {
            document.getElementById('edit-charger-id').value = id;
            document.getElementById('edit-charger-name').value = name;
            document.getElementById('edit-charger-rate').value = rate;
            document.getElementById('edit-charger-status').value = status;
            document.getElementById('edit-charger-modal').classList.remove('hidden');
        };

        const closeEditModal = () => {
            document.getElementById('edit-charger-modal').classList.add('hidden');
        };

        const updateCharger = async () => {
            const id = document.getElementById('edit-charger-id').value;
            const name = document.getElementById('edit-charger-name').value;
            const rate = parseFloat(document.getElementById('edit-charger-rate').value);
            const status = document.getElementById('edit-charger-status').value;
            if (!id || !name || isNaN(rate)) {
                showMessage("Invalid data.", 3000, 'error');
                return;
            }
            try {
                await updateDoc(doc(db, "chargers", id), { name, rate, status });
                showMessage("Charger updated successfully!", 3000, 'success');
                closeEditModal();
            } catch (error) {
                showMessage(`Error updating charger: ${error.message}`, 4000, 'error');
            }
        };

        const setCustomPin = async () => {
            const newPin = document.getElementById('new-pin').value;
            const confirmPin = document.getElementById('confirm-pin').value;
            const ocmApiKey = document.getElementById('ocm-api-key').value;

            if (newPin !== confirmPin) {
                showMessage("PINs do not match.", 3000, 'error');
                return;
            }
            if (newPin.length < 6) {
                showMessage("PIN must be at least 6 characters long.", 3000, 'error');
                return;
            }

            const user = auth.currentUser;
            if (!user) {
                showMessage("User not authenticated.", 3000, 'error');
                return;
            }

            try {
                await updatePassword(user, newPin);
                
                const vendorQuery = query(collection(db, "vendors"), where("uid", "==", user.uid));
                const vendorSnapshot = await getDocs(vendorQuery);
                if (!vendorSnapshot.empty) {
                    const vendorDocRef = vendorSnapshot.docs[0].ref;
                    await updateDoc(vendorDocRef, { hasSetPin: true, ocmApiKey: ocmApiKey });
                }
                
                showMessage("PIN set successfully! You can now use this for all future logins.", 4000, 'success');
                document.getElementById('set-pin-form').style.display = 'none';
                document.getElementById('change-pin-form').style.display = 'block';
            } catch (error) {
                showMessage(`Failed to set PIN: ${error.message}. You may need to log out and log back in with your temporary key.`, 6000, 'error');
            }
        };

        const changeCustomPin = async () => {
            const currentPin = document.getElementById('current-pin').value;
            const newPin = document.getElementById('change-new-pin').value;
            const confirmPin = document.getElementById('change-confirm-pin').value;

            if (newPin !== confirmPin) {
                showMessage("New PINs do not match.", 3000, 'error');
                return;
            }
            if (newPin.length < 6) {
                showMessage("New PIN must be at least 6 characters long.", 3000, 'error');
                return;
            }

            const user = auth.currentUser;
            if (!user) {
                showMessage("User not authenticated.", 3000, 'error');
                return;
            }

            try {
                const credential = EmailAuthProvider.credential(user.email, currentPin);
                await reauthenticateWithCredential(user, credential);
                
                await updatePassword(user, newPin);
                
                showMessage("PIN changed successfully!", 3000, 'success');
                document.getElementById('change-pin-form').reset();
            } catch (error) {
                showMessage(`Failed to change PIN: ${error.message}. Please ensure your current PIN is correct.`, 6000, 'error');
            }
        };

        const initializeMapsAfterLogin = () => {
            if (googleMapsLoaded) return;
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyCLrNaIQ1Eu-XpKws7J4MFbdxw01p0bEnc&libraries=places,geometry,drawing&callback=googleMapsApiLoaded`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        };
        
        const speak = (text) => {
            if (isMuted || !('speechSynthesis' in window)) return;
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            speechSynthesis.speak(utterance);
        };

        const toggleMute = () => {
            isMuted = !isMuted;
            if (isMuted) {
                speechSynthesis.cancel();
            }
            updateMuteButtonUI();
        };

        const updateMuteButtonUI = () => {
            const muteBtn = document.getElementById('mute-btn');
            if (!muteBtn) return;
            if (isMuted) {
                muteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" /><path stroke-linecap="round" stroke-linejoin="round" d="M17 14l2-2m0 0l2-2m-2 2l-2 2m2-2l2 2" /></svg>`;
            } else {
                muteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>`;
            }
        };

        window.googleMapsApiLoaded = () => {
            googleMapsLoaded = true;
            console.log("Google Maps API loaded.");
            initUserMap();
            initChargersNearMeMap();
        };

        // === DEBUGGING FUNCTIONS ===
        
        // Debug function to check application state
        const debugAppState = () => {
            console.log('=== APPLICATION DEBUG STATE ===');
            console.log('Current User:', auth?.currentUser);
            console.log('Firebase DB:', db ? 'Connected' : 'Not Connected');
            console.log('Is Online:', isOnline);
            console.log('Current Theme:', document.body.getAttribute('data-theme'));
            console.log('User Vehicles:', userVehicles);
            console.log('Current Route:', currentRoute);
            console.log('Main Map:', mainMap ? 'Initialized' : 'Not Initialized');
            console.log('Near Me Map:', nearMeMap ? 'Initialized' : 'Not Initialized');
            console.log('Vendor Map:', vendorMap ? 'Initialized' : 'Not Initialized');
            console.log('Directions Service:', directionsService ? 'Available' : 'Not Available');
            console.log('Geocoder:', geocoder ? 'Available' : 'Not Available');
            console.log('Places Service:', placesService ? 'Available' : 'Not Available');
            console.log('================================');
        };

        // Debug function to test network connectivity
        const debugNetwork = async () => {
            console.log('=== NETWORK DEBUG ===');
            console.log('Navigator Online:', navigator.onLine);
            console.log('App Online Status:', isOnline);
            
            try {
                const response = await fetch('https://www.google.com/favicon.ico', { 
                    method: 'HEAD', 
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                console.log('Google Connectivity: OK');
            } catch (error) {
                console.log('Google Connectivity: FAILED', error);
            }
            
            try {
                const response = await fetch('https://api.openchargemap.io/v3/poi/?output=json&maxresults=1');
                console.log('OpenChargeMap API: OK');
            } catch (error) {
                console.log('OpenChargeMap API: FAILED', error);
            }
            console.log('====================');
        };

        // Debug function to test Firebase connection
        const debugFirebase = async () => {
            console.log('=== FIREBASE DEBUG ===');
            console.log('Firebase App:', app ? 'Initialized' : 'Not Initialized');
            console.log('Auth:', auth ? 'Available' : 'Not Available');
            console.log('Database:', db ? 'Available' : 'Not Available');
            
            if (db && auth?.currentUser) {
                try {
                    const testQuery = query(collection(db, 'chargers'), limit(1));
                    const snapshot = await getDocs(testQuery);
                    console.log('Firebase Read Test: SUCCESS');
                    console.log('Sample charger count:', snapshot.size);
                } catch (error) {
                    console.log('Firebase Read Test: FAILED', error);
                }
            } else {
                console.log('Firebase Read Test: SKIPPED (No DB or User)');
            }
            console.log('=====================');
        };

        // Debug function to test Google Maps
        const debugGoogleMaps = () => {
            console.log('=== GOOGLE MAPS DEBUG ===');
            console.log('Google Maps API:', typeof google !== 'undefined' ? 'Loaded' : 'Not Loaded');
            console.log('Maps Object:', google?.maps ? 'Available' : 'Not Available');
            console.log('Directions Service:', directionsService ? 'Initialized' : 'Not Initialized');
            console.log('Geocoder:', geocoder ? 'Initialized' : 'Not Initialized');
            console.log('Places Service:', placesService ? 'Initialized' : 'Not Initialized');
            console.log('Main Map:', mainMap ? 'Initialized' : 'Not Initialized');
            console.log('Near Me Map:', nearMeMap ? 'Initialized' : 'Not Initialized');
            console.log('Vendor Map:', vendorMap ? 'Initialized' : 'Not Initialized');
            console.log('========================');
        };

        // Debug function to test route planning
        const debugRoutePlanning = () => {
            console.log('=== ROUTE PLANNING DEBUG ===');
            console.log('Current Route Object:', currentRoute);
            console.log('Selected Vehicle:', currentRoute?.vehicle);
            console.log('Current Charge:', currentRoute?.currentCharge);
            console.log('Planned Waypoints:', currentRoute?.plannedWaypoints);
            console.log('Navigation Directions:', currentRoute?.navigationDirections);
            console.log('Is Planning:', currentRoute?.isPlanning);
            console.log('Selected Route Index:', currentRoute?.selectedRouteIndex);
            console.log('============================');
        };

        // Debug function to clear all data and reset
        const debugReset = () => {
            console.log('=== RESETTING APPLICATION ===');
            currentRoute = {
                isPlanning: false,
                selectedRouteIndex: null,
                plannedWaypoints: [],
                navigationDirections: null,
                currentCharge: 100,
                vehicle: null
            };
            userVehicles = [];
            console.log('Application state reset');
            console.log('============================');
        };

        Object.assign(window, {
            showMessage, hideMessage, showSection, toggleHamburgerMenu,
            showLogin, showSignUp, backToPortalChoice,
            signUp, login, googleLogin,
            logout: async () => { await signOut(auth); showMessage("Logged out successfully.", 3000, 'info'); },
            findAlternativeRoutes, 
            submitVehicle, deleteVehicle, addCharger, listHomeCharger, deleteCharger,
            submitVendorApplication, locateMe, showVendorTab, calculateROI, locateChargerOnMap,
            openEditModal, closeEditModal, updateCharger, setCustomPin, changeCustomPin,
            initUserMap, initChargersNearMeMap, initVendorMap, updateMapMarkers,
            startInAppNavigation, stopInAppNavigation,
            selectNearbyPlace,
            nextStep, previousStep, startNextLeg, navigateToCharger,
            selectRouteForPlanning, startStopPlanning,
            addWaypoint, removeWaypoint,
            toggleMute,
            checkNetworkStatus, showNetworkError, hideNetworkError, updateConnectionStatus,
            suggestAlternativeRoute, findChargersNearLocation,
            debugAppState, debugNetwork, debugFirebase, debugGoogleMaps, debugRoutePlanning, debugReset
        });

        // OOP Classes for modular code organization
        
        // Theme Manager Class
        class ThemeManager {
            constructor() {
                this.currentTheme = 'light';
                this.themes = {
                    light: { primary: '#6366f1', secondary: '#ec4899', accent: '#10b981' },
                    dark: { primary: '#818cf8', secondary: '#f472b6', accent: '#34d399' },
                    cyberpunk: { primary: '#ff0080', secondary: '#00ffff', accent: '#ff6b35' },
                    ocean: { primary: '#0891b2', secondary: '#67e8f9', accent: '#06b6d4' }
                };
            }
            
            setTheme(themeName) {
                this.currentTheme = themeName;
                document.body.setAttribute('data-theme', themeName);
                localStorage.setItem('cf-theme', themeName);
                this.updateButtonThemes();
            }
            
            updateButtonThemes() {
                // Update primary buttons (My Vehicles)
                const primaryButtons = document.querySelectorAll('.btn-primary');
                primaryButtons.forEach(btn => {
                    btn.style.background = `var(--primary)`;
                    btn.style.color = 'white';
                });
                
                // Update secondary buttons (AI Route Planner)
                const secondaryButtons = document.querySelectorAll('.btn-secondary');
                secondaryButtons.forEach(btn => {
                    btn.style.background = `var(--secondary)`;
                    btn.style.color = 'white';
                });
                
                // Update history buttons (Trip History)
                const historyButtons = document.querySelectorAll('.btn-history');
                historyButtons.forEach(btn => {
                    btn.style.background = `var(--accent)`;
                    btn.style.color = 'white';
                });
                
                // Update partner buttons (Become a Partner)
                const partnerButtons = document.querySelectorAll('.btn-partner');
                partnerButtons.forEach(btn => {
                    btn.style.background = `linear-gradient(135deg, var(--primary), var(--secondary))`;
                    btn.style.color = 'white';
                });
            }
            
            getCurrentTheme() {
                return this.currentTheme;
            }
        }
        
        // UI Manager Class
        class UIManager {
            constructor() {
                this.activeSection = 'home';
                this.themeManager = new ThemeManager();
            }
            
            showSection(sectionId) {
                // Hide all sections
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // Show target section
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.add('active');
                    this.activeSection = sectionId;
                }
            }
            
            toggleHamburgerMenu() {
                const menu = document.getElementById('hamburger-menu');
                const btn = document.getElementById('hamburger-btn');
                if (menu && btn) {
                    menu.classList.toggle('hidden');
                    btn.style.transform = menu.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(90deg)';
                    btn.style.transition = 'transform 0.3s ease';
                }
            }
            
            updateConnectionStatus(isOnline) {
                const indicator = document.getElementById('connection-indicator');
                const text = document.getElementById('connection-text');
                
                if (indicator && text) {
                    if (isOnline) {
                        indicator.className = 'w-2 h-2 rounded-full bg-green-500';
                        text.textContent = 'Online';
                    } else {
                        indicator.className = 'w-2 h-2 rounded-full bg-red-500';
                        text.textContent = 'Offline';
                    }
                }
            }
        }
        
        // Background Animation Manager Class
        class BackgroundAnimationManager {
            constructor() {
                this.particles = [];
                this.orbs = [];
                this.waves = [];
            }
            
            createParticles() {
                const particleContainer = document.querySelector('.animated-bg');
                if (!particleContainer) return;
                
                for (let i = 0; i < 15; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 20 + 's';
                    particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                    particleContainer.appendChild(particle);
                    this.particles.push(particle);
                }
            }
            
            createBackgroundOrbs() {
                const particleContainer = document.querySelector('.animated-bg');
                if (!particleContainer) return;
                
                for (let i = 0; i < 4; i++) {
                    const orb = document.createElement('div');
                    orb.className = 'bg-orb';
                    particleContainer.appendChild(orb);
                    this.orbs.push(orb);
                }
            }
            
            createWaveElements() {
                const particleContainer = document.querySelector('.animated-bg');
                if (!particleContainer) return;
                
                for (let i = 0; i < 3; i++) {
                    const wave = document.createElement('div');
                    wave.className = 'wave-element';
                    wave.style.cssText = `
                        position: absolute;
                        width: ${200 + i * 100}px;
                        height: ${200 + i * 100}px;
                        border-radius: 50%;
                        background: radial-gradient(circle, rgba(255, 255, 255, 0.1), transparent);
                        animation: wavePulse ${8 + i * 2}s ease-in-out infinite;
                        animation-delay: ${i * 2}s;
                        top: ${20 + i * 25}%;
                        left: ${10 + i * 30}%;
                        pointer-events: none;
                        z-index: -1;
                    `;
                    particleContainer.appendChild(wave);
                    this.waves.push(wave);
                }
            }
            
            initialize() {
                this.createParticles();
                this.createBackgroundOrbs();
                this.createWaveElements();
            }
        }
        
        // Vehicle Manager Class
        class VehicleManager {
            constructor() {
                this.vehicles = [];
                this.loadVehicles();
            }
            
            loadVehicles() {
                const saved = localStorage.getItem('cf-vehicles');
                if (saved) {
                    this.vehicles = JSON.parse(saved);
                }
            }
            
            saveVehicles() {
                localStorage.setItem('cf-vehicles', JSON.stringify(this.vehicles));
            }
            
            addVehicle(vehicleData) {
                const vehicle = {
                    id: Date.now().toString(),
                    ...vehicleData,
                    addedAt: new Date().toISOString()
                };
                this.vehicles.push(vehicle);
                this.saveVehicles();
                this.updateVehicleButton();
                return vehicle;
            }
            
            removeVehicle(vehicleId) {
                this.vehicles = this.vehicles.filter(v => v.id !== vehicleId);
                this.saveVehicles();
                this.updateVehicleButton();
            }
            
            updateVehicleButton() {
                const btn = document.getElementById('vehicle-action-btn');
                if (btn) {
                    btn.textContent = this.vehicles.length > 0 ? 'Manage Vehicles' : 'Add Vehicle';
                }
            }
            
            getVehicles() {
                return this.vehicles;
            }
        }
        
        // Initialize global instances
        const uiManager = new UIManager();
        const backgroundManager = new BackgroundAnimationManager();
        const vehicleManager = new VehicleManager();
        
        // Legacy functions for backward compatibility
        function createParticles() {
            backgroundManager.createParticles();
        }
        
        function createBackgroundOrbs() {
            backgroundManager.createBackgroundOrbs();
        }
        
        function createWaveElements() {
            backgroundManager.createWaveElements();
        }
        
        // Add wave pulse animation
        const waveStyle = document.createElement('style');
        waveStyle.textContent = `
            @keyframes wavePulse {
                0%, 100% {
                    transform: scale(1) rotate(0deg);
                    opacity: 0.2;
                }
                50% {
                    transform: scale(1.2) rotate(180deg);
                    opacity: 0.4;
                }
            }
        `;
        document.head.appendChild(waveStyle);

        document.addEventListener('DOMContentLoaded', () => {
            updateConnectionStatus(navigator.onLine);
            checkNetworkStatus();
            // Handle initial hash if present
            handleInitialHash();
            // Initialize background animations using OOP
            backgroundManager.initialize();
            // Initialize theme manager
            const savedTheme = localStorage.getItem('cf-theme') || 'light';
            uiManager.themeManager.setTheme(savedTheme);
        });

        onAuthStateChanged(auth, async (user) => {
            const authSection = document.getElementById('auth-section');
            const appContent = document.getElementById('app-content');
            if (user) {
                authSection.style.display = 'none';
                appContent.style.display = 'flex';
                document.getElementById('user-info').textContent = user.displayName || user.email;
                initializeMapsAfterLogin();
                
                let isVendor = false;
                const vendorQuery = query(collection(db, "vendors"), where("uid", "==", user.uid));
                const vendorSnapshot = await getDocs(vendorQuery);
                if (!vendorSnapshot.empty) {
                    isVendor = true;
                    const vendorData = vendorSnapshot.docs[0].data();
                    if (vendorData.ocmApiKey) {
                        openChargeMapApiKey = vendorData.ocmApiKey;
                    }
                }
                
                console.log(`User ${user.uid} logged in. Is vendor: ${isVendor}`);

                document.querySelectorAll('.user-only-nav').forEach(el => el.style.display = isVendor ? 'none' : 'block');
                document.querySelectorAll('.vendor-only-nav').forEach(el => el.style.display = isVendor ? 'block' : 'none');
                
                if (isVendor) {
                    showSection('dashboard');
                    setupVendorDashboard(user.uid);
                } else {
                    showSection('home');
                    loadUserVehicles(user.uid);
                    loadTripHistory(user.uid);
                    checkVendorApplicationStatus(user.uid);
                }
            } else {
                authSection.style.display = 'flex';
                appContent.style.display = 'none';
                renderAuthForms();
            }
        });
    </script>
</body>
</html>
